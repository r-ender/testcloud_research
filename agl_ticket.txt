7.12. 
download und extract von Kernel and ready qemu-image in ~/agl/build
navigate ~/agl/build
ausführen des befehls:

//apt-get install qemu-system-x86_64

(sleep 5 && vinagre --vnc-scale localhost ) > /tmp/vinagre.log 2>&1 & qemu-system-x86_64 -device virtio-net-pci,netdev=net0,mac=52:54:00:12:35:02 -netdev user,id=net0,hostfwd=tcp::2222-:22 -drive file=agl-demo-platform-crosssdk-qemux86-64.ext4,if=virtio,format=raw -show-cursor -usb -device usb-tablet -device virtio-rng-pci -snapshot -vga virtio -vnc :0 -soundhw hda -machine q35 -cpu kvm64 -cpu qemu64,+ssse3,+sse4.1,+sse4.2,+popcnt -enable-kvm -m 2048 -serial mon:vc -serial mon:stdio -serial null -kernel bzImage -append 'root=/dev/vda rw console=tty0 mem=2048M ip=dhcp oprofile.timer=1 console=ttyS0,115200n8 verbose fstab=no'

dann startet EMU und ich kann mich einloggen über "root"

sdk-folder erstellt und sdk-skript dort gespeichert
sudo chmod 777 poky-agl-glibc-x86_64-agl-demo-platform-crosssdk-corei7-64-qemux86-64-toolchain-10.90.0+snapshot.sh
$ mkdir agl-sdk
$ ./poky-agl-glibc-x86_64-agl-demo-platform-crosssdk-corei7-64-qemux86-64-toolchain-10.90.0+snapshot.sh
./poky-agl-glibc-x86_64-agl-demo-platform-crosssdk-corei7-64-qemux86-64-toolchain-10.90.0+snapshot.sh: 29: gcc: not found
Automotive Grade Linux SDK installer version 10.90.0+snapshot
=============================================================
Enter target directory for SDK (default: /opt/agl-sdk/10.90.0+snapshot-corei7-64): /home/cloud/agl/sdk
You are about to install the SDK to "/home/cloud/agl/sdk". Proceed [Y/n]? Y
Extracting SDK..........................................................................................................................................done
Setting it up...done
SDK has been successfully set up and is ready to be used.
Each time you wish to use the SDK in a new shell session, you need to source the environment setup script e.g.
 $ . /home/cloud/agl/sdk/environment-setup-corei7-64-agl-linux
 source /home/cloud/agl/sdk/environment-setup-corei7-64-agl-linux
 
 17.12.:
 https://docs.automotivelinux.org/en/master/#0_Getting_Started/1_Quickstart/Using_Ready_Made_Images/
 
 Creating new application:
 https://docs.automotivelinux.org/en/master/#3_Developer_Guides/3_Creating_a_New_Application/
 
 example:
 https://github.com/iotbzh/helloworld-native-application
 
 clone git into agl/apps with: git clone --recursive https://github.com/iotbzh/helloworld-native-application.git
 
 bei autobuild/agl/autobuild tauchte Fehler auf:
 /usr/bin/make: bad interpreter: No such file or directory
 
 Vorlagen aus hello-world app kopieren und in eigenen SDK folder ablegen, danach builden und abändern
 z.B.:	cp ../../../apps/helloworld-native-application/conf.d/wgt/config.xml.in .
 
https://docs.automotivelinux.org/en/master/#3_Developer_Guides/3_Creating_a_New_Application/

ich komme bis "cmake .." aber habe noch kein passendes CMakeLists.txt file parat, mal schaun ob ich da eins adaptieren kann

links:
https://iot.bzh/download/public/2016/sdk/

https://agl-docs.readthedocs.io/en/master-ivory/0_Getting_Started/1_Welcome/Overview/


for yocto related stuff concerning sdk/Eclipse etc.: https://www.yoctoproject.org/docs/2.4.4/sdk-manual/sdk-manual.html


Zum Verständnis:
Ein Service ist ein background-process der Bindings über zB D-Bus oder REST-API http zur Verfügung stellt, die "Native application" ist eine compiled application in C/C++, HTML,Qt die einen 
oder mehrere Services aufruft
Am häufigsten wird hybrid application verwendet, Mischung aus Frontend+Backend

Für den Test des iotbzh-pdf: written in C and uses the “libafbwsc” helper library availablein the app-framework-binder source tree on AGL Gerrit

Es bestehen Fragezeichen, welche Board-IP ich als Qemu verwenden solle und wie ich SSH da reinbekomme.

zum Einloggen/kopieren usw. nach QEMU nach folgendem Schema: ssh root@localhost -p2222 cat /etc/os-release

oder:
export BOARDIP='localhost -p2222'
ssh root@$BOARDIP cat /etc/os-release

installieren von cmake und make

~/agl/iot_test/app-framework-templates/templates/service/build$ make


ich versuche über Anpassung von xxx-service-binding den Fehler zu eruieren

nur in afb-binding version 1 und 2: #define afb_event_drop			afb_event_x1_unref !!!

in pred-defr unter version2 eingefügt: #define afb_binding_interface		afb_binding_interface_v1


--> alles manuell umzustellen von v1 ist aufwendig, evtl besser Weg standard auf Version 3 und Rest dann ausbessern ?!

--> bei native application geht Beispiel problemlos

scp -P 2222 xxxxxx-native.wgt root@localhost:/home

in qemu:
qemux86-64:/home# afm-util install xxxxxx-native.wgt 
qemux86-64:/home# afm-util list

agl-service-bluetooth.wgt unter user/agl/apps

ein paar Sache vom Manual stimmen nicht überein, evtl ältere version verwenden wie angezeigt im Manual?: 
VERSION="1.0+snapshot-20160717 (master)"VERSION_ID="1.0+snapshot-20160717"PRETTY_NAME="Automotive Grade Linux 1.0+snapshot-20160717 (master)"

aktuell verwendet:VERSION="10.90.0+snapshot-20201204 (koi)"
VERSION_ID=10.90.0-snapshot-20201204
PRETTY_NAME="Automotive Grade Linux 10.90.0+snapshot-20201204 (koi)"
---> aber das ist nur die Plattform, hat evtl nichts mit dem Service-Beispiel zu tun ?


<  WICHTIG: sourcen von environment-script sonst kommt folgender Fehler 

die packages json-c und afb-daemon müssen noch installiert werden für build von hybrid-qml
---> sudo apt-get install libjson-c-dev
---> "sudo apt-get install agl-app-framework-binder-dev" klappt nicht
>

Zum Thema Binder:
http://old-docs.automotivelinux.org/docs/en/guppy/apis_services/reference/af-binder/afb-binding-writing.html

auch das vorgefertigte hybrid-qml gibt Fehler aus bei make --> am besten einen eigenen binder programmieren nach dem Vorbild von obigem link
writing a binding = adding an API
The binder makes no distinctions between upper case and lower case latin letters, so API/VERB matches Api/Verb or api/verb

$ pkg-config --cflags-only-I afb-daemon -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/json-c

zum Compilen: gcc -fPIC -shared binding-tut1.c -o binding-tut1.so $(pkg-config --cflags-only-I afb-daemon) -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/

Fehler beim ausführen von afb-dameon binding-tut1.so in QEMU,
Lösungsvorschlag: 
Hello,

quick reply before going away: try to package the mqtt shared object
library in the lib/ subdirectory of the widget together with your
binding.

Good Week-end
Best regards
José

example for tictasctoe afb_binding: https://github.com/iotbzh/webdocs-sample/blob/master/site/docs/architecture/en/dev/reference/ap/binder/afb-bindings-writing.md
----> ~/agl/binder_selftest/app-framework-binder/

Schritte zur installation von afb-daemon, genau befolgen:
download tarball zu libmicrohttpd und befolge die Anweisungen in INSTALL-Dokument innerhalb einer frischen ungesourcten Konsole
src/include/microhttpd.h 
libmicrohttpd isntalliert mit ./configure - make - sudo make install

wechseln in ordner "app-framework-binder", das git-repo ist downloadbar unter https://git.automotivelinux.org/src/app-framework-binder
Hier das README-File befolgen

	$ git clone https://git.automotivelinux.org/src/app-framework-binder
	$ cd app-framework-binder
	$ mkdir build
	$ cd build
	$ cmake -DCMAKE_INSTALL_PREFIX=$HOME/local ..
	$ make install

test unter ./src/afb-daemon
(executable kann man dann in /usr/sbin kopieren: sudo cp afb-daemon /usr/sbin)

output, teilweise Tutorials: -- Installing: /home/cloud/local/share/af-binder/bindings/samples/tic-tac-toe.so

zum Test:
AFB_DAEMON_DIR="/home/cloud/agl/binder_selftest/app-framework-binder"
./afb-daemon --port=1234 --token='' --ldpaths=${AFB_DAEMON_DIR}/build --workdir=/tmp --rootdir=${AFB_DAEMON_DIR}/test

or from other folder: ./build/src/afb-daemon --port=1234 --token='' --ldpaths=${AFB_DAEMON_DIR}/build --workdir=/tmp --rootdir=${AFB_DAEMON_DIR}/test
the slash "/" must not be forgotten!

to execute binding-tut1:	afb-daemon --binding binding-tut1.so --port 3333 --token '' 

< list all environment variables: printenv >


~/agl/binder_selftest/app-framework-binder$ ./build/src/afb-daemon --binding ./binding-tut1.so --port 1234 --token ''
ERROR: binding [binding-tut1.so] not loadable: binding-tut1.so: cannot open shared object file: No such file or directory [/home/cloud/agl/binder_selftest/app-framework-binder/src/afb-api-so.c:97,load_binding]
ERROR: can't start the binding binding-tut1.so [/home/cloud/agl/binder_selftest/app-framework-binder/src/main-afb-daemon.c:178,apiset_start_list] 

jetzt klappts: ~/agl/binder_selftest/app-framework-binder$ ./build/src/afb-daemon --verbose --binding ./binding-tut1.so --port 2223 --token ''
NOTICE: API monitor starting...
NOTICE: API tuto-1 starting...
NOTICE: Serving rootdir=. uploaddir=.
NOTICE: Listening interface *:2223
NOTICE: Browser URL= http://localhost:2223




4.1.21
Binding tutorials: https://github.com/growupboron/AGL-GSoD-2020-Demo-MkDocs/blob/master/docs/guppy/apis_services/reference/af-binder/afb-binding-writing.md

after working through tutorials, create tic-tac-toe.c example: https://github.com/iotbzh/webdocs-sample/blob/master/site/docs/architecture/en/dev/reference/ap/binder/afb-bindings-writing.md

now: program tutorial2 and debug a bit with it to get a feeling.
Test of binding-tut2.c:
Terminal 1:
./build/src/afb-daemon --verbose --binding ./binding-tut2.so --port 4444 --token ''
NOTICE: [API binding-tut2] preinit
NOTICE: API binding-tut2 starting...
NOTICE: [API binding-tut2] init
NOTICE: API monitor starting...
NOTICE: Serving rootdir=. uploaddir=.
NOTICE: Listening interface *:4444
NOTICE: Browser URL= http://localhost:4444
ERROR: [REQ/API binding-tut2] login, bad request: (null) [binding-tut2.c:17,login]
ERROR: [REQ/API binding-tut2] login, bad request: { "help": true } [binding-tut2.c:17,login]
NOTICE: [REQ/API binding-tut2] login user: jose
NOTICE: Granting permission urn:AGL:token:valid by default of backend
NOTICE: [REQ/API binding-tut2] login user: orlando_cool
NOTICE: Granting permission urn:AGL:token:valid by default of backend
ERROR: [REQ/API binding-tut2] login, bad state, logout first [binding-tut2.c:20,login]
NOTICE: Granting permission urn:AGL:token:valid by default of backend
NOTICE: [REQ/API binding-tut2] action for user jose: { "subscribe": true }
NOTICE: [REQ/API binding-tut2] user jose subscribes to events
NOTICE: [REQ/API binding-tut2] action for user orlando_cool: { "subscribe": false }
NOTICE: [REQ/API binding-tut2] user orlando_cool unsubscribes to events



Terminal2:
./afb-client-demo -H localhost:4444/api?token=toto
binding-tut2 login
ON-REPLY 1:binding-tut2/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"bad-request"
  }
}
{"help":true}    
verb missing, bad line: ogin
binding-tut2 login {"help":true}
ON-REPLY 2:binding-tut2/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"bad-request"
  }
}
tuto-2 login {"user":"jose","password":"please"}
ON-REPLY 3:tuto-2/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"unknown-api",
    "info":"api tuto-2 not found (for verb login)"
  }
}
binding-tut2 login {"user":"jose", "password":"please"}
ON-REPLY 4:binding-tut2/login: OK
{
  "jtype":"afb-reply",
  "request":{
    "status":"success"
  }
}

binding-tut2 login {"user":"orlando2", "password":"please"}
ON-REPLY 5:binding-tut2/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"bad-state"
  }
}
binding-tut2 action {"subscribe":true}
ON-REPLY 6:binding-tut2/action: OK
{
  "response":{
    "subscribe":true
  },
  "jtype":"afb-reply",
  "request":{
    "status":"success"
  }
}

binding-tut2 action {"subscribe":false}
ON-REPLY 6:binding-tut2/action: OK
{
  "response":{
    "subscribe":false
  },
  "jtype":"afb-reply",
  "request":{
    "status":"success"
  }
}



Terminal 3:
./afb-client-demo -H localhost:4444/api?token=
inding-tut2 login {"user":"jose", "password":"please"}
ON-REPLY 1:inding-tut2/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"unknown-api",
    "info":"api inding-tut2 not found (for verb login)"
  }
}
binding-tut2 login {"user":"orlando_cool", "password":"please"}
ON-REPLY 2:binding-tut2/login: OK
{
  "jtype":"afb-reply",
  "request":{
    "status":"success"
  }
}


für erstes Tutorial: /afb-client-demo -H localhost:4444/api?token=
binding-tut1 login {"user":"orlando","password":"please"}
ON-REPLY 2:binding-tut1/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"unknown-api",
    "info":"api binding-tut1 not found (for verb login)"
  }
}
tuto-1 login
ON-REPLY 3:tuto-1/login: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"unknown-verb",
    "info":"verb login unknown within api tuto-1"
  }
}
tuto-1 hello
ON-REPLY 4:tuto-1/hello: OK
{
  "jtype":"afb-reply",
  "request":{
    "status":"success",
    "info":"hello world"
  }
}


Fazit -----------------------------------> die Bindings erreicht man über die im source-file gesetzten Namen für API und die Verbs, die wiederum callbacks aufrufen, 
						was letztlich die eigentlichen Funktionen sind 
						
						
						
						
Binding!
A binding is an independent piece of software. A binding is self contain and exposes application logic as sharable library (---> *.so)  A binding is intended to be dynamically loaded by afb-daemon
to expose application API ( --binding ./xyz.so) . Technically, a binder binding does not reference and is not linked with any afb-daemon library.

Application binder supports two kinds of bindings: application bindings and service bindings. Technically both class of bindings are equivalent and use the same coding convention. Only sharing mode
and security context diverge.

Application-bindings implement the glue between application's UI and services. Every AGL application has a corresponding binder that typically activates one or many bindings to interface the
application logic with lower platform services. When an application is started by the AGL application framework, a dedicated binder is started that loads/activates application binding(s).

Service-bindings enable API activation within corresponding service security context and not within calling application context. Service-bindings are intended to run as a unique instance. Service
bindings can be shared between multiple clients. Sharing may either be global to the platform (ie: GPS service) or dedicated to a given user (ie: user preferences)


Application and service bindings are loaded and activated each time a new afb-daemon is started. At launch time, every loaded binding initialises itself. If a single binding initialisation fail
corresponding instance of afb-daemon self aborts. Conversely, when a binding initialisation succeeds, it should register its unique name as well as the list of verbs attached to the methods it
exposes.

Afb-daemon parses URI requests to extract the API(binding name) and the VERB(method to activate). As an example, URI foo/bar translates to binding named foo and method named bar. Afb-daemon ignores
letter case when parsing URI. Thus TicTacToe/Board and tictactoe/board are equivalent.

tic-tac-toe unter ~/agl/binder_selftest/app-framework-binder/bindings/samples aber ich versuche es nach dem Tutorial zu entwickeln: https://github.com/iotbzh/webdocs-sample/blob/master/site/docs/architecture/en/dev/reference/ap/binder/afb-bindings-writing.md


8.1.
erstes auf qemu kopiertes widget bzw. app installiert: 
qemux86-64:/home# afm-util install annex.wgt 
{
  "added":"webapps-annex"
}

qemux86-64:/home# afm-util info webapps-annex
{
  "description":"Reversi/Othello",
  "name":"Annex",
  "shortname":"",
  "id":"webapps-annex",
  "version":"0.0.10",
  "author":"Todd Brandt <todd.e.brandt@intel.com>",
  "author-email":"",
  "width":"",
  "height":"",
  "icon":"/var/local/lib/afm/applications/webapps-annex/icon_128.png",
  "http-port":30044
}

bei Start jeder App kommt folgender Fehler: 
qemux86-64:/home# afm-util start webapps-annex
ERROR:  cannot-start

---> befehl journalctl zeigt kompletten output/systemd/agl-services usw., am besten nach afm durchsuchen etc

output:
Jan 08 11:04:54 qemux86-64 afm-system-daemon[300]:  ERROR: can't start system unit afm-appli-dashboard--0.1--main@.service for uid 0 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]

journalctl -xu  afm-appli-dashboard--0.1--main@.service
systemctl status afm-appli-dashboard--0.1--main@.service

qemux86-64:/home# uname -a
Linux qemux86-64 5.4.57-yocto-standard #1 SMP PREEMPT Mon Jun 29 03:06:40 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux

qemux86-64:/home# cat /etc/os-release 
ID=poky-agl
NAME="Automotive Grade Linux"
VERSION="10.90.0+snapshot-20201204 (koi)"
VERSION_ID=10.90.0-snapshot-20201204
PRETTY_NAME="Automotive Grade Linux 10.90.0+snapshot-20201204 (koi)"


Maybe use flounder or the one used within guide-documents ?

from https://lists.automotivelinux.org/g/agl-dev-community/topic/57195627#7822


helloworld-native-application depends on agl-service-helloworld (API
'helloworld') but it's not installed by default in AGL images. So, you must grab
it from here: https://git.automotivelinux.org/apps/agl-service-helloworld
and install it too.

When I tried to reproduce your issue, I also found a minor bug in
helloworld-native-application (mess up with log file). Please use my latest
commit from today:
https://github.com/iotbzh/helloworld-native-application/commit/fe2c9589d6018176b08af9afadb489f86d534091

So finally, it works as expected. Here's a capture of my test session:

Build the 2 widgets from an AGL docker container where SDK is installed:
-------------------------------------------------------
# . /xdt/sdk/environment-setup-aarch64-agl-linux
# git clone https://git.automotivelinux.org/apps/agl-service-helloworld
# agl-service-helloworld/autobuild/agl/autobuild package
# scp agl-service-helloworld/build/*.wgt root@h3ulcb:/tmp/
# git clone https://github.com/iotbzh/helloworld-native-application.git
# helloworld-native-application/autobuild/agl/autobuild package
# scp helloworld-native-application/build/*.wgt root@h3ulcb:/tmp/
-------------------------------------------------------

Then install on the board:
-------------------------------------------------------
$ ssh root@h3ulcb
root@h3ulcb:~# afm-util install /tmp/agl-service-helloworld.wgt
{
  "added":"agl-service-helloworld@1.0-7a5a796"
}
root@h3ulcb:~# afm-util install /tmp/helloworld-native-application.wgt
{
  "added":"helloworld-native-application@0.1-fe2c958"
}
-------------------------------------------------------

And finally run the native app, which calls the verb 'ping' on helloworld API
every 10s and appends the json result to a log file in /tmp.
-------------------------------------------------------
root@h3ulcb:~# afm-util start helloworld-native-application@0.1-fe2c958
8323
root@h3ulcb:~# tail -f /tmp/helloworld.log
  }
}{
  "response":0,
  "jtype":"afb-reply",
  "request":{
    "status":"success",
    "info":"Ping count = 0",
    "uuid":"29c3357f-2083-49a8-9597-3136120728d3"
  }
}{
  "response":1,
  "jtype":"afb-reply",
  "request":{
    "status":"success",
    "info":"Ping count = 1"
  }
}
...


anderer Versuch mit User-Änderung:
qemux86-64:/home#  
qemux86-64:~$ afm-util start dashboard
ERROR:  cannot-start
qemux86-64:~$ whoami
agl-driver
qemux86-64:~$ afm-util ps
[
  {
    "runid":1596,
    "pids":[
      1596
    ],
    "state":"running",
    "id":"settings"
  },
...
  {
    "runid":839,
    "pids":[
      839
    ],
    "state":"running",
    "id":"homescreen"
  }
]

note for folder under /home: user 0: root and user 1001:agl-driver 

folgendes klappt:
cd /home/1001/app-data
su - agl-driver
afm-util kill homescreen
afm-util start homescreen

Veränderungen am Display sichtbar
Like Bogdan said, journalctl is the command to check if there are
any problems starting your application. Please also check config.xml to see
if indeed you have the right permissions (urn:AGL:permission::public:display). 

One thing that changed between the two release is that widgets to no
longer need that version (`@X.Y`) at the end. Das ist die Erklärung für Koi, warum dieser Zusatz nicht mehr angezeigt wird

die Apps sind schon recht alt:
eine Möglichkeit: älteres AGL verwenden, ansonsten einfach selber ein widget bauen, das betriebseigene HomeScreen klappt ja auch


11.1.
hello-world-native-application versuchen auszuführen auf target board:

hello-world-native-application geklont, fehler korrigiert (fprintf(fd,results), und autobuild pacakge ausgeführt, das.wgt-file ist erzeugt worden.
Als nächstes den Binder/services kreieren bzw. downloaden:
 
die App helloworld-native läuft nach obiger Vorgehensweise, obwohl nach kurzer Zeit fehler im ssh-Therminal angezeigt wird, im Hintergrund weiter und ping count zählt wie erwünscht alle 10s hoch
auf dem Display erscheint nichts, ist auch nicht so vorgesehen.

next: probieren ob statt "agl-service.wgt" auch einfaches binding klappt.
anhand hello-wworld-app in ps -efZ usw. nachspielen und die Infos des Manuals rauslesen


21.1.:
zum kompilieren:
source agl/sdk/env..
export LIBRARAY_PATH=/home/gast/local/lib/pkg_config:/home/gast/local/lib:$LIBRARY_PATH
ldconfig
gcc- Wall -g3 source.c -o source $(pkg-config --cflags --libs afb-daemon libafbwsc) -I/home/gast/....../corei7-64-agl-linux/usr/include

Ausführen:
export LD_LIBRARY_PATH=/home/gast/local/lib:$LD_LIBRARY_PATH

28.1.
app application-list testen
 hier fehler "unit file" ?
 
 -- Logs begin at Thu 2021-01-28 12:21:13 UTC. --
Jan 28 13:17:09 qemux86-64 systemd[1]: /lib/systemd/system/cynagora-agent.socket:3: ListenStream= references a path below legacy directory /var/run/, updating /var/run/cynagora/cynagora.agent → /run/cynagora/cynagora.agent; please update the unit file accordingly.
Jan 28 13:17:09 qemux86-64 systemd[1]: /lib/systemd/system/cynagora-admin.socket:3: ListenStream= references a path below legacy directory /var/run/, updating /var/run/cynagora/cynagora.admin → /run/cynagora/cynagora.admin; please update the unit file accordingly.
Jan 28 13:17:09 qemux86-64 systemd[1]: Stopped target Sockets.
Jan 28 13:17:09 qemux86-64 systemd[1]: Stopping Sockets.
Jan 28 13:17:09 qemux86-64 systemd[1]: Reached target Sockets.
Jan 28 13:17:25 qemux86-64 afm-system-daemon[299]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 28 13:17:31 qemux86-64 afm-system-daemon[299]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 28 13:17:40 qemux86-64 audit[1353]: AVC lsm=SMACK fn=smack_inode_permission action=denied subject="System" object="_" requested=wx pid=1353 comm="sh" name="1001" dev="vda" ino=973
Jan 28 13:17:40 qemux86-64 su[1352]: pam_unix(su:session): session closed for user agl-driver
Jan 28 13:17:40 qemux86-64 kernel: audit: type=1400 audit(1611839860.287:11): lsm=SMACK fn=smack_inode_permission action=denied subject="System" object="_" requested=wx pid=1353 comm="sh" name="1001" dev="vda" ino=973


before:
qemux86-64:/home# cat /lib/systemd/system/cynagora-agent.socket 
[Socket]
FileDescriptorName=agent
ListenStream=/var/run/cynagora/cynagora.agent
SocketUser=cynagora
SocketGroup=cynagora
SocketMode=0660
SmackLabelIPIn=@
SmackLabelIPOut=@

Service=cynagora.service

[Unit]
Wants=cynagora.target
Before=cynagora.target

[Install]
WantedBy=sockets.target

Afterwards:
qemux86-64:/home# vim /lib/systemd/system/cynagora-agent.socket 
qemux86-64:/home# cat /lib/systemd/system/cynagora-agent.socket 
[Socket]
FileDescriptorName=agent
ListenStream=/run/cynagora/cynagora.agent
SocketUser=cynagora
SocketGroup=cynagora
SocketMode=0660
SmackLabelIPIn=@
SmackLabelIPOut=@

Service=cynagora.service

[Unit]
Wants=cynagora.target
Before=cynagora.target

[Install]
WantedBy=sockets.target
same for: /lib/systemd/system/gpsd.socket , /lib/systemd/system/cynagora-check.socket, /lib/systemd/system/cynagora-admin.socket 
---> installing works now

Jan 28 15:06:51 qemux86-64 afm-system-daemon[299]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 28 15:06:57 qemux86-64 afm-system-daemon[299]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 28 15:07:00 qemux86-64 audit[1530]: AVC lsm=SMACK fn=smack_inode_permission action=denied subject="System" object="_" requested=wx pid=1530 comm="sh" name="1001" dev="vda" ino=973

andere applications wie dashboard funktionieren durchaus.
qemux86-64:~# afm-util kill dashboard
true
qemux86-64:~# afm-util start dashboard
1981
qemux86-64:~# 
emux86-64:~# journalctl -f
-- Logs begin at Thu 2021-01-28 12:21:13 UTC. --
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/signal-composer [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:299,init_alias]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/dashboard uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:401,start_http_server]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  NOTICE: Listening interface *:30031 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  NOTICE: Browser URL= http://localhost:30031 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Jan 28 16:02:50 qemux86-64 afbd-dashboard[1981]:  NOTICE: Listening interface localuser--31:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Jan 28 16:02:50 qemux86-64 systemd[1]: Started This is a demo dashboard application.
Jan 28 16:02:50 qemux86-64 afbd-launcher[847]: app_id:  dashboard
Jan 28 16:03:07 qemux86-64 connmand[311]: ntp: adjust (slew): -0.005442 sec


evtl: für application immer ein binder nötig, wegen websocket.
schauen ob noch tic-tac-toe-socket da ist und dann testen ?

für dashboard:	https://wiki.automotivelinux.org/agl-demonstrator/dashboard

build helloworld-html-application:
source sdk/environm...
sudo apt-get install npm
sudo npm install gulp -g

then continue as in readme said -------->  build klappt nicht, aber der fakt, dass App und Binding in selbem Ordner vorhanden sind, deutet darauf hin, dass app nur mit binder klappt
--> nochmal tic-tac-toe testen ?! oder helloworld wie früher ohne graphische UI


aus pdf-Presentation Building application:
- AGL-Framework, short: AF, is made of two parts: AF-Main (AFM, responsible for controlling apps) and AF-Binder (AFB, responsible as server for the backend like http,WS, etc.)
- Application consists of three parts: 1.) backend binder/service		2.) frontend application	3.) configuration file 

Vorgehen:
ich versuche lokal HelloWorld auszuführen mit html
wenn das klappt versuche ich es als .wgt zu verpacken und auf board auszuführen


helloworld-binding und -app unter:	~/agl/agl-srv-helwor

loud@Cloud-Lab:~/agl/agl-srv-helwor/agl-service-helloworld/helloworld-skeleton$ gcc -fPIC -shared helloworld-service-binding.c -o helloworld_service.so $(pkg-config --cflags-only-I afb-daemon) -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/

in terminal 1:
cloud@Cloud-Lab:~/agl/agl-srv-helwor/agl-service-helloworld/helloworld-skeleton$ ./../../../binder_selftest/app-framework-binder/build/src/afb-daemon --binding ./helloworld_service.so --port 4444 --token ''

in terminal 2:
cloud@Cloud-Lab:~/agl$ ./binder_selftest/app-framework-binder/build/src/afb-client-demo --human 'localhost:4444/api?token='
helloworld ping


test klappt, jetzt mit html-Seite versuchen 
~/agl/agl-srv-helwor/agl-service-helloworld/helloworld-skeleton$ ./../../../binder_selftest/app-framework-binder/build/src/afb-daemon --binding ./helloworld_service.so --port 4444 --token '' --roothttp=/home/cloud/agl/agl-srv-helwor/agl-service-helloworld/htdocs

im browser: http://localhost:4444/index.html

dieser test klappt, als nächstes eine App basteln

aus Forum:
In few words: put the files in a sub-directory named 'htdocs' then
create the config.xml file according to [1].
zip all that as a widget that you can install using 'afm-util install X'

[1]
http://docs.automotivelinux.org/docs/apis_services/en/dev/reference/af-main/2.2-config.xml.html

Actually the problem is that your app will not be shown because it is
not integrated with the homescreen and the window manager. To bypass
this restriction, we usually replace the app POI (point of interest).
To do so just set the id to "poi" and the version to "0.1".


----> app erscheint evtl nicht auf homescreen, weil nicht eingebettet !?

~/agl/agl-srv-helwor/selftest_app$ wgtpkg-pack -f -o self_hellow.wgt package


zum App-Build folgende Ordner-Struktur beachten:
loud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package
config.xml  htdocs  lib
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package/htdocs/
AFB-websock.js  assets  CMakeLists.txt  index.html  iotbzh-Binding.css  iotbzh-Binding.js
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package/lib/
helloworld_service.so
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ 

dann ausführen: cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ wgtpkg-pack -f -o self_hellow.wgt package

----> auf dem Homscreen erscheint die self-helloworld-app mit s als angezeigter Buchstabe !!!!!!!!!
es zeigt immer noch "cannot-start" aber das ist auch bei Dashboard und wird dennoch ausgeführt 

- Logs begin at Fri 2021-01-29 19:42:52 UTC. --
Jan 29 20:00:55 qemux86-64 afbd-launcher[847]: will activate app:  "self_hellow"
Jan 29 20:01:20 qemux86-64 su[1461]: Successful su for agl-driver by root
Jan 29 20:01:20 qemux86-64 su[1461]: + /dev/ttyS1 root:agl-driver
Jan 29 20:01:20 qemux86-64 su[1461]: pam_unix(su:session): session opened for user agl-driver by root(uid=0)
Jan 29 20:01:20 qemux86-64 dbus-daemon[256]: [system] Rejected receive message, 1 matched rules; type="signal", sender="(unset)" ((bus)) interface="org.freedesktop.DBus" member="NameLost" error name="(unset)" requested_reply="0" destination=":1.49" (uid=0 pid=1461 comm="su - agl-driver " label="System") privilege="http://tizen.org/privilege/internal/dbus"
Jan 29 20:02:05 qemux86-64 afm-system-daemon[300]:  ERROR: can't start system unit afm-appli-self_hellow--0.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 29 20:02:56 qemux86-64 afm-system-daemon[300]:  ERROR: can't start system unit afm-appli-self_hellow--0.1--main@.service for uid 1001 [/usr/src/debug/af-main/master+gitAUTOINC+af8db35cc0-r0/git/src/afm-urun.c:268]
Jan 29 20:02:59 qemux86-64 audit[1462]: AVC lsm=SMACK fn=smack_inode_permission action=denied subject="System" object="_" requested=wx pid=1462 comm="sh" name="1001" dev="vda" ino=973


next: mehr über App-Anwendung googlen/anschauen etc.


2.2.
during start-up of new bzImage/qemu:
eb 02 11:03:42 qemux86-64 afbd-homescreen[837]: ------BEGIN OF CONFIG-----
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: -- {
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "name": "afbd-homescreen",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "rootdir": "/var/local/lib/afm/applications/homescreen",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "workdir": "/home/1001/app-data/homescreen",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "monitoring": true,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "port": 30032,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "interface": [
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "tcp:localuser--32:8080"
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    ],
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "roothttp": ".",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "ws-client": [
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/homescreen",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/network-manager",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/weather",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/Bluetooth-Manager",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/audiomixer",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "unix:/run/user/1001/apis/ws/vshl-core"
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    ],
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "exec": [
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "/var/local/lib/afm/applications/homescreen/bin/HomeScreen",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "@p",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "@t"
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    ],
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "apitimeout": 20,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "cache-eol": 100000,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "cntxtimeout": 32000000,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "session-max": 200,
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "uploaddir": ".",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "rootbase": "/opa",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "rootapi": "/api",
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "ldpaths": [
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "/usr/lib/afb"
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    ],
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    "alias": [
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --      "/monitoring:/usr/lib/afb/monitoring"
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --    ]
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: --  }
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]: ------END OF CONFIG-----
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]:  INFO: running with pid 837 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Feb 02 11:03:42 qemux86-64 afbd-homescreen[837]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b624>
lines 1265-1287

aus dem ~ - Ordner heraus habe ich memory-match.wgt installiert:
qemux86-64:~# afm-util install memory-match.wgt 
{
  "added":"webapps-memory-match"
}
qemux86-64:~# journalctl -f
-- Logs begin at Tue 2021-02-02 11:03:36 UTC. --
Feb 02 11:18:45 qemux86-64 systemd[1]: /lib/systemd/system/cynagora-admin.socket:3: ListenStream= references a path below legacy directory /var/run/, updating /var/run/cynagora/cynagora.admin → /run/cynagora/cynagora.admin; please update the unit file accordingly.
Feb 02 11:18:45 qemux86-64 systemd[1]: Stopped target Sockets.
Feb 02 11:18:45 qemux86-64 systemd[1]: Stopping Sockets.
Feb 02 11:18:45 qemux86-64 systemd[1]: Reached target Sockets.
Feb 02 11:18:45 qemux86-64 afbd-agl-service-homescreen[847]:  INFO: [API homescreen] on_event afm-main/application-list-changed [/usr/src/debug/agl-service-homescreen/git-r0/git/src/homescreen.cpp:554,onevent]
Feb 02 11:18:45 qemux86-64 afbd-homescreen[844]: WebSocket Text Received:  "[5,\"afm-main/application-list-changed\",{\"event\":\"afm-main/application-list-changed\",\"data\":{\"event\":\"afm-main/application-list-changed\",\"data\":{\"operation\":\"install\",\"data\":\"webapps-memory-match\"},\"jtype\":\"afb-event\"},\"jtype\":\"afb-event\"}]"
Feb 02 11:18:45 qemux86-64 afbd-homescreen[844]: MasterVolume::onClientEventReceived[ "afm-main/application-list-changed" ]:  QJsonValue(object, QJsonObject({"data":{"data":"webapps-memory-match","operation":"install"},"event":"afm-main/application-list-changed","jtype":"afb-event"}))
Feb 02 11:18:45 qemux86-64 afbd-agl-service-homescreen[847]:  INFO: [API homescreen] synchronous call, error=(null), info=(null). [/usr/src/debug/agl-service-homescreen/git-r0/git/src/hs-proxy.cpp:104,api_call_sync]
Feb 02 11:18:45 qemux86-64 afbd-agl-service-homescreen[847]:  INFO: [API homescreen] called, event=application-list-changed. [/usr/src/debug/agl-service-homescreen/git-r0/git/src/hs-client.cpp:484,pushEvent]
Feb 02 11:18:45 qemux86-64 afbd-launcher[845]: qml: applist update in Launcher.qml

afm-util list:
{
    "description":"Memory match",
    "name":"MemoryMatch",
    "shortname":"",
    "id":"webapps-memory-match",
    "version":"1.1.7",
    "author":"Todd Brandt <todd.e.brandt@intel.com>",
    "author-email":"",
    "width":"",
    "height":"",
    "icon":"/var/local/lib/afm/applications/webapps-memory-match/icon_128.png",
    "http-port":30044
  },
  
  wenn ich starten möchte:
  Feb 02 11:22:47 qemux86-64 afm-system-daemon[300]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 0 [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/afm-urun.c:268]

qemux86-64:~# systemctl start afm-appli-webapps-memory-match--1.1--main@.service
Failed to start afm-appli-webapps-memory-match--1.1--main@.service: Unit name afm-appli-webapps-memory-match--1.1--main@.service is missing the instance name.
See system logs and 'systemctl status afm-appli-webapps-memory-match--1.1--main@.service' for details.
qemux86-64:~# systemctl status afm-appli-webapps-memory-match--1.1--main@.service
Failed to get properties: Unit name afm-appli-webapps-memory-match--1.1--main@.service is neither a valid invocation ID nor unit name.


<
from:
root@macbook:/home/julian/Desktop# systemctl start syncthing@
Failed to start syncthing@.service: Unit name syncthing@.service is missing the instance name.
-->
The instance name is a single argument that can be passed to systemd units. In this case, it’s the user to run as. You might be looking for "systemctl enable syncthing@julian and systemctl start syncthing@julian."
Added: There’s also the possibility of running it in the user manager, which is active when you’re logged in. That would mean using systemctl --user enable syncthing and systemctl --user start syncthing. (The enable in both cases is so that it gets automatically started at boot or login - but it doesn’t start it now, oddly enough.)
>

qemux86-64:~# systemctl enable afm-appli-webapps-memory-match--1.1--main@root
The unit files have no installation config (WantedBy=, RequiredBy=, Also=,
Alias= settings in the [Install] section, and DefaultInstance= for template
units). This means they are not meant to be enabled using systemctl.
 
Possible reasons for having this kind of units are:
* A unit may be statically enabled by being symlinked from another unit's
  .wants/ or .requires/ directory.
* A unit's purpose may be to act as a helper for some other unit which has
  a requirement dependency on it.
* A unit may be started when needed via activation (socket, path, timer,
  D-Bus, udev, scripted systemctl call, ...).
* In case of template units, the unit is meant to be enabled with some
  instance name specified.
qemux86-64:~# systemctl start afm-appli-webapps-memory-match--1.1--main@root
Failed to start afm-appli-webapps-memory-match--1.1--main@root.service: Unit afm-api-windowmanager@root.service not found.

nach anpassen der /var/run Files, neuinstalliert und beim start gleichen Fehler
qemux86-64:~# systemctl status afm-appli-webapps-memory-match--1.1--main@root.service
* afm-appli-webapps-memory-match--1.1--main@root.service - Memory match
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-webapps-memory-match--1.1--main@.service; static; vendor preset: disabled)
     Active: inactive (dead)


unter ls -ll /usr/local/lib/systemd/system/  fehlt der servicewie ihn alle anderen apps haben: rw-r--r--. 1 root root 2850 Feb  2 11:03 afm-service-agl-service-hvac--1.0--main@.service

hvac zeigt zwar "cannot-start" an aber display ändert sich.
qemux86-64:~# journalctl -xe
-- Subject: A start job for unit afm-service-agl-service-nfc--1.0--main@0.service has failed
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- A start job for unit afm-service-agl-service-nfc--1.0--main@0.service has finished with a failure.
-- 
-- The job identifier is 6734 and the job result is failed.
Feb 02 12:02:08 qemux86-64 systemd[1]: afm-api-nfc@0.socket: Failed with result 'service-start-limit-hit'.
-- Subject: Unit failed
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- The unit afm-api-nfc@0.socket has entered the 'failed' state with result 'service-start-limit-hit'.
Feb 02 12:02:08 qemux86-64 systemd[1]: Reached target afm-user-session 0.
-- Subject: A start job for unit afm-user-session@0.target has finished successfully
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- A start job for unit afm-user-session@0.target has finished successfully.
-- 
-- The job identifier is 3849.
Feb 02 12:02:08 qemux86-64 afbd-launcher[845]: app_id:  hvac
Feb 02 12:03:59 qemux86-64 afm-system-daemon[300]:  ERROR: can't start system unit afm-appli-webapps-memory-match--1.1--main@.service for uid 0 [/usr/src/debug/af-main/master+gitAUT>

( weitere quelle agl: https://github.com/webmaxru/agl-hvac)
drwx------. 2 agl-driver agl-driver 4096 Feb  2 11:03 agl-service-hvac liegt unter app-data und fehlt evtl für helloworld?!

qemux86-64:/home# journalctl | grep afbd-hvac
Feb 02 12:00:44 qemux86-64 afbd-hvac[1420]: /bin/mkdir: cannot create directory '/home/root': Permission denied
Feb 02 12:01:35 qemux86-64 afbd-hvac[1436]: /bin/mkdir: cannot create directory '/home/root': Permission denied
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: ------BEGIN OF CONFIG-----
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: -- {
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "name": "afbd-hvac",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "rootdir": "/var/local/lib/afm/applications/hvac",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "workdir": "/home/0/app-data/hvac",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "monitoring": true,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "port": 30033,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "interface": [
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "tcp:localuser--33:8080"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    ],
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "roothttp": ".",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "ws-client": [
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "unix:/run/user/0/apis/ws/HVAC"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    ],
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "exec": [
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "/var/local/lib/afm/applications/hvac/bin/hvac",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "@p",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "@t"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    ],
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "apitimeout": 20,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "cache-eol": 100000,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "cntxtimeout": 32000000,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "session-max": 200,
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "uploaddir": ".",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "rootbase": "/opa",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "rootapi": "/api",
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "ldpaths": [
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "/usr/lib/afb"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    ],
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    "alias": [
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --      "/monitoring:/usr/lib/afb/monitoring"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --    ]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: --  }
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]: ------END OF CONFIG-----
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: running with pid 1508 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-supervision.c:165,try_connect_supervisor]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: Scanning dir=[/usr/lib/afb] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: API HVAC added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: API HVAC starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: API HVAC started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:299,init_alias]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/hvac uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:401,start_http_server]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: Listening interface *:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: Browser URL= http://localhost:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1508]:  NOTICE: Listening interface localuser--33:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 12:02:06 qemux86-64 afbd-hvac[1514]: setting port: 30033 , token: "@t"
Feb 02 12:02:06 qemux86-64 afbd-hvac[1514]: #### "/home/0/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
Feb 02 12:02:07 qemux86-64 afbd-hvac[1514]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 02 12:02:07 qemux86-64 afbd-hvac[1514]: qml: Right Temp changed 15
Feb 02 12:02:07 qemux86-64 afbd-hvac[1514]: qml: Left Temp changed 15
Feb 02 13:28:12 qemux86-64 afbd-hvac[1849]: /bin/mkdir: cannot create directory '/home/root': Permission denied
Feb 02 13:30:04 qemux86-64 afbd-hvac[1860]: /bin/mkdir: cannot stat '/home/root/app-data/hvac': Permission denied
Feb 02 13:41:59 qemux86-64 afbd-hvac[1508]:  NOTICE: Received SIGTERM [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:203,on_sigterm]



qemux86-64:/usr/local/lib/afm/applications# ls agl-service-hvac/
bin  config.xml  etc  htdocs  icon.png	lib  var

qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-hvac" version="1.0">
	<name>agl-service-hvac</name>
	<icon src="icon.png"/>
	<content src="lib/libafm-hvac-binding.so" type="application/vnd.agl.service"/>
	<description>Binding for HVAC interface</description>
	<author> &lt;&gt;</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="required" />
		<param name="urn:AGL:permission::public:no-htdocs" value="required" />
		<param name="urn:AGL:permission::system:run-by-default" value="required" />
		<param name="urn:AGL:permission::platform:can:write" value="required" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="HVAC" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-api">
		<param name="identity" value="ws" />
		<param name="low-can" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/libafm-hvac-binding.so" value="local" />
	</feature>
</widget>


qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls
bin  config.xml  etc  htdocs  icon.png	lib  var
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls etc/
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls htdocs/
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls icon.png 
icon.png
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls lib      
libafm-hvac-binding.so
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# ls var
qemux86-64:/usr/local/lib/afm/applications/agl-service-hvac# 



qemux86-64:/usr/local/lib/afm/applications/hvac# ls
bin  config.xml  icon.svg  translations
qemux86-64:/usr/local/lib/afm/applications/hvac# ls bin
hvac
qemux86-64:/usr/local/lib/afm/applications/hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="hvac" version="0.1">
  <name>HVAC</name>
  <icon src="icon.svg"/>
  <content src="bin/hvac" type="application/vnd.agl.native"/>
  <description>This is a demo application used to control and dialog with HVAC system</description>
  <author>Romain Forlot &lt;romain.forlot@iot.bzh&gt;</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="HVAC" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>

check:	qemux86-64:/usr/local/lib/afm/applications/webapps-memory-match# cat /etc/afm/afm-unit.conf 


--->
now try again helloworld and keep focus on service <--> application, config-files etc.  (app-example with explaination:	https://github.com/abhijeetk/AFB-test )
show running binders:	ps -ef | grep afb
show bindings/shared object files:	qemux86-64:/# find . -name *.so | grep binding
show running websockets:	qemux86-64:/# ls -Z . /run/user/0/apis/ws

(starten mit hvac klappt jetzt?!)
qemux86-64:/# journalctl -f
-- Logs begin at Tue 2021-02-02 11:03:36 UTC. --
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface *:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Browser URL= http://localhost:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface localuser--33:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 systemd[1]: Started This is a demo application used to control and dialog with HVAC system.
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: setting port: 30033 , token: "@t"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: #### "/home/0/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Right Temp changed 15
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Left Temp changed 15
Feb 02 15:06:48 qemux86-64 afbd-launcher[845]: app_id:  hvac


qemux86-64:/# journalctl -xe
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,a>
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:29>
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/hvac uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-da>
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface *:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Browser URL= http://localhost:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface localuser--33:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 systemd[1]: Started This is a demo application used to control and dialog with HVAC system.
-- Subject: A start job for unit afm-appli-hvac--0.1--main@0.service has finished successfully
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- A start job for unit afm-appli-hvac--0.1--main@0.service has finished successfully.
-- 
-- The job identifier is 8051.
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: setting port: 30033 , token: "@t"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: #### "/home/0/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Right Temp changed 15
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Left Temp changed 15
Feb 02 15:06:48 qemux86-64 afbd-launcher[845]: app_id:  hvac

qemux86-64:/# systemctl status afm-appli-hvac--0.1--main@0.service
● afm-appli-hvac--0.1--main@0.service - This is a demo application used to control and dialog with HVAC system
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-hvac--0.1--main@.service; static; vendor preset: disabled)
     Active: active (running) since Tue 2021-02-02 15:06:47 UTC; 2min 55s ago
    Process: 2178 ExecStartPre=/bin/mkdir -p /home/0/app-data/hvac (code=exited, status=0/SUCCESS)
   Main PID: 2179 (afbd-hvac)
      Tasks: 4 (limit: 2385)
     Memory: 58.7M
     CGroup: /user.slice/user-0.slice/afm-appli-hvac--0.1--main@0.service
             ├─2179 afbd-hvac
             └─2180 /var/local/lib/afm/applications/hvac/bin/hvac 30033 @t

Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/hvac uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-da>
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface *:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Browser URL= http://localhost:30033 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Feb 02 15:06:47 qemux86-64 afbd-hvac[2179]:  NOTICE: Listening interface localuser--33:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 02 15:06:47 qemux86-64 systemd[1]: Started This is a demo application used to control and dialog with HVAC system.
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: setting port: 30033 , token: "@t"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: #### "/home/0/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Right Temp changed 15
Feb 02 15:06:47 qemux86-64 afbd-hvac[2180]: qml: Left Temp changed 15


NOTE:	afm-appli-hvac--0.1--main@0.service  die "0" stat "root"  // außerdem bei bindings checken ob windowmanager verfügbar ist !!

selbsttest:
(evtl klappt hvac jetzt, weil ich zuvor unter agl-driver starten wollte?!)
agl-dri+     848  0.0  0.3  13136  6228 ?        Ss   11:03   0:00 afbd-agl-service-hvac                                                                                                                                                                                                                                                                                                                                                                                                                                              
root        2179  0.0  0.2  11812  5748 ?        Ss   15:06   0:00 afbd-hvac                                                                                                                                                                                                                                                                                                             
root        2180  0.1  6.8 452932 139744 ?       Sl   15:06   0:00 /var/local/lib/afm/applications/hvac/bin/hvac 30033 @t
root        2194  0.0  0.0   3068   632 ttyS1    S+   15:14   0:00 grep hvac

qemux86-64:/# curl localhost:30033/api/hvac/get
{"jtype":"afb-reply","request":{"status":"unknown-api","info":"api hvac not found (for verb get)"}}

( more apps:	https://github.com/ernice/CES2017/tree/master/apps)


Feb 02 15:40:43 qemux86-64 afbd-hvac[2179]:  NOTICE: Unhandled request to /api/hvac/ [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:253,access_handler]
Feb 02 15:41:09 qemux86-64 afbd-hvac[2180]: qml: AirDown true
Feb 02 15:41:09 qemux86-64 afbd-hvac[2180]: qml: AirDown false
Feb 02 15:41:10 qemux86-64 afbd-hvac[2180]: qml: AirUp true

nach uninstall und install von hvac, kann ich es per systemctl start ...@0.service starten, aber nicht über afm-util start..
der service druckt aus:
qemux86-64:/home/root# cat /usr/local/lib/systemd/system/afm-appli-hvac--0.1--main@.service 
# auto generated by wgtpkg-unit for hvac version 0.1 target main of hvac

[Unit]
Description=This is a demo application used to control and dialog with HVAC system
X-AFM-description=This is a demo application used to control and dialog with HVAC system
X-AFM-name=HVAC
X-AFM-shortname=
X-AFM-id=hvac
X-AFM-version=0.1
X-AFM-author=Romain Forlot <romain.forlot@iot.bzh>
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/hvac/icon.svg
X-AFM--ID=48
X-AFM--target-name=main
X-AFM--content=bin/hvac
X-AFM--type=application/vnd.agl.native
X-AFM--wgtdir=/var/local/lib/afm/applications/hvac
X-AFM--workdir=/home/%i/app-data/hvac
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-HVAC@%i.service
After=afm-api-HVAC@%i.service

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/hvac/*
SmackProcessLabel=User::App::hvac
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/hvac
ExecStartPre=/bin/mkdir -p /home/%i/app-data/hvac
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SystemCallFilter=~@clock

Environment=AFM_ID=hvac
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/hvac
Environment=AFM_WORKDIR=/home/%i/app-data/hvac
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/hvac/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/hvac/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/hvac
Environment=XDG_CONFIG_HOME=/home/%i/app-data/hvac
Environment=XDG_CACHE_HOME=/home/%i/app-data/hvac
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/hvac.env
SyslogIdentifier=afbd-hvac
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30048
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-hvac \
	--rootdir=/var/local/lib/afm/applications/hvac \
	--workdir=/home/%i/app-data/hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30048 \
	--interface=tcp:localuser--48:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/HVAC \
	--exec /var/local/lib/afm/applications/hvac/bin/hvac @p @t


----------------> vermutlich für self_HVAC irgendwo ein Fehler im Path: unter /usr/local/lib/systemd/system/ fehlt afm-api-self_HVAC@%i.service

qemux86-64:/# cat /usr/local/lib/systemd/system/afm-api-HVAC@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides api HVAC for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true

qemux86-64:/# cat /usr/local/lib/systemd/system/afm-api-HVAC@.socket  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides websocket api HVAC for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/HVAC
FileDescriptorName=HVAC
Service=afm-service-agl-service-hvac--1.0--main@%i.service


falls nicht gleich klappt:  probieren afm-util kill <app-id>  und dann afm-util start <app-id>

Fazit:
wichtig die services durchzulesen, damit jeder path stimmt. services kann man auch über systemctl starten. Jedes application hat unterliegenden service. 
afm-util kill/start hilft manchmal.

( hvac quelle:	https://gerrit.automotivelinux.org/gerrit/gitweb?p=apps/hvac.git;a=tree;hb=b814a465a9583aa81ae7335d7adfd9df54db59cb )

als nächstes: app self_hvac so anpassen, dass es vorinstallierten service nutzt aber graphisch meine ausgaben ausgibt.



3.2.
zum Test in self_HVAC habe ich die Bildbeschreibungen von HMI_HVAC_AirUp_Inactive und HMI_HVAC_RightChair_OFF vertauscht.
Die Datei afm-appli-self_hvac--0.1--main@.service unter /usr/local/lib/systemd/system habe ich abgeändert, damit es die unten stehenden services einbindet.
afm-api-HVAC@.service		  
afm-api-HVAC@.socket
Danach zeigt mir das Display bei afm-util start die Ausgabe "cannot-start" an aber die app erscheint, und die geänderten bilder werden angezeigt.
( nur MediaPlayer öffnet sich bei klick im Display darauf) ---> könnte am windowmanager liegen ?!

mit afm-util kill und start klappt das starten auch und eine Nummer ( = runid) erscheint 
qemux86-64:/usr/local/lib/systemd/system# journalctl -f
-- Logs begin at Wed 2021-02-03 10:43:50 UTC. --
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Listening interface *:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Browser URL= http://localhost:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start
_http_server]
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Listening interface localuser--44:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_
connect]
Feb 03 12:34:51 qemux86-64 systemd[1]: Started This is a selfmade demo application used to control and dialog with self_HVAC system.
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: setting port: 30044 , token: "@t"
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: #### "/home/0/app-data/self_hvac" "/var/local/lib/afm/applications/self_hvac/bin"
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qml: Right Temp changed 15
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qml: Left Temp changed 15
Feb 03 12:34:51 qemux86-64 afbd-launcher[848]: app_id:  hvac

qemux86-64:/usr/local/lib/systemd/system# ps -ef | grep hvac
agl-dri+     846       1  0 10:43 ?        00:00:00 afbd-agl-service hvac                                                     
root        1582       1  0 12:34 ?        00:00:00 afbd-self_hvac
root        1583    1582  0 12:34 ?        00:00:00 /var/local/lib/afm/applications/self_hvac/bin/hvac 30044 @t


qemux86-64:/usr/local/lib/systemd/system# systemctl status afm-appli-self_hvac--0.1--main@0.service
* afm-appli-self_hvac--0.1--main@0.service - This is a selfmade demo application used to control and dialog with self_HVAC system
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-self_hvac--0.1--main@.service; static; vendor preset: disabled)
     Active: active (running) since Wed 2021-02-03 12:34:51 UTC; 10min ago
    Process: 1581 ExecStartPre=/bin/mkdir -p /home/0/app-data/self_hvac (code=exited, status=0/SUCCESS)
   Main PID: 1582 (afbd-self_hvac)
      Tasks: 4 (limit: 2385)
     Memory: 58.7M
     CGroup: /user.slice/user-0.slice/afm-appli-self_hvac--0.1--main@0.service
             |-1582 afbd-self_hvac
             `-1583 /var/local/lib/afm/applications/self_hvac/bin/hvac 30044 @t

Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/self_hvac uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/>
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Listening interface *:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Browser URL= http://localhost:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,star>
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1582]:  NOTICE: Listening interface localuser--44:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf>
Feb 03 12:34:51 qemux86-64 systemd[1]: Started This is a selfmade demo application used to control and dialog with self_HVAC system.
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: setting port: 30044 , token: "@t"
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: #### "/home/0/app-data/self_hvac" "/var/local/lib/afm/applications/self_hvac/bin"
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qml: Right Temp changed 15
Feb 03 12:34:51 qemux86-64 afbd-self_hvac[1583]: qml: Left Temp changed 15

zum WindowManager:
The Window Manaer is the User Interface (UI) to control the Infotainment System. (check the docs for further details)

agl zippen und auf github

test mit helloworld-app:
zuerst das agl-helloworld-service-binding installiert und erfolgreich gestartet:	qemux86-64:/home# afm-util install agl-service-helloworld.wgt 
danach: helloworld-html installieren.

qemux86-64:/home# systemctl start afm-appli-self_hellow--0.1--main@0.service
Failed to start afm-appli-self_hellow--0.1--main@0.service: Unit afm-api-windowmanager@0.service not found.
 ( ---> das bedeutet ich installiere erstmal den windowmanager)
 
 
 qemux86-64:/home# cat /usr/local/lib/systemd/system/afm-appli-self_hellow--0.1--main@.service 
# auto generated by wgtpkg-unit for self_hellow version 0.1 target main of self_hellow

[Unit]
Description=JUst for checking out
X-AFM-description=JUst for checking out
X-AFM-name=Self-HelloWorld-App
X-AFM-shortname=
X-AFM-id=self_hellow
X-AFM-version=0.1
X-AFM-author=Rolando Endero
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/self_hellow/iot-bzh-logo-small.png
X-AFM--ID=47
X-AFM--target-name=main
X-AFM--content=index.html
X-AFM--type=text/html
X-AFM--wgtdir=/var/local/lib/afm/applications/self_hellow
X-AFM--workdir=/home/%i/app-data/self_hellow
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-windowmanager@%i.service
After=afm-api-windowmanager@%i.service
Requires=afm-api-homescreen@%i.service
After=afm-api-homescreen@%i.service
Requires=afm-api-afm-main@%i.service
After=afm-api-afm-main@%i.service

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/self_hellow/*
SmackProcessLabel=User::App::self_hellow
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/self_hellow
ExecStartPre=/bin/mkdir -p /home/%i/app-data/self_hellow
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SupplementaryGroups=audio
SystemCallFilter=~@clock

Environment=AFM_ID=self_hellow
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/self_hellow
Environment=AFM_WORKDIR=/home/%i/app-data/self_hellow
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/self_hellow/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/self_hellow/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/self_hellow
Environment=XDG_CONFIG_HOME=/home/%i/app-data/self_hellow
Environment=XDG_CACHE_HOME=/home/%i/app-data/self_hellow
Environment=XDG_RUNTIME_DIR=/run/user/%i
Environment=WAIT_FOR_HOST_SERVICE="1"
EnvironmentFile=-/run/platform/debug/self_hellow.env
SyslogIdentifier=afbd-self_hellow
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30047
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-self_hellow \
	--rootdir=/var/local/lib/afm/applications/self_hellow \
	--workdir=/home/%i/app-data/self_hellow \
	--verbose \
	--verbose \
	--monitoring \
	--port=30047 \
	--interface=tcp:localuser--47:8080 \
	--roothttp=. \
	--alias=/icons:/var/local/lib/afm/icons \
		--ws-client=unix:/run/user/%i/apis/ws/windowmanager \
		--ws-client=unix:/run/user/%i/apis/ws/homescreen \
		--ws-client=unix:/run/user/%i/apis/ws/afm-main \
	--exec /usr/bin/cynagoauth-launch /usr/bin/web-runtime http://localuser--47:8080/index.html \
	

( -----> self_hellow Ordner unter /home/0/app-data/ fehlt ! 

genauso folgender Ordner:
qemux86-64:/home# ls /var/local/lib/afm/applications/self_hellow/
config.xml  htdocs  lib
qemux86-64:/home# ls /var/local/lib/afm/applications/self_hvac/  
bin  config.xml  icon.svg  translations
qemux86-64:/home# ls /var/local/lib/afm/applications/self_hvac/bin/
hvac

)

ich habe windowmanager gebuildet, dazu habe ich erstens "python" laufbar gemacht, indem ich unter /usr/bin/python3.8 zu /usr/bin/python geändert habe
und unter src/app.cpp den header "bits/signum.h" mit "signal.h" ersetzt hatte 
[100%] Built target winman
cloud@Cloud-Lab:~/agl/apps/windowmanager/windowmanager-HEAD-04cede8/build$ 

cloud@Cloud-Lab:~/agl/apps/windowmanager/windowmanager-HEAD-04cede8/build$ make install
[  9%] Built target afbclient
[ 38%] Built target redraw_fixer
[100%] Built target winman
Install the project...
-- Install configuration: ""
-- Installing: /etc/layers.json
CMake Error at cmake_install.cmake:49 (file):
  file INSTALL cannot copy file
  "/home/cloud/agl/apps/windowmanager/windowmanager-HEAD-04cede8/layers.json"
  to "/etc/layers.json": Permission denied.

Lösung:
rüberkopieren auf display und nochmal "make install" ausführen ---> klappt nicht weil die Pfade auf diesen laptop eingestellt sind --> 
todo: mehr Infos über windowmanager und wie es ausgeführt wird einholen  ---> evtl in alter version für qemu vorinstalliert ?
das Binding windowmanager.so ausführen und eine service-datei schreiben


5.2.:
making WindowManager and hence helloWorld run

qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides api HVAC for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true


qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.socket  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides websocket api HVAC for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/HVAC
FileDescriptorName=HVAC
Service=afm-service-agl-service-hvac--1.0--main@%i.service





agl-service-helloworld lässt sich starten:
qemux86-64:/home# journalctl -f
-- Logs begin at Fri 2021-02-05 10:37:25 UTC. --
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: API helloworld-event starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  INFO: API helloworld-event started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:299,init_alias]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/agl-service-helloworld uploaddir=. [/usr/src/debug/af-binder/master+gitA
UTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:401,start_http_server]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: Listening interface *:30045 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_co
nnect]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: Browser URL= http://localhost:30045 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:
416,start_http_server]
Feb 05 11:03:40 qemux86-64 afbd-agl-service-helloworld[1505]:  NOTICE: Listening interface localuser---45:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557
,hsrv_itf_connect]
Feb 05 11:03:40 qemux86-64 systemd[1]: Started Provide an AGL Helloworld Binding.


unter  lib/systemd/system/ befindet sich afm-user-setup.service

---------------NOTE: icon-Bilder müssen auf oberste Ebene laut service-file:X-AFM-icon=/var/local/lib/afm/applications/self_hellow/iot-bzh-logo-small.png

aus service-file:
X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service    		---> befindet sich unter sys/fs/cgroup/...
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-windowmanager@%i.service
After=afm-api-windowmanager@%i.service	----> fehlt / Frage ob wegen %i in usr/local... oder /sys/fs/cgro.. besser aufgehoben ?
Requires=afm-api-homescreen@%i.service
After=afm-api-homescreen@%i.service
Requires=afm-api-afm-main@%i.service		---> unter /sys/fs/cgroup und /lib/systemd/system
After=afm-api-afm-main@%i.service

außerdem fehlend:	--ws-client=unix:/run/user/%i/apis/ws/windowmanager \


was ich getan habe:	1.) unter /run/user/%i/apis/ws ordner windowmanager erstellt und eingefügt, mit gleiche rechten wie andere
2.) dummy "afm-api-windowmanager@%i.service und ..socket" in usr/local.. eingefügt  ABER: es fehlt: "afm-service-agl-service-windowmanager--1.0--main@%i.service" in diesem File ist auch das Binding drin *.so

< service und socket gespeichert unter: ~/agl/agl-srv-helwor$ cat afm-api-windowmanager@%i.service  und afm-service ..>
---> klappt nicht so wirklich, evtl doch erstmal an HVAC halten, oder versuchen windowmanager für qemu zu installieren ?
just skip windowmanager from service-file of self_hellow? --> dies hat den start ermöglicht, aber nur kurz im terminal zu sehen ,danach gleich wieder ausgegangen. 
Am besten wird wohl sein sich in objektorientierte QT/C++ einzuarbeiten und die App HVAC zu übernehmen ?!

9.2.: das nach genauer vorlage erstellte app self_app kann nicht installiert werden, wegen: 
qemux86-64:/home# afm-util install self_app.wgt 
ERROR:  failed installation failed: File exists
---> mit HVAC arbeiten und "entkernen"

die auf anderer ubuntu-session entwickelte app schlägt fehl:
ications/hvac/bin/hvac: error while loading shared libraries: libQt5AGLExtras.so.1: cannot open shared object file: No such file 


5.3.
self_QML_v0.wgt testen  ---> vorher fehlt vermutlich binding
qemux86-64:/home# systemctl start afm-appli-self_qml--0.1--main@0.service
Failed to start afm-appli-self_qml--0.1--main@0.service: Unit afm-api-self_QML@0.service not found ---> auf qemu kann ich nicht ws-server.js laufen lassen, also binding selbst schreiben !

8.3.:	mit dummy-binding (HVAC) startet self_qml-App aber Keyboard fehlt für Buchstabeneingabe/oder spracheingabe
6.5.
self_qml_binding und app2_self runtergeladen, mit Keyboard, jetzt testen -->  
qemux86-64:/home# systemctl start afm-appli-self_qml--0.1--main@0.service
Failed to start afm-appli-self_qml--0.1--main@0.service: Unit afm-api-self_QML@0.service not found.

---> ich muss ein service file unter /lib/system/systemd oder /var/local/lib/systemd/system anlegen

Vorlage:
qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.socket  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides websocket api HVAC for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/HVAC
FileDescriptorName=HVAC
Service=afm-service-agl-service-hvac--1.0--main@%i.service
qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides api HVAC for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true


Erstmal dummy-service-file erstellen --> unter ~/agl: afm-api-self_QML@.service   und einfügen unter qemu:/var/local/....

---> keyboard-input möglich :-)   
mit binding testen:	afb-daemon --binding ./self_QML_binding.so --port 1234 --token 123456

connect und send klappt ebenfalls wenn afb-daemon im Hintergrund läuft  :-)
Idee:  für self_qml bei "ExecStart= afb-daemon --binding ..."   eingeben

wiedergabe bei journalctl -xe:
-- A start job for unit afm-appli-self_qml--0.1--main@0.service has begun execution.
-- 
-- The job identifier is 5922.
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: ------BEGIN OF CONFIG-----
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: -- {
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "name": "afbd-self_qml",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "rootdir": "/var/local/lib/afm/applications/self_qml",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "workdir": "/home/0/app-data/self_qml",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "monitoring": true,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "port": 30044,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "interface": [
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "tcp:localuser--44:8080"
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    ],
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "roothttp": ".",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "ws-client": [
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "unix:/run/user/0/apis/ws/self_QML"
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    ],
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "exec": [
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "/var/local/lib/afm/applications/self_qml/bin/self_qml",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "@p",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "@t"
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    ],
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "apitimeout": 20,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "cache-eol": 100000,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "cntxtimeout": 32000000,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "session-max": 200,
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "uploaddir": ".",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "rootbase": "/opa",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "rootapi": "/api",
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "ldpaths": [
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "/usr/lib/afb"
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    ],
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    "alias": [
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --      "/monitoring:/usr/lib/afb/monitoring"
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --    ]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: --  }
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]: ------END OF CONFIG-----
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: running with pid 1532 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/gi>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: Scanning dir=[/usr/lib/afb] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,a>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/self_QML [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-so>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-dae>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/self_qml uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  NOTICE: Listening interface *:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  NOTICE: Browser URL= http://localhost:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http>
May 06 08:31:49 qemux86-64 afbd-self_qml[1532]:  NOTICE: Listening interface localuser--44:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_conne>


qemux86-64:/home# systemctl status afm-appli-self_qml--0.1--main@0.service
* afm-appli-self_qml--0.1--main@0.service - This is a selfmade demo qml application
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-self_qml--0.1--main@.service; static; vendor preset: disabled)
     Active: active (running) since Thu 2021-05-06 08:31:49 UTC; 7min ago
    Process: 1531 ExecStartPre=/bin/mkdir -p /home/0/app-data/self_qml (code=exited, status=0/SUCCESS)
   Main PID: 1532 (afbd-self_qml)
      Tasks: 4 (limit: 2385)
     Memory: 83.5M
     CGroup: /user.slice/user-0.slice/afm-appli-self_qml--0.1--main@0.service
             |-1532 afbd-self_qml
             `-1533 /var/local/lib/afm/applications/self_qml/bin/self_qml 30044 @t

May 06 08:32:01 qemux86-64 afbd-self_qml[1533]: "Could not convert argument 0 at"
May 06 08:32:01 qemux86-64 afbd-self_qml[1533]:          "onClicked@qrc:/SingleKey.qml:93"
May 06 08:32:01 qemux86-64 afbd-self_qml[1533]: "Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."
May 06 08:32:01 qemux86-64 afbd-self_qml[1533]: "This will throw a JavaScript TypeError in future releases of Qt!"
May 06 08:32:02 qemux86-64 afbd-self_qml[1533]: "Could not convert argument 0 at"
May 06 08:32:02 qemux86-64 afbd-self_qml[1533]:          "onClicked@qrc:/SingleKey.qml:98"
May 06 08:32:02 qemux86-64 afbd-self_qml[1533]: "Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."
May 06 08:32:02 qemux86-64 afbd-self_qml[1533]: "This will throw a JavaScript TypeError in future releases of Qt!"
May 06 08:32:05 qemux86-64 afbd-self_qml[1533]: QNativeSocketEngine::write() was not called in QAbstractSocket::ConnectedState
May 06 08:32:06 qemux86-64 afbd-self_qml[1533]: QNativeSocketEngine::write() was not called in QAbstractSocket::ConnectedState


/*
zu Service eine MusterVorlage:
Now what we have above is just rudimentary, here is a complete setup for spark:

[Unit]
Description=Apache Spark Master and Slave Servers
After=network.target
After=systemd-user-sessions.service
After=network-online.target

[Service]
User=spark
Type=forking
ExecStart=/opt/spark-1.6.1-bin-hadoop2.6/sbin/start-all.sh
ExecStop=/opt/spark-1.6.1-bin-hadoop2.6/sbin/stop-all.sh
TimeoutSec=30
Restart=on-failure
RestartSec=30
StartLimitInterval=350
StartLimitBurst=10

[Install]
WantedBy=multi-user.target

To setup the service:

sudo systemctl start spark.service
sudo systemctl stop spark.service
sudo systemctl enable spark.service
*/


bei HVAC steht auch: ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC
qemux86-64:/home# afm-util start HVAC
1579
qemux86-64:/home# journalctl -xe
-- A start job for unit afm-service-agl-service-hvac--1.0--main@0.service has finished with a failure.
-- 
-- The job identifier is 6789 and the job result is failed.
May 06 08:51:26 qemux86-64 systemd[1]: afm-api-HVAC@0.socket: Failed with result 'service-start-limit-hit'.
-- Subject: Unit failed
-- Defined-By: systemd
-- Support: https://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- The unit afm-api-HVAC@0.socket has entered the 'failed' state with result 'service-start-limit-hit'.
May 06 08:51:26 qemux86-64 afbd-hvac[1581]: #### "/home/0/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
May 06 08:51:26 qemux86-64 afbd-hvac[1581]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
May 06 08:51:26 qemux86-64 afbd-hvac[1581]: qml: Right Temp changed 15
May 06 08:51:26 qemux86-64 afbd-hvac[1581]: qml: Left Temp changed 15
May 06 08:51:26 qemux86-64 afbd-launcher[846]: app_id:  hvac
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:30 qemux86-64 afbd-hvac[1579]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/HVAC [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:3>
May 06 08:51:32 qemux86-64 afbd-hvac[1581]: qml: A/C true
May 06 08:51:33 qemux86-64 afbd-hvac[1581]: qml: AUTO true
May 06 08:51:34 qemux86-64 afbd-hvac[1581]: qml: Circulation true

qemux86-64:/home# systemctl status afm-service-agl-service-hvac--1.0--main@0.service
* afm-service-agl-service-hvac--1.0--main@0.service - Binding for HVAC interface
     Loaded: loaded (/usr/local/lib/systemd/system/afm-service-agl-service-hvac--1.0--main@.service; disabled; vendor preset: disabled)
     Active: failed (Result: exit-code) since Thu 2021-05-06 08:51:26 UTC; 2min 28s ago
TriggeredBy: * afm-api-HVAC@0.socket
    Process: 1591 ExecStartPre=/bin/mkdir -p /home/0/app-data/agl-service-hvac (code=exited, status=0/SUCCESS)
    Process: 1592 ExecStart=/usr/bin/afb-daemon --name afbd-agl-service-hvac --rootdir=/var/local/lib/afm/applications/agl-service-hvac --workdir=/home/0/app-data/agl-service-hvac --verbose ->
   Main PID: 1592 (code=exited, status=1/FAILURE)

May 06 08:51:26 qemux86-64 afbd-agl-service-hvac[1592]:  NOTICE: API low-can starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
May 06 08:51:26 qemux86-64 afbd-agl-service-hvac[1592]:  INFO: API low-can started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
May 06 08:51:26 qemux86-64 afbd-agl-service-hvac[1592]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
May 06 08:51:26 qemux86-64 afbd-agl-service-hvac[1592]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
May 06 08:51:26 qemux86-64 systemd[1]: afm-service-agl-service-hvac--1.0--main@0.service: Main process exited, code=exited, status=1/FAILURE
May 06 08:51:26 qemux86-64 systemd[1]: afm-service-agl-service-hvac--1.0--main@0.service: Failed with result 'exit-code'.
May 06 08:51:26 qemux86-64 systemd[1]: Failed to start Binding for HVAC interface.
May 06 08:51:26 qemux86-64 systemd[1]: afm-service-agl-service-hvac--1.0--main@0.service: Start request repeated too quickly.
May 06 08:51:26 qemux86-64 systemd[1]: afm-service-agl-service-hvac--1.0--main@0.service: Failed with result 'exit-code'.
May 06 08:51:26 qemux86-64 systemd[1]: Failed to start Binding for HVAC interface.

qemux86-64:/home# cat /usr/local/lib/systemd/system/afm-service-agl-service-hvac--1.0--main@.service
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac

[Unit]
Description=Binding for HVAC interface
X-AFM-description=Binding for HVAC interface
X-AFM-name=agl-service-hvac
X-AFM-shortname=
X-AFM-id=agl-service-hvac
X-AFM-version=1.0
X-AFM-author= <>
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/agl-service-hvac/icon.png
X-AFM--ID=13
X-AFM--target-name=main
X-AFM--content=lib/libafm-hvac-binding.so
X-AFM--type=application/vnd.agl.service
X-AFM--wgtdir=/var/local/lib/afm/applications/agl-service-hvac
X-AFM--workdir=/home/%i/app-data/agl-service-hvac
X-AFM--visibility=hidden

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-identity@%i.service
After=afm-api-identity@%i.service
Requires=afm-api-low-can@%i.service
After=afm-api-low-can@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/agl-service-hvac/*
SmackProcessLabel=User::App::agl-service-hvac
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/agl-service-hvac
ExecStartPre=/bin/mkdir -p /home/%i/app-data/agl-service-hvac
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SystemCallFilter=~@clock

Environment=AFM_ID=agl-service-hvac
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/agl-service-hvac
Environment=AFM_WORKDIR=/home/%i/app-data/agl-service-hvac
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/agl-service-hvac/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/agl-service-hvac/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CONFIG_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CACHE_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/agl-service-hvac.env
SyslogIdentifier=afbd-agl-service-hvac
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30013
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-hvac \
	--rootdir=/var/local/lib/afm/applications/agl-service-hvac \
	--workdir=/home/%i/app-data/agl-service-hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30013 \
	--interface=tcp:localuser--13:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/identity \
		--ws-client=unix:/run/user/%i/apis/ws/low-can \
		--binding=/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so \
		--ws-server=sd:HVAC \
	

[Install]
WantedBy=afm-user-session@.target

-----------------------------------------------------------------------------------------------------------------------
wichtig: TriggeredBy: * afm-api-HVAC@0.socket  also sollte ich afm-api-self_QML.socket erstellen
Im Socket wird verwiesen auf das "große" Service-File afm-service-agl-service-hvac--1.0--main@.service


fehler "ERROR: can't open client socket for unix:/run/user/0/apis/ws/self_QML [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]" evtl durch manuelles erstellen eines Websockets lösen?
File-Struktur für self_QML anpassen und socket/service übernehmen

7.5.
app_attempt4.wgt test:
FAILURE:
emux86-64:/home# systemctl status afm-appli-self_qml--0.1--main@0.service und self_QML_v2.wgt
* afm-appli-self_qml--0.1--main@0.service - This is a selfmade demo qml application
     Loaded: bad-setting (Reason: Unit afm-appli-self_qml--0.1--main@0.service has a bad unit file setting.)
     Active: inactive (dead)

May 07 11:36:47 qemux86-64 systemd[1]: afm-appli-self_qml--0.1--main@0.service: Service has no ExecStart=, ExecStop=, or SuccessAction=. Refusing.

( manuell starten über var/local/lib/afm/application/self_qml/bin/self_qml klappt trotzdem)
wenn socket- und service-file zuerst gespeichert werden, klappt das starten der App und Buchstaben eintippen, aber kommunikaiton mit binding klappt nicht.

Ordnerstruktur:
qemux86-64:/home# cd /var/local/lib/afm/applications/self_qml/
qemux86-64:/var/local/lib/afm/applications/self_qml# ls
bin  config.xml  icon.svg  lib	package.pro
qemux86-64:/var/local/lib/afm/applications/self_qml# ls bin/
self_qml
qemux86-64:/var/local/lib/afm/applications/self_qml# ls lib 
self_QML_binding.so

qemux86-64:/var/local/lib/afm/applications# ls hvac/
bin  config.xml  icon.svg  translations
qemux86-64:/var/local/lib/afm/applications# ls hvac/bin/
hvac

das Binding ist unter:
qemux86-64:/var/local/lib# ls /afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so

(Beim Draufklicken im Homescreen öffnet sich die App sogar :-) )

Skript schreiben:
service und socket file anpassen, in ein Ordner unterbringen und beim Start der App installieren

prüfen ob und wo die Files installiert werden, wenn ich sie in ein wgt packen mit: wgtpkg-pack -f -o self_hellow.wgt package

nach "afm-util install *.wgt" befindet sich Ordnerinahlt wie verpackt in /var/local/lib/afm/applications/self_qml

aus journalctl:

May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: ------BEGIN OF CONFIG-----
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: -- {
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "tcp:localuser--44:8080"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "@t"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "apitimeout": 20,
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "cache-eol": 100000,
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "roothttp": ".",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "ws-client": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "unix:/run/user/0/apis/ws/self_QML"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "binding": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "/var/local/lib/afm/applications/self_qml/lib/self_QML_binding.so"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "exec": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "/var/local/lib/afm/applications/self_qml/bin/self_qml",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "@p",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "@t"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "exec": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "/var/local/lib/afm/applications/self_qml/bin/self_qml",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "@p",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "@t"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
lines 2909-2931



May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "uploaddir": ".",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "rootbase": "/opa",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "rootapi": "/api",
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "ldpaths": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "/usr/lib/afb"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ],
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    "alias": [
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --      "/monitoring:/usr/lib/afb/monitoring"
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --    ]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: --  }
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]: ------END OF CONFIG-----
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: running with pid 1258 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b624>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: binding [/var/local/lib/afm/applications/self_qml/lib/self_QML_binding.so] looks like an AFB binding V3 [/usr/src/debug/af-bi>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: API helloworld added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: Scanning dir=[/usr/lib/afb] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,a>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api>

May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/self_QML [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: API helloworld starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: API helloworld started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/m>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/self_qml uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: Listening interface *:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_conne>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: Browser URL= http://localhost:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416>
May 10 08:31:51 qemux86-64 afbd-self_qml[1258]:  NOTICE: Listening interface localuser--44:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsr>

May 10 08:31:52 qemux86-64 afbd-self_qml[1264]: Both point size and pixel size set. Using pixel size.


---> next: anpassen config-File für APIs und checken wie Binding installiert wird. Binding wird nicht explizit installiert, also probiere ich es mal über config- und service-files nach 
Vorbild hvac

<	es gibt Application-bindings und service-binding, ersteres ist zugeschnitten auf eine App, zweiteres ist systemweit, sowas wie zB Bluetooth-service.
Application and service bindings are loaded and activated each time a new  afb-daemon is started.At launch time, every loaded binding initialise itself. If a single binding initialisation
fails the corresponding instance of afb-daemon aborts. > 


hvac - config.xml
qemux86-64:/var/local/lib/afm/applications/hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="hvac" version="0.1">
  <name>HVAC</name>
  <icon src="icon.svg"/>
  <content src="bin/hvac" type="application/vnd.agl.native"/>
  <description>This is a demo application used to control and dialog with HVAC system</description>
  <author>Romain Forlot &lt;romain.forlot@iot.bzh&gt;</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="HVAC" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>


qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls
bin  config.xml  etc  htdocs  icon.png	lib  var
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls bin/
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls htdocs/
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls etc    
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls lib/
libafm-hvac-binding.so
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls var/
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-hvac" version="1.0">
	<name>agl-service-hvac</name>
	<icon src="icon.png"/>
	<content src="lib/libafm-hvac-binding.so" type="application/vnd.agl.service"/>
	<description>Binding for HVAC interface</description>
	<author> &lt;&gt;</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="required" />
		<param name="urn:AGL:permission::public:no-htdocs" value="required" />
		<param name="urn:AGL:permission::system:run-by-default" value="required" />
		<param name="urn:AGL:permission::platform:can:write" value="required" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="HVAC" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-api">
		<param name="identity" value="ws" />
		<param name="low-can" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/libafm-hvac-binding.so" value="local" />
	</feature>
</widget>


qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides api HVAC for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true

qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.socket  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides websocket api HVAC for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/HVAC
FileDescriptorName=HVAC
Service=afm-service-agl-service-hvac--1.0--main@%i.service

qemux86-64:/var/local/lib/systemd/system# cat afm-service-agl-service-hvac--1.0--main@.service  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac

[Unit]
Description=Binding for HVAC interface
X-AFM-description=Binding for HVAC interface
X-AFM-name=agl-service-hvac
X-AFM-shortname=
X-AFM-id=agl-service-hvac
X-AFM-version=1.0
X-AFM-author= <>
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/agl-service-hvac/icon.png
X-AFM--ID=13
X-AFM--target-name=main
X-AFM--content=lib/libafm-hvac-binding.so
X-AFM--type=application/vnd.agl.service
X-AFM--wgtdir=/var/local/lib/afm/applications/agl-service-hvac
X-AFM--workdir=/home/%i/app-data/agl-service-hvac
X-AFM--visibility=hidden

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-identity@%i.service
After=afm-api-identity@%i.service
Requires=afm-api-low-can@%i.service
After=afm-api-low-can@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/agl-service-hvac/*
SmackProcessLabel=User::App::agl-service-hvac
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/agl-service-hvac
ExecStartPre=/bin/mkdir -p /home/%i/app-data/agl-service-hvac
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SystemCallFilter=~@clock

Environment=AFM_ID=agl-service-hvac
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/agl-service-hvac
Environment=AFM_WORKDIR=/home/%i/app-data/agl-service-hvac
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/agl-service-hvac/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/agl-service-hvac/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CONFIG_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CACHE_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/agl-service-hvac.env
SyslogIdentifier=afbd-agl-service-hvac
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30013
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-hvac \
	--rootdir=/var/local/lib/afm/applications/agl-service-hvac \
	--workdir=/home/%i/app-data/agl-service-hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30013 \
	--interface=tcp:localuser--13:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/identity \
		--ws-client=unix:/run/user/%i/apis/ws/low-can \
		--binding=/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so \
		--ws-server=sd:HVAC \
	

[Install]
WantedBy=afm-user-session@.target



---> to do:
self_QML.wgt/config.xml				--> done
agl-service/config.xml  				--> done
afm-service-agl-service-hvac--1.0--main@.service	--> done (aber Port 1234 evtl checken)
afm-api-<selfQML>@.socket				--> done
afm-api-<selfQML>@.service				--> done

(überall im Filename ein kleines qml)

permission denied fehler:
May 10 13:16:04 qemux86-64 afbd-agl-service-self_qml[1351]: /bin/mkdir: cannot create directory '/home/0': Permission denied
May 10 13:16:05 qemux86-64 audit[1372]: AVC lsm=SMACK fn=smack_inode_permission action=denied subject="User::App::agl-service-self_qml" object="System::Shared" requested=x pid=1372 comm="mkdir" name="etc" dev="vda" ino=149


allein mit installieren .wgt wurde "afm-appli-self_qml--0.1--main@.service" erstellt:
qemux86-64:/home# cat /var/local/lib/systemd/system/afm-appli-self_qml--0.1--main@.service
# auto generated by wgtpkg-unit for self_qml version 0.1 target main of self_qml

[Unit]
Description=This is a selfmade demo qml application
X-AFM-description=This is a selfmade demo qml application
X-AFM-name=self_QML
X-AFM-shortname=
X-AFM-id=self_qml
X-AFM-version=0.1
X-AFM-author=Rolando Endero 
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/self_qml/icon.svg
X-AFM--ID=44
X-AFM--target-name=main
X-AFM--content=bin/self_qml
X-AFM--type=application/vnd.agl.native
X-AFM--wgtdir=/var/local/lib/afm/applications/self_qml
X-AFM--workdir=/home/%i/app-data/self_qml
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-self_QML@%i.service
After=afm-api-self_QML@%i.service

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/self_qml/*
SmackProcessLabel=User::App::self_qml
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/self_qml
ExecStartPre=/bin/mkdir -p /home/%i/app-data/self_qml
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SystemCallFilter=~@clock

Environment=AFM_ID=self_qml
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/self_qml
Environment=AFM_WORKDIR=/home/%i/app-data/self_qml
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/self_qml/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/self_qml/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/self_qml
Environment=XDG_CONFIG_HOME=/home/%i/app-data/self_qml
Environment=XDG_CACHE_HOME=/home/%i/app-data/self_qml
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/self_qml.env
SyslogIdentifier=afbd-self_qml
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30044
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-self_qml \
	--rootdir=/var/local/lib/afm/applications/self_qml \
	--workdir=/home/%i/app-data/self_qml \
	--verbose \
	--verbose \
	--monitoring \
	--port=30044 \
	--interface=tcp:localuser--44:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/self_QML \
	--exec /var/local/lib/afm/applications/self_qml/bin/self_qml @p @t

qemux86-64:/home# 

--> evtl muss ich agl-service..service gar nicht selbst erstellen sondern kann das über config.xml steuern

mir wird in Linux als offener Port 30044 angezeigt, evtl liegts daran, afb-daemon hat ja port 1234 --> es gibt wohl pro installation 3 Files (.service,socket, appli.-..service)
wahrscheinlich abhängig ob agl.native oder agl.binding usw.    evtl kann ich portangabe unter etc einbringen, dort liegen die config-files laut präsentation AGL-app-design.pdf
Muss ich in config.xml auch die API vom binding angeben ?!

<      to do:		permissions richtig setzen (required/optional)	>


nach Erstinstallation (und erstem fehlgeschlagenen Start) sind folgende Files vorhanden:
qemux86-64:/var/local/lib# find -name *self_qml*
./systemd/system/afm-appli-self_qml--0.1--main@.service
./afm/applications/self_qml
./afm/applications/self_qml/bin/self_qml
./afm/applications/self_qml/agl-service-self_qml
./afm/icons/self_qml


separates Application und binding nach Vorbild von HVAC bzw. HVAC-service: https://gerrit.automotivelinux.org/gerrit/gitweb?p=apps/agl-service-hvac.git;a=tree
oder app/rolemodel...
oder für builds from jennkins: https://build.automotivelinux.org/view/All/


zuerst erstelle ich die MoTalk-App nach Vorbild HVAC-App, dann den service mit folgender Ordnerstruktur:
qemux86-64:/var/local/lib/afm/applications# ls hvac
bin  config.xml  icon.svg  translations
qemux86-64:/var/local/lib/afm/applications# ls agl-service-hvac/
bin  config.xml  etc  htdocs  icon.png	lib  var

(exit qemu: poweroff)

Installation:
qemux86-64:/var/local/lib# afm-util install /home/motalk.wgt 
{
  "added":"motalk"
}

qemux86-64:/var/local/lib# find -name *motalk*
./systemd/system/afm-appli-motalk--0.1--main@.service
./afm/applications/motalk
./afm/applications/motalk/bin/motalk
./afm/icons/motalk
qemux86-64:/var/local/lib# afm-util install /home/agl-service-motalk.wgt 
{
  "added":"agl-service-motalk"
}
qemux86-64:/var/local/lib# find -name *motalk*
./systemd/system/afm-api-motalk@.socket
./systemd/system/afm-service-agl-service-motalk--1.0--main@.service
./systemd/system/afm-appli-motalk--0.1--main@.service
./systemd/system/afm-api-motalk@.service
./systemd/system/afm-user-session@.target.wants/afm-service-agl-service-motalk--1.0--main@.service
./afm/applications/motalk
./afm/applications/motalk/bin/motalk
./afm/applications/agl-service-motalk
./afm/applications/agl-service-motalk/lib/motalk_binding.so
./afm/icons/motalk
./afm/icons/agl-service-motalk

bei start von service folgender Fehler:  RROR: Can't provide ws-server for URI sd:motalk: API motalk doesn't exist
evtl muss api-websocket gleichen Namen haben wie im Binding file ?! --> sehr wahrscheinlich,alle anderen bindings weisen den gleichen namen für api auf 
---> erstmal testen wenn api helloworld heißt, das bedeute das config-file in service-motalk anzupassen.
Jetzt klappt die API mit widget-packets aus rolemodel_acc_motalk Ordnern, aber vermutlich ist der falsche Port gesetzt. 
Es wird automatisch immer auf Port=30045 oder so eingestellt

Gedanke: ich kann nicht gleichzeitig afb-daemon vom gleichen Port öffnen - evtl ist binding doch falsch in agl-service-motalk ?

Wenn ich nur application starte, kommt folgendes:
afm-appli-motalk--0.1--main@0.service - This is a selfmade demo qml application
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-motalk--0.1--main@.service; static; vendor preset: disabled)
     Active: active (running) since Thu 2021-05-13 21:57:46 UTC; 5min ago
    Process: 1657 ExecStartPre=/bin/mkdir -p /home/0/app-data/motalk (code=exited, status=0/SUCCESS)
   Main PID: 1658 (afbd-motalk)
      Tasks: 4 (limit: 2385)
     Memory: 79.9M
     CGroup: /user.slice/user-0.slice/afm-appli-motalk--0.1--main@0.service
             |-1658 afbd-motalk
             `-1660 /var/local/lib/afm/applications/motalk/bin/motalk 1234 @t

May 13 21:58:05 qemux86-64 afbd-motalk[1658]:  ERROR: can't open client socket for unix:/run/user/0/apis/ws/helloworld [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249


---> vergleichen mit zB hvac-service-files bezogen auf port

----> es läuft, wenn ich bloß motalk_bundled.wgt installiere, dann agl-service-motalk auf port=1234 ändere (und installieren?!), dann mit afm-util kille und nochmal starte
to do: erst Skript schreiben, damit kommunikation gelingt (port ändern) und dann das config.xml so anpassen, dass bei sysctl keine Fehler mehr auftreten 
---> motalk_portchange läuft

zu permissions:
The AGL framework uses the feature tag for specifying security and binding requirement of the widget.

bug: icon wird nicht angzeigt, aber das trifft auf mehrer Apps zu, einfach anschauen was dort der unterschied zu dashbord-icon oder so ist, evtl homescreen neustarten ?!

alle units-files listen:	systemctl list-unit-files

Ungereimthieten bei API-schnittstellen klären (API=helloworld)

2.9.:
einlesen in agl-service-motalk und motalk_portchange.wgt


neue App unter home/cloud/agl/apps/MoTalk_v2 in ein .wgt verpacken mit binding und zum Laufen bringen!!

Ziel: ein einzelnes widget für App und binding
Das File https://iot.bzh/download/public/2018/amm-dresden/AGL-app-design.pdf  hilfreich beim Aufbau von App und binding

verpacken mit:
source sdk/environment...
wgtpkg-pack -f -o self_hellow.wgt(=Ziel) package(=beinhaltender Ordner)

kopieren mit "scp -P 2222 motalk_v2.wgt  root@localhost:/home"
qemux86-64:~# afm-util install motalk_v2.wgt 
afm-util start motalk

qemux86-64:/home# journalctl | grep motalk

Fehler:
Oct 15 14:01:08 qemux86-64 afbd-motalk[1128]:  ERROR: binding [/var/local/lib/afm/applications/motalk/lib/motalk_reawi_binding.so] not loadable: /var/local/lib/afm/applications/motalk/lib/motalk_reawi_binding.so: invalid ELF header [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:97,load_binding]
Oct 15 14:01:08 qemux86-64 afbd-motalk[1128]:  ERROR: can't start the binding /var/local/lib/afm/applications/motalk/lib/motalk_reawi_binding.so [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:178,apiset_start_list]

qemux86-64:/home# systemctl status afm-appli-motalk--0.1--main@i.service
* afm-appli-motalk--0.1--main@i.service - This is a motalk (+++ service ) qml application
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-motalk--0.1--main@.service; disabled; vendor preset: disabled)
     Active: inactive (dead)
TriggeredBy: * afm-api-motalk2021@i.socket

qemux86-64:/home# systemctl status afm-api-motalk2021@i.socket 
* afm-api-motalk2021@i.socket - Provides websocket api motalk2021 for user i
     Loaded: loaded (/usr/local/lib/systemd/system/afm-api-motalk2021@.socket; static; vendor preset: disabled)
     Active: inactive (dead)
   Triggers: * afm-appli-motalk--0.1--main@i.service
     Listen: /run/user/i/apis/ws/motalk2021 (Stream)

qemux86-64:/var/local/lib# cat systemd/system/afm-api-motalk2021@.socket
# auto generated by wgtpkg-unit for motalk version 0.1 target main of motalk
[Unit]
Description=Provides websocket api motalk2021 for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/motalk2021
FileDescriptorName=motalk2021
Service=afm-appli-motalk--0.1--main@%i.service
qemux86-64:/var/local/lib# 



qemux86-64:/var/local/lib# cat systemd/system/afm-appli-motalk--0.1--main@.service
# auto generated by wgtpkg-unit for motalk version 0.1 target main of motalk

[Unit]
Description=This is a motalk (+++ service ) qml application
X-AFM-description=This is a motalk (+++ service ) qml application
X-AFM-name=MoTalk with included binding
X-AFM-shortname=
X-AFM-id=motalk
X-AFM-version=0.1
X-AFM-author=Rolando Endero 
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/motalk/icon.svg
X-AFM--ID=44
X-AFM--target-name=main
X-AFM--content=bin/motalk
X-AFM--type=application/vnd.agl.native
X-AFM--wgtdir=/var/local/lib/afm/applications/motalk
X-AFM--workdir=/home/%i/app-data/motalk
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-motalk2021@%i.service
After=afm-api-motalk2021@%i.service
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/motalk/*
SmackProcessLabel=User::App::motalk
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/motalk
ExecStartPre=/bin/mkdir -p /home/%i/app-data/motalk
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SystemCallFilter=~@clock

Environment=AFM_ID=motalk
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/motalk
Environment=AFM_WORKDIR=/home/%i/app-data/motalk
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/motalk/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/motalk/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/motalk
Environment=XDG_CONFIG_HOME=/home/%i/app-data/motalk
Environment=XDG_CACHE_HOME=/home/%i/app-data/motalk
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/motalk.env
SyslogIdentifier=afbd-motalk
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30044
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-motalk \
	--rootdir=/var/local/lib/afm/applications/motalk \
	--workdir=/home/%i/app-data/motalk \
	--verbose \
	--verbose \
	--monitoring \
	--port=30044 \
	--interface=tcp:localuser--44:8080 \
	--roothttp=. \
	--alias=/icons:/var/local/lib/afm/icons \
		--ws-client=unix:/run/user/%i/apis/ws/motalk2021 \
		--binding=/var/local/lib/afm/applications/motalk/lib/motalk_reawi_binding.so \
		--ws-server=sd:motalk2021 \
	--exec /var/local/lib/afm/applications/motalk/bin/motalk @p @t

[Install]
WantedBy=afm-user-session@.target

qemux86-64:/# cat var/local/lib/systemd/system/afm-api-motalk2021@.service
# auto generated by wgtpkg-unit for motalk version 0.1 target main of motalk
[Unit]
Description=Provides api motalk2021 for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true



Unterschiede afm-appli-motalk nach Installation zu Motalk_accrd_Rolemodel:
# Automatic bound to required api
Requires=afm-api-motalk2021@%i.service
After=afm-api-motalk2021@%i.service
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket
...
X-AFM-http-port=30044
...
	--port=30044 \


statt:
# Automatic bound to required api
Requires=afm-api-helloworld@%i.service
After=afm-api-helloworld@%i.service
Requires=afm-api-helloworld@%i.socket
After=afm-api-helloworld@%i.socket
...
X-AFM-http-port=1234

---> testen nach Ändern des Ports in afm-appli-motalk-00.1...
hat erstmal nichts geändert.   als nächstes vergleichen mit Struktur anderer Apps


Beispiel hvac:

Oct 18 09:36:51 qemux86-64 run-agl-postinsts[304]: Running postinst /etc/agl-postinsts/10-hvac.sh...
Oct 18 09:36:51 qemux86-64 afm-system-daemon[300]:  NOTICE: -- INSTALLING widget /usr/AGL/apps/release/hvac.wgt to /var/local/lib/afm/applications -- [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/wgtpkg-install.c:674]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: ------BEGIN OF CONFIG-----
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: -- {
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "name": "afbd-agl-service-hvac",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "rootdir": "/var/local/lib/afm/applications/agl-service-hvac",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "workdir": "/home/1001/app-data/agl-service-hvac",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "monitoring": true,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "port": 30013,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "interface": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "tcp:localuser--13:8080"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ],
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "roothttp": ".",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "ws-client": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "unix:/run/user/1001/apis/ws/identity",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "unix:/run/user/1001/apis/ws/low-can"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ],
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "binding": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ],
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "ws-server": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "sd:HVAC"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ],
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "apitimeout": 20,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "cache-eol": 100000,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "cntxtimeout": 32000000,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "session-max": 200,
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "uploaddir": ".",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "rootbase": "/opa",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "rootapi": "/api",
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "ldpaths": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "/usr/lib/afb"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ],
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    "alias": [
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --    ]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: --  }
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]: ------END OF CONFIG-----
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: running with pid 851 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-supervision.c:165,try_connect_supervisor]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: binding [/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so] looks like an AFB binding V3 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so-v3.c:84,afb_api_so_v3_add]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: API hvac added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: Scanning dir=[/usr/lib/afb] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: API identity added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Oct 18 09:36:54 qemux86-64 afbd-agl-service-hvac[851]:  INFO: API low-can added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]


daraus:
Oct 18 09:36:49 qemux86-64 run-agl-postinsts[304]: Running postinst /etc/agl-postinsts/10-agl-service-hvac.sh...

Oct 18 09:36:50 qemux86-64 afm-system-daemon[300]:  NOTICE: -- INSTALLING widget /usr/AGL/apps/release/agl-service-hvac.wgt to /var/local/lib/afm/applications -- [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/wgtpkg-install.c:674]
Oct 18 09:36:51 qemux86-64 run-agl-postinsts[304]: Running postinst /etc/agl-postinsts/10-hvac.sh...
Oct 18 09:36:51 qemux86-64 afm-system-daemon[300]:  NOTICE: -- INSTALLING widget /usr/AGL/apps/release/hvac.wgt to /var/local/lib/afm/applications -- [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/wgtpkg-install.c:674]

-------------> hvac installiert zwei widgets, agl-service-hvac.wgt und hvac.wgt

vorhandene Dateien:
qemux86-64:/# find -name *hvac*
./home/1001/app-data/agl-service-hvac
./home/1001/app-data/hvac
./home/1001/app-data/hvac/hvac
./etc/hvac.json
./etc/smack/accesses.d/pkg_hvac
./etc/smack/accesses.d/pkg_agl-service-hvac
./etc/smack/accesses.d/app_hvac
./etc/smack/accesses.d/app_agl-service-hvac
./run/systemd/units/invocation:afm-appli-hvac--0.1--main@1001.service
./run/systemd/units/invocation:afm-service-agl-service-hvac--1.0--main@1001.service
./sys/fs/cgroup/pids/user.slice/user-1001.slice/afm-service-agl-service-hvac--1.0--main@1001.service
./sys/fs/cgroup/pids/user.slice/user-1001.slice/afm-appli-hvac--0.1--main@1001.service
./sys/fs/cgroup/memory/user.slice/user-1001.slice/afm-service-agl-service-hvac--1.0--main@1001.service
./sys/fs/cgroup/memory/user.slice/user-1001.slice/afm-appli-hvac--0.1--main@1001.service
./sys/fs/cgroup/systemd/user.slice/user-1001.slice/afm-service-agl-service-hvac--1.0--main@1001.service
./sys/fs/cgroup/systemd/user.slice/user-1001.slice/afm-appli-hvac--0.1--main@1001.service
./sys/fs/cgroup/unified/user.slice/user-1001.slice/afm-service-agl-service-hvac--1.0--main@1001.service
./sys/fs/cgroup/unified/user.slice/user-1001.slice/afm-appli-hvac--0.1--main@1001.service
./usr/include/qtappfw-hvac
./usr/include/qtappfw-hvac/hvac.h
./usr/lib/libqtappfw-hvac.so.1.0.0
./usr/lib/libqtappfw-hvac.so.1
./usr/lib/libqtappfw-hvac.so
./usr/lib/pkgconfig/qtappfw-hvac.pc
./usr/AGL/apps/debug/agl-service-hvac-debug.wgt
./usr/AGL/apps/debug/hvac-debug.wgt
./usr/AGL/apps/release/agl-service-hvac.wgt
./usr/AGL/apps/release/hvac.wgt
./usr/AGL/apps/coverage/agl-service-hvac-coverage.wgt
./var/local/lib/systemd/system/afm-appli-hvac--0.1--main@.service
./var/local/lib/systemd/system/afm-service-agl-service-hvac--1.0--main@.service
./var/local/lib/systemd/system/afm-user-session@.target.wants/afm-service-agl-service-hvac--1.0--main@.service
./var/local/lib/afm/applications/agl-service-hvac
./var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so
./var/local/lib/afm/applications/hvac
./var/local/lib/afm/applications/hvac/bin/hvac
./var/local/lib/afm/icons/agl-service-hvac
./var/local/lib/afm/icons/hvac


qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls
bin  config.xml  etc  htdocs  icon.png	lib  var
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls bin
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls etc  
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls htdocs/
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls lib    
libafm-hvac-binding.so
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# ls var
qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-hvac" version="1.0">
	<name>agl-service-hvac</name>
	<icon src="icon.png"/>
	<content src="lib/libafm-hvac-binding.so" type="application/vnd.agl.service"/>
	<description>Binding for HVAC interface</description>
	<author> &lt;&gt;</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="required" />
		<param name="urn:AGL:permission::public:no-htdocs" value="required" />
		<param name="urn:AGL:permission::system:run-by-default" value="required" />
		<param name="urn:AGL:permission::platform:can:write" value="required" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="HVAC" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-api">
		<param name="identity" value="ws" />
		<param name="low-can" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/libafm-hvac-binding.so" value="local" />
	</feature>
</widget>

qemux86-64:/var/local/lib/afm/applications/hvac# ls
bin  config.xml  icon.svg  translations
qemux86-64:/var/local/lib/afm/applications/hvac# ls bin
hvac
qemux86-64:/var/local/lib/afm/applications/hvac# ls translations/
hvac_fr_FR.qm  hvac_ja_JP.qm
qemux86-64:/var/local/lib/afm/applications/hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="hvac" version="0.1">
  <name>HVAC</name>
  <icon src="icon.svg"/>
  <content src="bin/hvac" type="application/vnd.agl.native"/>
  <description>This is a demo application used to control and dialog with HVAC system</description>
  <author>Romain Forlot &lt;romain.forlot@iot.bzh&gt;</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="HVAC" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>


  -------------> nachbilden !
  
  Vorgehen: 1.) agl-service-motalk installieren und starten 
  
  Oct 18 11:46:33 qemux86-64 afm-system-daemon[300]:  NOTICE: -- INSTALLING widget /home/agl-service-motalk.wgt to /var/local/lib/afm/applications -- [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/wgtpkg-install.c:674]
Oct 18 11:46:33 qemux86-64 afbd-homescreen[844]: WebSocket Text Received:  "[5,\"afm-main/application-list-changed\",{\"event\":\"afm-main/application-list-changed\",\"data\":{\"event\":\"afm-main/application-list-changed\",\"data\":{\"operation\":\"install\",\"data\":\"agl-service-motalk\"},\"jtype\":\"afb-event\"},\"jtype\":\"afb-event\"}]"
Oct 18 11:46:33 qemux86-64 afbd-homescreen[844]: MasterVolume::onClientEventReceived[ "afm-main/application-list-changed" ]:  QJsonValue(object, QJsonObject({"data":{"data":"agl-service-motalk","operation":"install"},"event":"afm-main/application-list-changed","jtype":"afb-event"}))
Oct 18 11:46:49 qemux86-64 systemd[1]: Created slice system-afm\x2dapi\x2dmotalk2021.slice.
Oct 18 11:46:49 qemux86-64 systemd[1]: Listening on Provides websocket api motalk2021 for user 0.
Oct 18 11:46:49 qemux86-64 systemd[1]: Starting Binding for motalk interface...
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: ------BEGIN OF CONFIG-----
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: -- {
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "name": "afbd-agl-service-motalk",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "rootdir": "/var/local/lib/afm/applications/agl-service-motalk",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "workdir": "/home/0/app-data/agl-service-motalk",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "monitoring": true,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "port": 30044,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "interface": [
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --      "tcp:localuser--44:8080"
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    ],
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "roothttp": ".",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "binding": [
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --      "/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding.so"
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    ],
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "ws-server": [
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --      "sd:motalk2021"
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    ],
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "apitimeout": 20,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "cache-eol": 100000,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "cntxtimeout": 32000000,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "session-max": 200,
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "uploaddir": ".",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "rootbase": "/opa",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "rootapi": "/api",
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "ldpaths": [
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --      "/usr/lib/afb"
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    ],
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    "alias": [
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --    ]
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: --  }
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]: ------END OF CONFIG-----
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]:  INFO: running with pid 1221 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-supervision.c:165,try_connect_supervisor]
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]:  ERROR: binding [/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding.so] not loadable: /var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding.so: invalid ELF header [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:97,load_binding]
Oct 18 11:46:49 qemux86-64 afbd-agl-service-motalk[1221]:  ERROR: can't start the binding /var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding.so [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:178,apiset_start_list]
Oct 18 11:46:49 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@0.service: Main process exited, code=exited, status=1/FAILURE
Oct 18 11:46:49 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@0.service: Failed with result 'exit-code'.
Oct 18 11:46:49 qemux86-64 systemd[1]: Failed to start Binding for motalk interface.
Oct 18 11:46:49 qemux86-64 afm-system-daemon[300]:  ERROR: start error system unit afm-service-agl-service-motalk--1.0--main@.service for uid 0: failed [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/afm-urun.c:280]
Oct 18 11:50:35 qemux86-64 systemd[1]: afm-api-motalk2021@1001.socket: Failed with result 'service-start-limit-hit'.

unreadable ELF-header ?!
qemux86-64:/home# ls -ll /var/local/lib/afm/applications/agl-service-motalk/lib/
total 132
-rw-r--r--. 1 root root 133792 Oct 18 11:46 motalk_reawi_binding.so
qemux86-64:/home# chmod 777 -R /var/local/lib/afm/applications/agl-service-motalk/lib/


angbelich elf not readable fehler weil für anderes OS gebuildet, Gegentest mit altem Motalk-Binding war erfolgreich
Oct 18 13:10:18 qemux86-64 afm-system-daemon[300]:  NOTICE: -- INSTALLING widget /home/agl-service-motalk.wgt to /var/local/lib/afm/applications -- [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/wgtpkg-install.c:674]
Oct 18 13:10:18 qemux86-64 systemd[1]: afm-api-motalk2021@0.socket: Socket unit configuration has changed while unit has been running, no open socket file descriptor left. The socket unit is not functional until restarted.
Oct 18 13:10:18 qemux86-64 afbd-homescreen[844]: WebSocket Text Received:  "[5,\"afm-main/application-list-changed\",{\"event\":\"afm-main/application-list-changed\",\"data\":{\"event\":\"afm-main/application-list-changed\",\"data\":{\"operation\":\"install\",\"data\":\"agl-service-motalk\"},\"jtype\":\"afb-event\"},\"jtype\":\"afb-event\"}]"
Oct 18 13:10:18 qemux86-64 afbd-homescreen[844]: MasterVolume::onClientEventReceived[ "afm-main/application-list-changed" ]:  QJsonValue(object, QJsonObject({"data":{"data":"agl-service-motalk","operation":"install"},"event":"afm-main/application-list-changed","jtype":"afb-event"}))
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: ------BEGIN OF CONFIG-----
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: -- {
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "name": "afbd-agl-service-motalk",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "rootdir": "/var/local/lib/afm/applications/agl-service-motalk",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "workdir": "/home/0/app-data/agl-service-motalk",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "monitoring": true,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "port": 30046,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "interface": [
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --      "tcp:localuser--46:8080"
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    ],
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "roothttp": ".",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "binding": [
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --      "/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_binding.so"
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    ],
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "ws-server": [
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --      "sd:helloworld"
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    ],
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "apitimeout": 20,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "cache-eol": 100000,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "cntxtimeout": 32000000,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "session-max": 200,
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "uploaddir": ".",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "rootbase": "/opa",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "rootapi": "/api",
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "ldpaths": [
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --      "/usr/lib/afb"
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    ],
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    "alias": [
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --    ]
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: --  }
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]: ------END OF CONFIG-----
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]:  INFO: running with pid 1765 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-supervision.c:165,try_connect_supervisor]
Oct 18 13:11:17 qemux86-64 afbd-agl-service-motalk[1765]:  INFO: binding [/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_binding.so] looks like an AFB binding V3 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so-v3.c:84,afb_api_so_v3_add]


---> Fehler bleibt bei Neuinstallation mit reawi_binding, aber jetzt behoben nach erneutem build auf tessitzung.

Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: can't open server socket for tcp:*:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]
Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: can't create socket tcp:*:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:538,hsrv_itf_connect]
Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: setting interface failed [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:412,start_http_server]
Oct 18 15:34:17 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@1001.service: Main process exited, code=exited, status=1/FAILURE
Oct 18 15:34:17 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@1001.service: Failed with result 'exit-code'.
Oct 18 15:34:17 qemux86-64 systemd[1]: Failed to start Binding for motalk interface.
Oct 18 15:34:17 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@1001.service: Start request repeated too quickly.
Oct 18 15:34:17 qemux86-64 systemd[1]: afm-service-agl-service-motalk--1.0--main@1001.service: Failed with result 'exit-code'.
Oct 18 15:34:17 qemux86-64 systemd[1]: Failed to start Binding for motalk interface.
Oct 18 15:34:17 qemux86-64 systemd[1]: afm-api-motalk2021@1001.socket: Failed with result 'service-start-limit-hit'.


Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: can't open server socket for tcp:*:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_o>
Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: can't create socket tcp:*:30044 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:538,hsrv_itf_connect]
Oct 18 15:34:17 qemux86-64 afbd-agl-service-motalk[1475]:  ERROR: setting interface failed [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:412,start_http_server]


App selbst klappt nicht:
Oct 18 15:37:32 qemux86-64 afbd-motalk[1488]:  ERROR: can't launch /var/local/lib/afm/applications/motalk/bin/motalk: Exec format error [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:622,execute_command]
------------------------> wahrscheinlich auch ein Fehler beim Build in Testsitzung mit .pri oder .pro file!


cloud@Cloud-Lab:~/agl$ $CC --version
x86_64-agl-linux-gcc (GCC) 9.3.0

QEMU:
qemux86-64:~# uname -a
Linux qemux86-64 5.4.69-yocto-standard #1 SMP PREEMPT Mon Jun 29 03:06:40 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux


MIt reihenfolge 1.) agl-motalk installieren udn starten, dann motalk.wgt installieren und starten läuft es, aber ein Fehler taucht auf:
( Fehler ist geblieben!)  --> Fehler behoben durch aktualisiertes SingleKEy.qml File


Apps laufen aber ConnectedState klappt nocht nicht --> Ports checken!

test: verändern port bei afm-service-agl-service-motalk--1.0--main@.service auf beide ports auf =1234 geändert 

qemux86-64:/var/local/lib/systemd/system# netstat -tuln
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN      

"ps -ef" shows 
root        1720       1  0 21:10 ?        00:00:00 afbd-agl-service-motalk                                                                                                                            
root        1728       1  0 21:10 ?        00:00:00 afbdmotalk                                                                                                                                        
root        1729    1728  0 21:10 ?        00:00:01 /var/local/lib/afm/applications/motalk/bin/motalk 30046 @t

--> PID: 1720, 1728, 1729

Oct 20 21:26:45 qemux86-64 afbd-motalk[1775]:  ERROR: can't open server socket for tcp:*:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]


bedeutet bei afm-appli-motalk..service ist eins server-port und client-port
Fehlermeldung:
Oct 20 21:37:29 qemux86-64 audit[9]: AVC lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" requested=w pid=9 comm="ksoftirqd/0" saddr
=127.0.0.1 src=53642 daddr=127.0.0.1 dest=1234 netif=lo
Oct 20 21:37:29 qemux86-64 audit[1875]: AVC lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" requested=w pid=1875 comm="motalk" sadd
r=127.0.0.1 src=53644 daddr=127.0.0.1 dest=1234 netif=lo
Oct 20 21:37:29 qemux86-64 kernel: audit: type=1400 audit(1634765849.927:46): lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" reque
sted=w pid=9 comm="ksoftirqd/0" saddr=127.0.0.1 src=53642 daddr=127.0.0.1 dest=1234 netif=lo
Oct 20 21:37:29 qemux86-64 kernel: audit: type=1400 audit(1634765849.930:47): lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" reque
sted=w pid=1875 comm="motalk" saddr=127.0.0.1 src=53644 daddr=127.0.0.1 dest=1234 netif=lo
Oct 20 21:37:30 qemux86-64 audit[0]: AVC lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" requested=w pid=0 comm="swapper/0" saddr=1
27.0.0.1 src=53644 daddr=127.0.0.1 dest=1234 netif=lo
Oct 20 21:37:30 qemux86-64 afbd-motalk[1875]: QNativeSocketEngine::write() was not called in QAbstractSocket::ConnectedState
Oct 20 21:37:30 qemux86-64 kernel: audit: type=1400 audit(1634765850.951:48): lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" reque
sted=w pid=0 comm="swapper/0" saddr=127.0.0.1 src=53644 daddr=127.0.0.1 dest=1234 netif=lo

vielleicht fehlt mir auch die Token-Eingabe bei beiden, es steht ja @p und @t ?!
nach port-Änderung immer systemctl daemon-reload ausführen vor restart!

Anscheinend: X-AFM-http-port=1234 ist möglich aber --port darf nicht auf 1234 sein, sonst startet programm nicht.  jetzt token @ checken

jetzt evtl agl-service genau andersherum einstellen mit source und port !! --> klappt nicht, noch einmal testen mit token+port manuell feststellen


--> wenn ich /var/local/lib/afm/applications/agl-service-motalk/lib# afb-daemon --binding ./motalk_reawi_binding2.so --port 1234 &  
ausführe, klappt die Kommunikation!! 

klappt auch mit afb-daemon --binding ./motalk_reawi_binding2.so --port 1234 --token 123456 &  und anderen tokens
hierzu netstat:
qemux86-64:/var/local/lib/afm/applications/agl-service-motalk/lib# netstat -tuln | grep 1234
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN      

von dort weitermachen und agl debuggen  
-------------->>> scheint so, dass port bei motalk.service komplett egal ist

das agl-service-motalk reagiert auf qemux86-64:/var/local/lib/systemd/system# afb-client-demo --human 'localhost:1234/api?token=' motalk2021 rewr 

qemux86-64:/var/local/lib/systemd/system# ps -ef | grep motalk
root        2333       1  0 09:06 ?        00:00:00 afbd-agl-service-motalk        

qemux86-64:/var/local/lib/systemd/system# netstat -tuln | grep 1234
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN

qemux86-64:/proc/2333# grep -r motalk    
task/2333/net/unix:00000000be962f60: 00000002 00000000 00010000 0001 01 109632 /run/user/0/apis/ws/motalk2021
Binary file task/2333/environ matches
Binary file task/2333/cmdline matches
task/2333/maps:7f429ac9e000-7f429aca0000 r-xp 00000000 fd:00 129790                     /var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding2.so

qemux86-64:/proc/2333# ls -ll /run/user/0/apis/ws/           
total 0
lrwxrwxrwx. 1 root root 39 Oct 19 08:57 Bluetooth-Manager -> /run/platform/apis/ws/Bluetooth-Manager
srw-rw-rw-. 1 root root  0 Oct 19 08:57 HVAC
lrwxrwxrwx. 1 root root 30 Oct 19 08:57 afm-main -> /run/platform/apis/ws/afm-main
srw-rw-rw-. 1 root root  0 Oct 19 08:57 audiomixer
srw-rw-rw-. 1 root root  0 Oct 19 08:57 bluetooth-map
srw-rw-rw-. 1 root root  0 Oct 19 08:57 bluetooth-pbap
srw-rw-rw-. 1 root root  0 Oct 19 08:57 cloudproxy
lrwxrwxrwx. 1 root root 25 Oct 19 08:57 gps -> /run/platform/apis/ws/gps
srw-rw-rw-. 1 root root  0 Oct 19 08:57 homescreen
srw-rw-rw-. 1 root root  0 Oct 19 08:57 identity
lrwxrwxrwx. 1 root root 29 Oct 19 08:57 low-can -> /run/platform/apis/ws/low-can
srw-rw-rw-. 1 root root  0 Oct 19 08:57 mediascanner
srw-rw-rw-. 1 root root  0 Oct 21 09:05 motalk2021
lrwxrwxrwx. 1 root root 37 Oct 19 08:57 network-manager -> /run/platform/apis/ws/network-manager
srw-rw-rw-. 1 root root  0 Oct 19 08:57 nfc
lrwxrwxrwx. 1 root root 33 Oct 19 08:57 persistence -> /run/platform/apis/ws/persistence
srw-rw-rw-. 1 root root  0 Oct 19 08:57 radio
srw-rw-rw-. 1 root root  0 Oct 19 08:57 signal-composer
srw-rw-rw-. 1 root root  0 Oct 19 08:57 vshl-core
lrwxrwxrwx. 1 root root 29 Oct 19 08:57 weather -> /run/platform/apis/ws/weather


qemux86-64:/var/local/lib/systemd/system# cat afm-service-agl-service-motalk--1.0--main@.service
# auto generated by wgtpkg-unit for agl-service-motalk version 1.0 target main of agl-service-motalk

[Unit]
Description=Binding for motalk interface
X-AFM-description=Binding for motalk interface
X-AFM-name=agl-service-motalk
X-AFM-shortname=
X-AFM-id=agl-service-motalk
X-AFM-version=1.0
X-AFM-author= Roland Endero
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/agl-service-motalk/icon.png
X-AFM--ID=45
X-AFM--target-name=main
X-AFM--content=lib/motalk_reawi_binding2.so
X-AFM--type=application/vnd.agl.service
X-AFM--wgtdir=/var/local/lib/afm/applications/agl-service-motalk
X-AFM--workdir=/home/%i/app-data/agl-service-motalk
X-AFM--visibility=hidden

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/agl-service-motalk/*
SmackProcessLabel=User::App::agl-service-motalk
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/agl-service-motalk
ExecStartPre=/bin/mkdir -p /home/%i/app-data/agl-service-motalk
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SystemCallFilter=~@clock

Environment=AFM_ID=agl-service-motalk
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/agl-service-motalk
Environment=AFM_WORKDIR=/home/%i/app-data/agl-service-motalk
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/agl-service-motalk/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/agl-service-motalk/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_CONFIG_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_CACHE_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/agl-service-motalk.env
SyslogIdentifier=afbd-agl-service-motalk
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=1234
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-motalk \
	--rootdir=/var/local/lib/afm/applications/agl-service-motalk \
	--workdir=/home/%i/app-data/agl-service-motalk \
	--verbose \
	--verbose \
	--monitoring \
	--port=1234 \
	--interface=tcp:localuser--45:8080 \
	--roothttp=. \
		--binding=/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding2.so \
		--ws-server=sd:motalk2021 \
	

[Install]
WantedBy=afm-user-session@.target


Portchanges werden evtl erst wirksam nach kill -9 $(PID)  des agl-service-motalk oder motalk.

Klappt alles nicht, als nächstes an funktionierendem Beispiel orientieren und alles aufzeichnen --> Beispiel hvac ?!

1.) hvac service:
qemux86-64:/var/local/lib/systemd/system# cat afm-service-agl-service-hvac--1.0--main@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac

[Unit]
Description=Binding for HVAC interface
X-AFM-description=Binding for HVAC interface
X-AFM-name=agl-service-hvac
X-AFM-shortname=
X-AFM-id=agl-service-hvac
X-AFM-version=1.0
X-AFM-author= <>
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/agl-service-hvac/icon.png
X-AFM--ID=13
X-AFM--target-name=main
X-AFM--content=lib/libafm-hvac-binding.so
X-AFM--type=application/vnd.agl.service
X-AFM--wgtdir=/var/local/lib/afm/applications/agl-service-hvac
X-AFM--workdir=/home/%i/app-data/agl-service-hvac
X-AFM--visibility=hidden

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-identity@%i.service
After=afm-api-identity@%i.service
Requires=afm-api-low-can@%i.service
After=afm-api-low-can@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/agl-service-hvac/*
SmackProcessLabel=User::App::agl-service-hvac
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/agl-service-hvac
ExecStartPre=/bin/mkdir -p /home/%i/app-data/agl-service-hvac
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SystemCallFilter=~@clock

Environment=AFM_ID=agl-service-hvac
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/agl-service-hvac
Environment=AFM_WORKDIR=/home/%i/app-data/agl-service-hvac
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/agl-service-hvac/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/agl-service-hvac/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CONFIG_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_CACHE_HOME=/home/%i/app-data/agl-service-hvac
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/agl-service-hvac.env
SyslogIdentifier=afbd-agl-service-hvac
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30013
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-hvac \
	--rootdir=/var/local/lib/afm/applications/agl-service-hvac \
	--workdir=/home/%i/app-data/agl-service-hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30013 \
	--interface=tcp:localuser--13:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/identity \
		--ws-client=unix:/run/user/%i/apis/ws/low-can \
		--binding=/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so \
		--ws-server=sd:HVAC \
	

[Install]
WantedBy=afm-user-session@.target

Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: ------BEGIN OF CONFIG-----
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: -- {
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "name": "afbd-agl-service-hvac",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "rootdir": "/var/local/lib/afm/applications/agl-service-hvac",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "workdir": "/home/1001/app-data/agl-service-hvac",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "monitoring": true,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "port": 30013,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "interface": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "tcp:localuser--13:8080"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ],
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "roothttp": ".",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "ws-client": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "unix:/run/user/1001/apis/ws/identity",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "unix:/run/user/1001/apis/ws/low-can"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ],
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "binding": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ],
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "ws-server": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "sd:HVAC"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ],
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "apitimeout": 20,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "cache-eol": 100000,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "cntxtimeout": 32000000,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "session-max": 200,
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "uploaddir": ".",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "rootbase": "/opa",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "rootapi": "/api",
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "ldpaths": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "/usr/lib/afb"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ],
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    "alias": [
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --    ]
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: --  }
Oct 21 11:59:26 qemux86-64 afbd-agl-service-hvac[487]: ------END OF CONFIG-----


Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: ------BEGIN OF CONFIG-----
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: -- {
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "name": "afbd-hvac",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "rootdir": "/var/local/lib/afm/applications/hvac",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "workdir": "/home/1001/app-data/hvac",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "monitoring": true,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "port": 30033,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "interface": [
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "tcp:localuser--33:8080"
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    ],
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "roothttp": ".",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "ws-client": [
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "unix:/run/user/1001/apis/ws/HVAC"
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    ],
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "exec": [
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "/var/local/lib/afm/applications/hvac/bin/hvac",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "@p",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "@t"
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    ],
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "apitimeout": 20,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "cache-eol": 100000,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "cntxtimeout": 32000000,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "session-max": 200,
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "uploaddir": ".",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "rootbase": "/opa",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "rootapi": "/api",
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "ldpaths": [
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "/usr/lib/afb"
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    ],
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    "alias": [
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --    ]
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: --  }
Oct 21 11:59:41 qemux86-64 afbd-hvac[617]: ------END OF CONFIG-----

Oct 21 11:59:41 qemux86-64 afbd-hvac[618]: setting port: 30033 , token: "@t"
Oct 21 11:59:42 qemux86-64 afbd-hvac[618]: #### "/home/1001/app-data/hvac" "/var/local/lib/afm/applications/hvac/bin"
Oct 21 11:59:42 qemux86-64 afbd-hvac[618]: qrc:/HVAC.qml:46:9: Unable to assign [undefined] to double
Oct 21 11:59:42 qemux86-64 afbd-hvac[618]: qml: Right Temp changed 15
Oct 21 11:59:42 qemux86-64 afbd-hvac[618]: qml: Left Temp changed 1


qemux86-64:/var/local/lib/systemd/system# netstat -tuln | grep 30013
tcp        0      0 0.0.0.0:30013           0.0.0.0:*               LISTEN

qemux86-64:~# ps -ef | grep hvac
agl-dri+     487       1  0 11:59 ?        00:00:00 afbd-agl-service-hvac                                                                                                                                                                                                                                                                                                                                                                                                                                              
agl-dri+     617       1  0 11:59 ?        00:00:00 afbd-hvac                                                                                                                                                                                                                                                                                                                   
agl-dri+     618     617  1 11:59 ?        00:00:01 /var/local/lib/afm/applications/hvac/bin/hvac 30033 @t

qemux86-64:/# cat etc/smack/accesses.d/pkg_agl-service-hvac
qemux86-64:/# cat etc/smack/accesses.d/app_agl-service-hvac
System User::App::agl-service-hvac rwxa--
System User::Pkg::agl-service-hvac rwxat-
User::App::agl-service-hvac System -wx---
User::App::agl-service-hvac System::Shared r-x---
User::App::agl-service-hvac System::Run rwxat-
User::App::agl-service-hvac System::Log rwxa--
User::App::agl-service-hvac _ -----l
User::App::agl-service-hvac User::Home r-x--l
User::App::agl-service-hvac User::App-Shared rwxat-
User::App::agl-service-hvac User::Pkg::agl-service-hvac rwxat-
User::App::agl-service-hvac System::Weston rw----
User::App::agl-service-hvac System::Pipewire rw----
System::Weston User::App::agl-service-hvac rw----

qemux86-64:/var/local/lib/systemd/system# ls -ll | grep hvac
-rw-r--r--. 1 root root 2462 Oct 19 08:43 afm-appli-hvac--0.1--main@.service
-rw-r--r--. 1 root root 2850 Oct 19 08:43 afm-service-agl-service-hvac--1.0--main@.service
qemux86-64:/var/local/lib/systemd/system# ls -ll | grep HVAC
-rw-r--r--. 1 root root  355 Oct 19 08:43 afm-api-HVAC@.service
-rw-r--r--. 1 root root  435 Oct 19 08:43 afm-api-HVAC@.socket

qemux86-64:/var/local/lib/systemd/system# cat afm-appli-hvac--0.1--main@.service 
# auto generated by wgtpkg-unit for hvac version 0.1 target main of hvac

[Unit]
Description=This is a demo application used to control and dialog with HVAC system
X-AFM-description=This is a demo application used to control and dialog with HVAC system
X-AFM-name=HVAC
X-AFM-shortname=
X-AFM-id=hvac
X-AFM-version=0.1
X-AFM-author=Romain Forlot <romain.forlot@iot.bzh>
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/hvac/icon.svg
X-AFM--ID=33
X-AFM--target-name=main
X-AFM--content=bin/hvac
X-AFM--type=application/vnd.agl.native
X-AFM--wgtdir=/var/local/lib/afm/applications/hvac
X-AFM--workdir=/home/%i/app-data/hvac
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-HVAC@%i.service
After=afm-api-HVAC@%i.service

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/hvac/*
SmackProcessLabel=User::App::hvac
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/hvac
ExecStartPre=/bin/mkdir -p /home/%i/app-data/hvac
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SystemCallFilter=~@clock

Environment=AFM_ID=hvac
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/hvac
Environment=AFM_WORKDIR=/home/%i/app-data/hvac
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/hvac/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/hvac/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/hvac
Environment=XDG_CONFIG_HOME=/home/%i/app-data/hvac
Environment=XDG_CACHE_HOME=/home/%i/app-data/hvac
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/hvac.env
SyslogIdentifier=afbd-hvac
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30033
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-hvac \
	--rootdir=/var/local/lib/afm/applications/hvac \
	--workdir=/home/%i/app-data/hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30033 \
	--interface=tcp:localuser--33:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/HVAC \
	--exec /var/local/lib/afm/applications/hvac/bin/hvac @p @t

qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.service 
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides api HVAC for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-HVAC@%i.socket
After=afm-api-HVAC@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true
qemux86-64:/var/local/lib/systemd/system# cat afm-api-HVAC@.socket  
# auto generated by wgtpkg-unit for agl-service-hvac version 1.0 target main of agl-service-hvac
[Unit]
Description=Provides websocket api HVAC for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/HVAC
FileDescriptorName=HVAC
Service=afm-service-agl-service-hvac--1.0--main@%i.service

qemux86-64:/var/local/lib/systemd/system# ls -ll /run/user/1001/apis/ws/     
total 0
lrwxrwxrwx. 1 root root 39 Oct 21 11:59 Bluetooth-Manager -> /run/platform/apis/ws/Bluetooth-Manager
srw-rw-rw-. 1 root root  0 Oct 21 11:59 HVAC
lrwxrwxrwx. 1 root root 30 Oct 21 11:59 afm-main -> /run/platform/apis/ws/afm-main
srw-rw-rw-. 1 root root  0 Oct 21 11:59 audiomixer
srw-rw-rw-. 1 root root  0 Oct 21 11:59 bluetooth-map
srw-rw-rw-. 1 root root  0 Oct 21 11:59 bluetooth-pbap
srw-rw-rw-. 1 root root  0 Oct 21 11:59 cloudproxy
lrwxrwxrwx. 1 root root 25 Oct 21 11:59 gps -> /run/platform/apis/ws/gps
srw-rw-rw-. 1 root root  0 Oct 21 11:59 homescreen
srw-rw-rw-. 1 root root  0 Oct 21 11:59 identity
lrwxrwxrwx. 1 root root 29 Oct 21 11:59 low-can -> /run/platform/apis/ws/low-can
srw-rw-rw-. 1 root root  0 Oct 21 11:59 mediascanner
srw-rw-rw-. 1 root root  0 Oct 21 11:59 motalk2021
lrwxrwxrwx. 1 root root 37 Oct 21 11:59 network-manager -> /run/platform/apis/ws/network-manager
srw-rw-rw-. 1 root root  0 Oct 21 11:59 nfc
lrwxrwxrwx. 1 root root 33 Oct 21 11:59 persistence -> /run/platform/apis/ws/persistence
srw-rw-rw-. 1 root root  0 Oct 21 11:59 radio
srw-rw-rw-. 1 root root  0 Oct 21 11:59 signal-composer
srw-rw-rw-. 1 root root  0 Oct 21 11:59 vshl-core
lrwxrwxrwx. 1 root root 29 Oct 21 11:59 weather -> /run/platform/apis/ws/weather

qemux86-64:/var/local/lib/systemd/system# cat /var/local/lib/afm/applications/agl-service-hvac/config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-hvac" version="1.0">
	<name>agl-service-hvac</name>
	<icon src="icon.png"/>
	<content src="lib/libafm-hvac-binding.so" type="application/vnd.agl.service"/>
	<description>Binding for HVAC interface</description>
	<author> &lt;&gt;</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="required" />
		<param name="urn:AGL:permission::public:no-htdocs" value="required" />
		<param name="urn:AGL:permission::system:run-by-default" value="required" />
		<param name="urn:AGL:permission::platform:can:write" value="required" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="HVAC" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-api">
		<param name="identity" value="ws" />
		<param name="low-can" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/libafm-hvac-binding.so" value="local" />
	</feature>
</widget>
qemux86-64:/var/local/lib/systemd/system# 

qemux86-64:/var/local/lib/systemd/system# cat /var/local/lib/afm/applications/hvac/config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="hvac" version="0.1">
  <name>HVAC</name>
  <icon src="icon.svg"/>
  <content src="bin/hvac" type="application/vnd.agl.native"/>
  <description>This is a demo application used to control and dialog with HVAC system</description>
  <author>Romain Forlot &lt;romain.forlot@iot.bzh&gt;</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="HVAC" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>

qemux86-64:/var/local/lib/systemd/system# ls -ll /var/local/lib/afm/applications/ | grep hvac
drwxr-xr-x  7 root root 4096 Oct 19 08:43 agl-service-hvac
drwxr-xr-x  4 root root 4096 Oct 19 08:43 hvac

qemux86-64:/home# ps -ef | grep motalk
root         675       1  0 12:44 ?        00:00:00 afbd-agl-service-motalk                                                                                                                                                                                                                                                                                                                                                        
root         974     593  0 12:46 ttyS1    00:00:00 grep motalk
qemux86-64:/home# netstat -tuln | grep 30044
tcp        0      0 0.0.0.0:30044           0.0.0.0:*               LISTEN  

qemux86-64:/home# systemctl status afm-service-agl-service-motalk--1.0--main@0.service
* afm-service-agl-service-motalk--1.0--main@0.service - Binding for motalk interface
     Loaded: loaded (/usr/local/lib/systemd/system/afm-service-agl-service-motalk--1.0--main@.service; disabled; vendor preset: disabled)
     Active: active (running) since Thu 2021-10-21 12:44:32 UTC; 1min 2s ago
TriggeredBy: * afm-api-motalk2021@0.socket
    Process: 666 ExecStartPre=/bin/mkdir -p /home/0/app-data/agl-service-motalk (code=exited, status=0/SUCCESS)
   Main PID: 675 (afbd-agl-servic)
      Tasks: 1 (limit: 2385)
     Memory: 984.0K
     CGroup: /user.slice/user-0.slice/afm-service-agl-service-motalk--1.0--main@0.service
             `-675 afbd-agl-service-motalk

Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: ------BEGIN OF CONFIG-----
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: -- {
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "name": "afbd-agl-service-motalk",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "rootdir": "/var/local/lib/afm/applications/agl-service-motalk",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "workdir": "/home/0/app-data/agl-service-motalk",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "monitoring": true,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "port": 30044,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "interface": [
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --      "tcp:localuser--44:8080"
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    ],
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "roothttp": ".",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "binding": [
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --      "/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding2.so"
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    ],
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "ws-server": [
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --      "sd:motalk2021"
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    ],
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "apitimeout": 20,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "cache-eol": 100000,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "cntxtimeout": 32000000,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "session-max": 200,
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "uploaddir": ".",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "rootbase": "/opa",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "rootapi": "/api",
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "ldpaths": [
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --      "/usr/lib/afb"
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    ],
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    "alias": [
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --    ]
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: --  }
Oct 21 12:44:32 qemux86-64 afbd-agl-service-motalk[675]: ------END OF CONFIG-----

qemux86-64:/home# cat /var/local/lib/afm/applications/agl-service-motalk/config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-motalk" version="1.0">
	<name>agl-service-motalk</name>
	<icon src="icon.png"/>
	<content src="lib/motalk_reawi_binding2.so" type="application/vnd.agl.service"/>
	<description>Binding for motalk interface</description>
	<author> Roland Endero</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="optional" />
		<param name="urn:AGL:permission::public:no-htdocs" value="optional" />
		<param name="urn:AGL:permission::system:run-by-default" value="optional" />
		<param name="urn:AGL:permission::platform:can:write" value="optional" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="motalk2021" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/motalk_reawi_binding2.so" value="local" />
	</feature>
</widget>

Oct 21 12:54:44 qemux86-64 systemd[1]: Starting Provides api motalk2021 for user 0...
Oct 21 12:54:44 qemux86-64 systemd[1]: Started Provides api motalk2021 for user 0.
Oct 21 12:54:44 qemux86-64 systemd[1]: Starting This is a demo application used for motalk...
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: ------BEGIN OF CONFIG-----
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: -- {
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "name": "afbd-motalk",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "rootdir": "/var/local/lib/afm/applications/motalk",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "workdir": "/home/0/app-data/motalk",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "monitoring": true,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "port": 30046,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "interface": [
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "tcp:localuser--46:8080"
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    ],
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "roothttp": ".",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "ws-client": [
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "unix:/run/user/0/apis/ws/motalk2021"
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    ],
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "exec": [
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "/var/local/lib/afm/applications/motalk/bin/motalk",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "@p",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "@t"
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    ],
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "apitimeout": 20,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "cache-eol": 100000,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "cntxtimeout": 32000000,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "session-max": 200,
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "uploaddir": ".",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "rootbase": "/opa",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "rootapi": "/api",
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "ldpaths": [
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "/usr/lib/afb"
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    ],
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    "alias": [
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --      "/monitoring:/usr/lib/afb/monitoring"
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --    ]
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: --  }
Oct 21 12:54:44 qemux86-64 afbd-motalk[1026]: ------END OF CONFIG-----

qemux86-64:/# cat /etc/smack/accesses.d/app_agl-service-motalk
System User::App::agl-service-motalk rwxa--
System User::Pkg::agl-service-motalk rwxat-
User::App::agl-service-motalk System -wx---
User::App::agl-service-motalk System::Shared r-x---
User::App::agl-service-motalk System::Run rwxat-
User::App::agl-service-motalk System::Log rwxa--
User::App::agl-service-motalk _ -----l
User::App::agl-service-motalk User::Home r-x--l
User::App::agl-service-motalk User::App-Shared rwxat-
User::App::agl-service-motalk User::Pkg::agl-service-motalk rwxat-
User::App::agl-service-motalk System::Weston rw----
User::App::agl-service-motalk System::Pipewire rw----
System::Weston User::App::agl-service-motalk rw----
qemux86-64:/# cat /etc/smack/accesses.d/pkg_agl-service-motalk
qemux86-64:/# cat /etc/smack/accesses.d/app_motalk
System User::App::motalk rwxa--
System User::Pkg::motalk rwxat-
User::App::motalk System -wx---
User::App::motalk System::Shared r-x---
User::App::motalk System::Run rwxat-
User::App::motalk System::Log rwxa--
User::App::motalk _ -----l
User::App::motalk User::Home r-x--l
User::App::motalk User::App-Shared rwxat-
User::App::motalk User::Pkg::motalk rwxat-
User::App::motalk System::Weston rw----
User::App::motalk System::Pipewire rw----
System::Weston User::App::motalk rw----
qemux86-64:/# cat /etc/smack/accesses.d/pkg_motalk

qemux86-64:/var/local/lib/systemd/system# ls -ll | grep motalk
-rw-r--r--. 1 root root  377 Oct 21 12:44 afm-api-motalk2021@.service
-rw-r--r--. 1 root root  459 Oct 21 12:44 afm-api-motalk2021@.socket
-rw-r--r--. 1 root root 2455 Oct 21 12:54 afm-appli-motalk--0.1--main@.service
-rw-r--r--. 1 root root 2456 Oct 21 11:13 afm-appli-motalk--0.1--main@.service~
-rw-r--r--. 1 root root 2696 Oct 21 12:44 afm-service-agl-service-motalk--1.0--main@.service
-rw-r--r--. 1 root root 2696 Oct 21 09:49 afm-service-agl-service-motalk--1.0--main@.service~

qemux86-64:/var/local/lib/systemd/system# cat /var/local/lib/afm/applications/motalk/config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="motalk" version="0.1">
  <name>motalk</name>
  <icon src="icon.svg"/>
  <content src="bin/motalk" type="application/vnd.agl.native"/>
  <description>This is a demo application used for motalk</description>
  <author>Rolando Endero</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="motalk2021" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>

qemux86-64:/var/local/lib/systemd/system# cat afm-api-motalk2021@.service 
# auto generated by wgtpkg-unit for agl-service-motalk version 1.0 target main of agl-service-motalk
[Unit]
Description=Provides api motalk2021 for user %i
X-AFM-API-TYPE=ws
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true
qemux86-64:/var/local/lib/systemd/system# cat afm-api-motalk2021@.socket  
# auto generated by wgtpkg-unit for agl-service-motalk version 1.0 target main of agl-service-motalk
[Unit]
Description=Provides websocket api motalk2021 for user %i
Requires=afm-user-setup@%i.service
After=afm-user-setup@%i.service
DefaultDependencies=no
[Socket]
SmackLabel=*
SmackLabelIPIn=System
SmackLabelIPOut=System
ListenStream=/run/user/%i/apis/ws/motalk2021
FileDescriptorName=motalk2021
Service=afm-service-agl-service-motalk--1.0--main@%i.service

qemux86-64:/var/local/lib/systemd/system# cat afm-appli-motalk--0.1--main@.service
# auto generated by wgtpkg-unit for motalk version 0.1 target main of motalk

[Unit]
Description=This is a demo application used for motalk
X-AFM-description=This is a demo application used for motalk
X-AFM-name=motalk
X-AFM-shortname=
X-AFM-id=motalk
X-AFM-version=0.1
X-AFM-author=Rolando Endero
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/motalk/icon.svg
X-AFM--ID=46
X-AFM--target-name=main
X-AFM--content=bin/motalk
X-AFM--type=application/vnd.agl.native
X-AFM--wgtdir=/var/local/lib/afm/applications/motalk
X-AFM--workdir=/home/%i/app-data/motalk
X-AFM--visibility=visible

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
BindsTo=weston@display.service
After=weston@display.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-motalk2021@%i.service
After=afm-api-motalk2021@%i.service

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/motalk/*
SmackProcessLabel=User::App::motalk
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/motalk
ExecStartPre=/bin/mkdir -p /home/%i/app-data/motalk
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SupplementaryGroups=display
SystemCallFilter=~@clock

Environment=AFM_ID=motalk
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/motalk
Environment=AFM_WORKDIR=/home/%i/app-data/motalk
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/motalk/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/motalk/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/motalk
Environment=XDG_CONFIG_HOME=/home/%i/app-data/motalk
Environment=XDG_CACHE_HOME=/home/%i/app-data/motalk
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/motalk.env
SyslogIdentifier=afbd-motalk
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30046
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-motalk \
	--rootdir=/var/local/lib/afm/applications/motalk \
	--workdir=/home/%i/app-data/motalk \
	--verbose \
	--verbose \
	--monitoring \
	--port=30046 \
	--interface=tcp:localuser--46:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/motalk2021 \
	--exec /var/local/lib/afm/applications/motalk/bin/motalk @p @t


qemux86-64:/var/local/lib/systemd/system# cat afm-service-agl-service-motalk--1.0--main@.service
# auto generated by wgtpkg-unit for agl-service-motalk version 1.0 target main of agl-service-motalk

[Unit]
Description=Binding for motalk interface
X-AFM-description=Binding for motalk interface
X-AFM-name=agl-service-motalk
X-AFM-shortname=
X-AFM-id=agl-service-motalk
X-AFM-version=1.0
X-AFM-author= Roland Endero
X-AFM-author-email=
X-AFM-width=
X-AFM-height=
X-AFM-icon=/var/local/lib/afm/applications/agl-service-motalk/icon.png
X-AFM--ID=44
X-AFM--target-name=main
X-AFM--content=lib/motalk_reawi_binding2.so
X-AFM--type=application/vnd.agl.service
X-AFM--wgtdir=/var/local/lib/afm/applications/agl-service-motalk
X-AFM--workdir=/home/%i/app-data/agl-service-motalk
X-AFM--visibility=hidden

X-AFM--scope=user
Requires=afm-user-session@%i.target
After=user@%i.service
# Adds check to smack
ConditionSecurity=smack

# Automatic bound to required api
Requires=afm-api-motalk2021@%i.socket
After=afm-api-motalk2021@%i.socket

[Service]
EnvironmentFile=-/etc/afm/unit.env.d/*
EnvironmentFile=-/etc/afm/widget.env.d/agl-service-motalk/*
SmackProcessLabel=User::App::agl-service-motalk
SuccessExitStatus=0 SIGKILL
UMask=0077
User=%i
Slice=user-%i.slice
WorkingDirectory=-/home/%i/app-data/agl-service-motalk
ExecStartPre=/bin/mkdir -p /home/%i/app-data/agl-service-motalk
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/%i/bus
CapabilityBoundingSet=
SystemCallFilter=~@clock

Environment=AFM_ID=agl-service-motalk
Environment=AFM_APP_INSTALL_DIR=/var/local/lib/afm/applications/agl-service-motalk
Environment=AFM_WORKDIR=/home/%i/app-data/agl-service-motalk
Environment=AFM_WSAPI_DIR=/run/user/%i/apis/ws
Environment=PATH=/usr/sbin:/usr/bin:/sbin:/bin:/var/local/lib/afm/applications/agl-service-motalk/bin
Environment=LD_LIBRARY_PATH=/var/local/lib/afm/applications/agl-service-motalk/lib
Environment=XDG_DATA_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_CONFIG_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_CACHE_HOME=/home/%i/app-data/agl-service-motalk
Environment=XDG_RUNTIME_DIR=/run/user/%i
EnvironmentFile=-/run/platform/debug/agl-service-motalk.env
SyslogIdentifier=afbd-agl-service-motalk
StandardInput=null
StandardOutput=journal
StandardError=journal
X-AFM-http-port=30044
Type=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-motalk \
	--rootdir=/var/local/lib/afm/applications/agl-service-motalk \
	--workdir=/home/%i/app-data/agl-service-motalk \
	--verbose \
	--verbose \
	--monitoring \
	--port=30044 \
	--interface=tcp:localuser--44:8080 \
	--roothttp=. \
		--binding=/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding2.so \
		--ws-server=sd:motalk2021 \
	

[Install]
WantedBy=afm-user-session@.target


AUSWERTEN alles  hvac <---> motalk !!

to do:  erstmal config motalk-service angleichen --> geschehen ohne Erfolg,  
dann systemclt status für alle anziegen lassen, 

dann user ändern auf 1001 -->  scheint auch nicht zu helfen


qemux86-64:/# systemctl status afm-service-agl-service-motalk--1.0--main@1001.service
● afm-service-agl-service-motalk--1.0--main@1001.service - Binding for motalk interface
     Loaded: loaded (/usr/local/lib/systemd/system/afm-service-agl-service-motalk--1.0--main@.service; disabled; vendor preset: disabled)
     Active: active (running) since Mon 2021-10-25 14:16:04 UTC; 42min ago
TriggeredBy: ● afm-api-motalk2021@1001.socket
    Process: 1650 ExecStartPre=/bin/mkdir -p /home/1001/app-data/agl-service-motalk (code=exited, status=0/SUCCESS)
   Main PID: 1651 (afbd-agl-servic)
      Tasks: 1 (limit: 2385)
     Memory: 980.0K
     CGroup: /user.slice/user-1001.slice/afm-service-agl-service-motalk--1.0--main@1001.service
             └─1651 afbd-agl-service-motalk

Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  NOTICE: API motalk2021 starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  INFO: [API motalk2021] Normally bindingInit
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  [motalk_binding.c:76,bindingInit]
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  INFO: API motalk2021 started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daem>
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/agl-service-motalk uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r>
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  NOTICE: Listening interface *:30047 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  NOTICE: Browser URL= http://localhost:30047 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_>
Oct 25 14:16:04 qemux86-64 afbd-agl-service-motalk[1651]:  NOTICE: Listening interface localuser--47:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connec>
Oct 25 14:16:04 qemux86-64 systemd[1]: Started Binding for motalk interface.


qemux86-64:/# systemctl status fm-appli-motalk--0.1--main@1001.service               
Unit fm-appli-motalk--0.1--main@1001.service could not be found.
qemux86-64:/# systemctl status afm-appli-motalk--0.1--main@1001.service
● afm-appli-motalk--0.1--main@1001.service - This is a demo application used for motalk
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-motalk--0.1--main@.service; static; vendor preset: disabled)
     Active: active (running) since Mon 2021-10-25 14:15:36 UTC; 52min ago
    Process: 1632 ExecStartPre=/bin/mkdir -p /home/1001/app-data/motalk (code=exited, status=0/SUCCESS)
   Main PID: 1633 (afbd-motalk)
      Tasks: 4 (limit: 2385)
     Memory: 79.1M
     CGroup: /user.slice/user-1001.slice/afm-appli-motalk--0.1--main@1001.service
             ├─1633 afbd-motalk 
             └─1635 /var/local/lib/afm/applications/motalk/bin/motalk 30046 @t

Oct 25 14:15:36 qemux86-64 afbd-motalk[1633]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/motalk uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemo>
Oct 25 14:15:36 qemux86-64 afbd-motalk[1633]:  NOTICE: Listening interface *:30046 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Oct 25 14:15:36 qemux86-64 afbd-motalk[1633]:  NOTICE: Browser URL= http://localhost:30046 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Oct 25 14:15:36 qemux86-64 afbd-motalk[1633]:  NOTICE: Listening interface localuser--46:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Oct 25 14:15:36 qemux86-64 systemd[1]: Started This is a demo application used for motalk.
Oct 25 14:15:36 qemux86-64 afbd-motalk[1635]: Both point size and pixel size set. Using pixel size.
Oct 25 14:15:52 qemux86-64 afbd-motalk[1635]: QNativeSocketEngine::write() was not called in QAbstractSocket::ConnectedState

bei systemctl status service-hvac fehlt die Zeile "Process", bzw. beim motalk ist sie mit dabei, habe das gecheckt mit PreStart aber sollte keine Auswirkung haben.

Einzige verbleibende Idee ist nochmal Ports zu ändern und dann checken. 
Bedeutung Ports:
(das Binding ist der server, und app müsste client sein)


The generated unit files will contain variables for internal use of the framework. These variables are starting with X-AFM-. The variables starting with X-AFM- but not with X-AFM-- are the public variables. These variables will be returned by the framework as the details of an application (see afm-util detail …).
Variables starting with X-AFM-- are private to the framework. By example, the variable X-AFM--http-port is used to record the allocated port for applications.

test normaler port binding auf 1234

(nebenbei erwähnt: das starten über draufklicken klappt mittlerweile)

nach Umstellung:
Oct 25 16:00:41 qemux86-64 afbd-agl-service-motalk[1972]:  ERROR: can't open server socket for sd:motalk2021 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]
Oct 25 16:00:41 qemux86-64 afbd-agl-service-motalk[1972]:  ERROR: can't create socket sd:motalk2021 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-ws.c:167,api_ws_server_connect]
Oct 25 16:00:41 qemux86-64 afbd-agl-service-motalk[1972]:  ERROR: can't start the afb-websocket service sd:motalk2021 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:178,apiset_start_list]



---> hilft alles nix. Als nächstes Mal versuchen einfach bei motalk service bloß binary von motalk zu starten
( bloß das binary laufen zu lassen führt zu Kommunikation !!!! )   --> das config.xml so anpassen, dass nur binary gestartet wird, zB das @p und @ t streichen
(evtl lässt sich ab mit Mausklick starten, wenn als user agl-driver steht)
es funktioniert zumindest connection, wenn man in afm-appli-motalk.service das execstart auf name und exec_ .../bin/motalk beschränkt. Siehe als Beispiel Screenshot vom 4.11.
leider geht Inhalt nicht durch

motalk nur startklar, wenn vorher agl-service-motalk installiert und gestartet wurde.
motalk mit standard service-file funktioniert richtig, wenn ich afb-daemon --binding .. --port 1234 eingebe.
qemux86-64:/var/local/lib/afm/applications/agl-service-motalk/lib# ps -ef | grep motalk
                                                                                                                                                                                                                                                                                                                      
root        1485    1483  0 09:30 ?        00:00:02 /var/local/lib/afm/applications/motalk/bin/motalk 30044 @t
                                                                                                                                                                                                                                                                                                                                                       
root        1489    1004  0 09:33 ttyS1    00:00:00 afb-daemon --binding ./motalk_reawi_binding2.so --port 1234

nach Änderung von service-File konnte ich zuerst nicht starten, wegen siehe unten. Dann habe ich binding gekillt und der start von motalk ging auf einmal
qemux86-64:/var/local/lib/systemd/system# systemctl status afm-appli-motalk--0.1--main@0.service
* afm-appli-motalk--0.1--main@0.service - This is a demo application used for motalk
     Loaded: loaded (/usr/local/lib/systemd/system/afm-appli-motalk--0.1--main@.service; static; vendor preset: disabled)
     Active: failed (Result: exit-code) since Fri 2021-11-05 09:46:31 UTC; 52s ago
    Process: 1578 ExecStartPre=/bin/mkdir -p /home/0/app-data/motalk (code=exited, status=0/SUCCESS)
    Process: 1579 ExecStart=/usr/bin/afb-daemon --name afbd-motalk --exec /var/local/lib/afm/applications/motalk/bin/motalk (code=exited, status=1/FAILURE)
   Main PID: 1579 (code=exited, status=1/FAILURE)

Nov 05 09:46:31 qemux86-64 systemd[1]: Starting This is a demo application used for motalk...
Nov 05 09:46:31 qemux86-64 afbd-motalk[1579]:  ERROR: can't open server socket for tcp:*:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]
Nov 05 09:46:31 qemux86-64 afbd-motalk[1579]:  ERROR: can't create socket tcp:*:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:538,hsrv_itf_connect]
Nov 05 09:46:31 qemux86-64 afbd-motalk[1579]:  ERROR: setting interface failed [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:412,start_http_server]
Nov 05 09:46:31 qemux86-64 systemd[1]: afm-appli-motalk--0.1--main@0.service: Main process exited, code=exited, status=1/FAILURE
Nov 05 09:46:31 qemux86-64 systemd[1]: afm-appli-motalk--0.1--main@0.service: Failed with result 'exit-code'.
Nov 05 09:46:31 qemux86-64 systemd[1]: Failed to start This is a demo application used for motalk.
qemux86-64:/var/local/lib/systemd/system# ps -ef | grep motalk
root        1486       1  0 09:30 ?        00:00:00 afbd-agl-service-motalk                                                                                                                                                                                                                                                                                                                                                        
root        1494    1004  0 09:39 ttyS1    00:00:00 afb-daemon --binding ./motalk_reawi_binding2.so
root        1585    1004  0 09:48 ttyS1    00:00:00 grep motalk
qemux86-64:/var/local/lib/systemd/system# afm-util start motalk
ERROR:  cannot-start
qemux86-64:/var/local/lib/systemd/system# kill -9 1494
qemux86-64:/var/local/lib/systemd/system# afm-util start motalk
1595

Nun tritt derselbe Fehler wie letztes Mal auf mit status: unknown api ( Idee:  evtl ws und api in execstart stehen lassen)
aber in Binding tritt fehler auf:
qemux86-64:/var/local/lib/afm/applications/agl-service-motalk/lib# afb-daemon --binding ./motalk_reawi_binding2.so &  
[1] 1604
qemux86-64:/var/local/lib/afm/applications/agl-service-motalk/lib# ERROR: can't open server socket for tcp:*:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-socket.c:352,afb_socket_open_scheme]
ERROR: can't create socket tcp:*:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:538,hsrv_itf_connect]
ERROR: setting interface failed [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:412,start_http_server]

----> anscheinend wollen beide bin socket 1234 createn/öffnen.  Nachschauen in Testsitzung, dass nur ein Programm diesen Port öffnet !!

aber wenn ich nur das binary starte, klappt es.  Das bedeutet wahrscheinlich Fehler in Afb-Programm, wie oben zu sehen.  (bloß binary in execStart statt /usr/bin/afb-daemon dann klappts)


qemux86-64:/var/local/lib/systemd/system# ps -ef | grep motalk
root        1645    1004  0 10:12 ttyS1    00:00:00 afb-daemon --binding ./motalk_reawi_binding2.so
root        1757       1  1 11:12 ?        00:00:01 /var/local/lib/afm/applications/motalk/bin/motalk &
root        1763    1004  0 11:15 ttyS1    00:00:00 grep motalk
qemux86-64:/var/local/lib/systemd/system# netstat -tuln | grep 1234
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN      
qemux86-64:/var/local/lib/systemd/system# fuser 1234/tcp
1234/tcp:             1645

agl-service-port killen und service umschreiben, damit sich port 1234 öffnet

(bluetooth klappt auf diesem PC, prüfen mit "dmesg | grep -i blue" oder "bluetoothctl show/scan on/off" etc.)


neuer Fehler:  smack denied:
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]: ------END OF CONFIG-----
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: running with pid 1928 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:978,main]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: API monitor added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: Can't acces socket path /run/platform/supervisor: No such file or directory [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-supervision.c:165,try_connect_supervisor]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: binding [/var/local/lib/afm/applications/agl-service-motalk/lib/motalk_reawi_binding2.so] looks like an AFB binding V3 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so-v3.c:84,afb_api_so_v3_add]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: API motalk2021 added [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:510,afb_apiset_add]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: [API motalk2021] Normally bindingPreInit
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  [motalk_binding.c:69,bindingPreInit]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: Scanning dir=[/usr/lib/afb] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: Scanning dir=[/usr/lib/afb/monitoring] for bindings [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-api-so.c:193,adddirs]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: API monitor starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: API monitor started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: API motalk2021 starting... [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:808,start_api]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: [API motalk2021] Normally bindingInit
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  [motalk_binding.c:76,bindingInit]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: API motalk2021 started [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-apiset.c:827,start_api]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  INFO: Alias for url=/monitoring to path=/usr/lib/afb/monitoring [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:299,init_alias]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: Serving rootdir=/var/local/lib/afm/applications/agl-service-motalk uploaddir=. [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:401,start_http_server]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: Listening interface *:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: Browser URL= http://localhost:1234 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/main-afb-daemon.c:416,start_http_server]
Nov 05 11:30:40 qemux86-64 afbd-agl-service-motalk[1928]:  NOTICE: Listening interface localuser--45:8080 [/usr/src/debug/af-binder/master+gitAUTOINC+1b6249810b-r0/git/src/afb-hsrv.c:557,hsrv_itf_connect]
Nov 05 11:30:40 qemux86-64 systemd[1]: Started Binding for motalk interface.
Nov 05 11:31:03 qemux86-64 systemd[1]: Starting This is a demo application used for motalk...
Nov 05 11:31:03 qemux86-64 afbd-motalk[1935]: Both point size and pixel size set. Using pixel size.
Nov 05 11:31:04 qemux86-64 afbd-launcher[846]: app_id:  motalk
Nov 05 11:31:14 qemux86-64 afm-system-daemon[300]:  ERROR: can't wait system unit afm-appli-motalk--0.1--main@.service for uid 0: Resource temporarily unavailable [/usr/src/debug/af-main/master+gitAUTOINC+3ea6f4a404-r0/git/src/afm-urun.c:286]
Nov 05 11:31:17 qemux86-64 audit[1935]: AVC lsm=SMACK fn=smack_socket_sock_rcv_skb action=denied subject="User::App::motalk" object="User::App::agl-service-motalk" requested=w pid=1935 comm="motalk" saddr=127.0.0.1 src=34720 daddr=127.0.0.1 dest=1234 netif=lo

---> das binary-motalk mit PID 1935 kann nicht auf smack zugreifen.  SMACK durchlesen !!

test mit qemux86-64:/var/local/lib/systemd/system# afb-client-demo --human 'localhost:1234/api?token=' motalk2021 ping 
ON-REPLY 1:motalk2021/ping: OK
{
  "response":0,
  "jtype":"afb-reply",
  "request":{
    "status":"success",
    "info":"Ping count = 1860 + 0"
  }
}

zu smack, Forum:
the expected behavior:

  No application can communicate with other application
  without having the authorization

...
This decomposition: application + service is the expected design. We
often refer to service for applications like canivi that provide
features to other applications and that often not have user interface.
...
> Second, I try to start canivi binding by using afm-util.
>    So I create a new canivi wgt, and config.xml is like this.
>    <?xml version="1.0" encoding="UTF-8"?>
>    <widget
> xmlns="http://www.w3.org/ns/widgets"<http://www.w3.org/ns/widgets>
> id="canivi" version="0.1"> <name>Canivi</name> <icon src="icon.svg"/>
>        <content src="lib" type="application/vnd.agl.service"/>
>        <description>This is the canivi service</description>
>        <author>TTE</author>
>        <license>APL 2.0</license>

Because the exported API is "canivi", you should export it using an agl
feature as below:

   <feature name="urn:AGL:widget:provided-api">
      <param name="canivi" value="auto" />
   </feature>

But it will not be enough because the client (dashboard) widget must
also be modified to declare that it uses the API canivi. In should
include the line 

   <feature name="urn:AGL:widget:required-api">
      <param name="canivi" value="auto" />
   </feature>


qemux86-64:/var/local/lib/systemd/system# chsmack | grep motalk
./.afm-service-agl-service-motalk--1.0--main@.service.un~ access="System::Shared"
./afm-service-agl-service-motalk--1.0--main@.service access="System::Shared"
./afm-service-agl-service-motalk--1.0--main@.service~ access="System::Shared"
./afm-api-motalk2021@.socket access="System::Shared"
./afm-appli-motalk--0.1--main@.service access="System::Shared"
./.afm-appli-motalk--0.1--main@.service.un~ access="System::Shared"
./afm-appli-motalk--0.1--main@.service~ access="System::Shared"
./afm-api-motalk2021@.service access="System::Shared"

---> scheint nicht so einfach lösbar. Als nächstes probieren einfach nur agl-service aber mit icon zu erstellen und das motalk-bin extra zu starten ?!

vorher: nochmal 1-zu-1 alles gleich machen wie hvac (service) und evtl klappts dann (auch Rechte beachten)?: 
qemux86-64:/var/local/lib/afm/applications/hvac# ps -efZ | grep hvac
User::App::agl-service-hvac     agl-dri+     491       1  0 21:38 ?        00:00:00 afbd-agl-service-hvac                                                                                                                                                                                                                                                                                                                                                                                                                                              
User::App::hvac                 agl-dri+     624       1  0 21:38 ?        00:00:00 afbd-hvac                                                                                                                                                                                                                                                                                                                   
User::App::hvac                 agl-dri+     625     624  0 21:38 ?        00:00:00 /var/local/lib/afm/applications/hvac/bin/hvac 30033 @t


qemux86-64:/var/local/lib/systemd/system# ls -ll | grep hvac
-rw-r--r-- 1 root agl-driver 2462 Nov  5 09:23 afm-appli-hvac--0.1--main@.service
-rw-r--r-- 1 root agl-driver 2850 Nov  5 09:2

qemux86-64:/var/local/lib/afm/applications/agl-service-hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="agl-service-hvac" version="1.0">
	<name>agl-service-hvac</name>
	<icon src="icon.png"/>
	<content src="lib/libafm-hvac-binding.so" type="application/vnd.agl.service"/>
	<description>Binding for HVAC interface</description>
	<author> &lt;&gt;</author>
	<license>APL2.0</license>

	<feature name="urn:AGL:widget:required-permission">
		<param name="urn:AGL:permission::public:hidden" value="required" />
		<param name="urn:AGL:permission::public:no-htdocs" value="required" />
		<param name="urn:AGL:permission::system:run-by-default" value="required" />
		<param name="urn:AGL:permission::platform:can:write" value="required" />
	</feature>

	<feature name="urn:AGL:widget:provided-api">
		<param name="HVAC" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-api">
		<param name="identity" value="ws" />
		<param name="low-can" value="ws" />
	</feature>

	<feature name="urn:AGL:widget:required-binding">
		<param name="lib/libafm-hvac-binding.so" value="local" />
	</feature>
</widget>

qemux86-64:/var/local/lib/afm/applications/hvac# cat config.xml 
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="hvac" version="0.1">
  <name>HVAC</name>
  <icon src="icon.svg"/>
  <content src="bin/hvac" type="application/vnd.agl.native"/>
  <description>This is a demo application used to control and dialog with HVAC system</description>
  <author>Romain Forlot &lt;romain.forlot@iot.bzh&gt;</author>
  <license>APL 2.0</license>
  <feature name="urn:AGL:widget:required-api">
    <param name="HVAC" value="ws" />
  </feature>
  <feature name="urn:AGL:widget:required-permission">
    <param name="urn:AGL:permission::public:no-htdocs" value="required" />
    <param name="urn:AGL:permission::public:display" value="required" />
  </feature>
</widget>

---> bei smack attempt ist config.xml jetzt exakt wie hvac

letzte Idee:  binding so abändern wie in hvac-service:
ype=notify
ExecStart=/usr/bin/afb-daemon \
	--name afbd-agl-service-hvac \
	--rootdir=/var/local/lib/afm/applications/agl-service-hvac \
	--workdir=/home/%i/app-data/agl-service-hvac \
	--verbose \
	--verbose \
	--monitoring \
	--port=30013 \
	--interface=tcp:localuser--13:8080 \
	--roothttp=. \
		--ws-client=unix:/run/user/%i/apis/ws/identity \
		--ws-client=unix:/run/user/%i/apis/ws/low-can \
		--binding=/var/local/lib/afm/applications/agl-service-hvac/lib/libafm-hvac-binding.so \
		--ws-server=sd:HVAC \
	
aber mit port 30044   -------> Egal was ich mache, smack fehler bleibt.  Als nächstes wirklich app (bin) in einem widget zu starten

versuch: hybrid bedeutet service und application:
A Hybrid application contains at the same time (an) Application-specific Binding(s) as backend(s) and a User Interface (Native, HTML5, QML …) as a frontend. This is probably the most pertinent real-world case, since it allows developers to provide capabilities through Bindings, and an end-user experience through the UI.  ---> das ist aber wohl veraltet :(


Test mit:
<?xml version="1.0" encoding="UTF-8"?>
<widget xmlns="http://www.w3.org/ns/widgets" id="exthtml5" version="1.0">
<name>Extended HTML5</name>
<icon src="icon.png"/>
<description>Example of application with binding</description>
<author>me</author>
<license>MIT</license>
<content src="index.html" type="text/html"/>
<feature name="urn:AGL:widget:required-api">
<param name="homescreen" value="ws" />
<param name="windowmanager" value="ws" />
</feature>
<feature name="urn:AGL:widget:required-binding">
<param name="lib/binding.so" value="local" />
</feature>
</widget>


smack_attempt/motalk klappt nicht :-/   ---> letzter ausweg bin einzeln starten mit Skript: funktioniert!
letzte Idee:  hvac oder navigation App "kapern", also binaries und APIs von motalk einfügen und schauen ob es läuft

die Bindings/agl-services haben alle ein config.xml.in file statt hardcode config.xml wie ich nutze?

to do:
erstmal den Fehler beheben bei tastenklick und dann bluetooth checken/implementieren:
beim Klicken auf keys T,Z,U ohne abzuschicken:
qemux86-64:/var/local/lib/systemd/system# "Could not convert argument 0 at"
	 "onClicked@qrc:/SingleKey.qml:213"
"Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."
"This will throw a JavaScript TypeError in future releases of Qt!"
"Could not convert argument 0 at"
	 "onClicked@qrc:/SingleKey.qml:219"
"Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."
"This will throw a JavaScript TypeError in future releases of Qt!"
"Could not convert argument 0 at"
	 "onClicked@qrc:/SingleKey.qml:225"
"Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."
"This will throw a JavaScript TypeError in future releases of Qt!"

Die Klickfelder parse input, send etc. und die taste " DEL" geben keine Fehler aus. 



Bluetooth-traces siehe blueth_tickets.txt

bluetooth-Sourcefiles irgendwie kompilieren und zum laufen bringen, mit cmake, dann binding einbinden in App

source sdk/
export LIBRARY_PATH=/home/cloud/local/lib/pkgconfig:/home/cloud/local/lib:$LIBRARY_PATH; ldconfig

gcc -v -fPIC -shared -Wall -g3 -O3 bluetooth-api.c -o bluetooth_binding.so $(pkg-config --cflags --libs afb-daemon libafbwsc glib) -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/lib/glib-2.0/include -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/glib-2.0

afb-daemon --verbose --no-httpd --binding ./bluetooth_binding.so 

zum testen:
cloud@Cloud-Lab:~/agl/test_bluetooth/build/package/lib$ afb-daemon --binding ./libafm-bluetooth-binding.so --verbose



wieder Fehler bei build, als nächstes mal autobuild laufen lassen --> build erfolgreich


Test with: afb-daemon --rootdir=/home/cloud/agl/bluetooth/agl-service-bluetooth-a3fd8ee/build/package --binding=/home/cloud/agl/bluetooth/agl-service-bluetooth-a3fd8ee/build/package/lib/libafm-bluetooth-binding.so --port=1234 --tracereq=common --token=1 --verbose

cloud@Cloud-Lab:~/agl/bluetooth/agl-service-bluetooth-a3fd8ee$ ./autobuild/linux/autobuild build DEST=~

besser testen mit:

NOTICE: API Bluetooth-Manager starting...
ERROR: [API Bluetooth-Manager] requiring api persistence initialized failed [/home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:382,require_api_cb]
ERROR: [API Bluetooth-Manager] Cannot request data persistence service [/home/cloud/agl/bluetooth/agl-service-bluetooth-a3fd8ee/binding/bluetooth-api.c:751,init]
ERROR: Initialisation of service API Bluetooth-Manager failed (-1): No such file or directory [/home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:1793,afb_export_start]
ERROR: The api Bluetooth-Manager failed to start [/home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c:820,start_api]
NOTICE: API monitor starting...

---> ich hatte afb-daemon in binder_selftest gebuildet und dann kopiert, vielleicht deswegen der Verweis auf binder_selftest ordner.

cloud@Cloud-Lab:~/agl/bluetooth/agl-service-bluetooth-a3fd8ee/build/package/lib$ afb-daemon --binding ./libafm-bluetooth-binding.so --verbose

(angeben in config.xml "--background" um afb-daemon im HIntergrund laufen zu lassen!)

next: bluetoot durchgehen, für anfang vieles auskommentieren und peu a peu hinzufügen

#0  require_api_cb (closure=0x5555555c8290, name=<optimized out>, initialized=<optimized out>) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:372
#1  0x00007ffff7fba41b in afb_api_require_api (initialized=1, name=0x7ffff7fc22c7 "persistence", api=<optimized out>) at /home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/afb/afb-api-x3.h:379
#2  init (api=0x5555555c8290) at /home/cloud/agl/test_bluetooth/binding/bluetooth-api.c:749
#3  0x0000555555570df2 in do_init (sig=sig@entry=0, closure=closure@entry=0x7fffffffc2f0) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:180
#4  0x000055555558b672 in monitor (timeout=0, function=0x555555570db0 <do_init>, arg=0x7fffffffc2f0) at /home/cloud/agl/binder_selftest/app-framework-binder/src/sig-monitor.c:225
#5  0x0000555555572eaf in afb_export_start (export=0x5555555c8290) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:1782
#6  afb_export_start (export=0x5555555c8290) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-export.c:1731
#7  0x000055555556c87d in start_api (api=0x5555555c8380) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c:818
#8  start_api (api=0x5555555c8380) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c:796
#9  0x000055555556d615 in afb_apiset_start_all_services (set=<optimized out>) at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c:893


"persistence" ist wohl eine API zu einem anderen Programm --> 
Enable saving a cached contacts to data persistence service based on per paired device (using the MAC address as the primary key)

---> APIs auskommentieren hat vorerst gelöst

nächster Fehler mit persistence auszubessern unter:
set_default_adapter (api=api@entry=0x5555555c8290, adapter=adapter@entry=0x7ffff7fc22c7 "hci0") at /home/cloud/agl/test_bluetooth/binding/bluetooth-conf.c:69

afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager subscribe 

afb-daemon --binding ./build/package/lib/libafm-bluetooth-binding.so --verbose --tracereq=all --traceevt=all --traceses=all --traceapi=all --traceglob=all --traceditf=all --tracesvc=all
HOOK: [session-351df518-279e-4011-844d-656634f01da0] addref
HOOK: [api-Bluetooth-Manager] set_verbs_v3 -> OK (0)
HOOK: [api-Bluetooth-Manager] set_on_init -> OK (0)
HOOK: [api-Bluetooth-Manager] seal
NOTICE: API Bluetooth-Manager starting...
HOOK: [global] vverbose(5:notice, /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c, 808, start_api) -> API Bluetooth-Manager starting...
HOOK: [api-Bluetooth-Manager] start.before
HOOK: [api-Bluetooth-Manager] callsync(persistence/read, {"key":"default_adapter"}) ...
HOOK: [session-351df518-279e-4011-844d-656634f01da0] addref
HOOK: [xreq-000001:persistence/read] BEGIN
HOOK: [xreq-000001:persistence/read] reply[unknown-api](null, api persistence not found (for verb read))
HOOK: [api-Bluetooth-Manager]     ...callsync... -1 [unknown-api] -> null (api persistence not found (for verb read))
HOOK: [xreq-000001:persistence/read] END
HOOK: [session-351df518-279e-4011-844d-656634f01da0] unref
HOOK: [api-Bluetooth-Manager] callsync(network-manager/enable_technology, {"technology":"bluetooth"}) ...
HOOK: [session-351df518-279e-4011-844d-656634f01da0] addref
HOOK: [xreq-000002:network-manager/enable_technology] BEGIN
HOOK: [xreq-000002:network-manager/enable_technology] reply[unknown-api](null, api network-manager not found (for verb enable_technology))
HOOK: [api-Bluetooth-Manager]     ...callsync... -1 [unknown-api] -> null (api network-manager not found (for verb enable_technology))
HOOK: [xreq-000002:network-manager/enable_technology] END
HOOK: [session-351df518-279e-4011-844d-656634f01da0] unref
HOOK: [evt-Bluetooth-Manager/adapter_changes:1] create
HOOK: [api-Bluetooth-Manager] event_make(adapter_changes) -> Bluetooth-Manager/adapter_changes:1
HOOK: [evt-Bluetooth-Manager/device_changes:2] create
HOOK: [api-Bluetooth-Manager] event_make(device_changes) -> Bluetooth-Manager/device_changes:2
HOOK: [evt-Bluetooth-Manager/media:3] create
HOOK: [api-Bluetooth-Manager] event_make(media) -> Bluetooth-Manager/media:3
HOOK: [evt-Bluetooth-Manager/agent:4] create
HOOK: [api-Bluetooth-Manager] event_make(agent) -> Bluetooth-Manager/agent:4
HOOK: [api-Bluetooth-Manager] start.after -> 0
NOTICE: API monitor starting...
HOOK: [global] vverbose(5:notice, /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-apiset.c, 808, start_api) -> API monitor starting...
NOTICE: Serving rootdir=. uploaddir=.
HOOK: [global] vverbose(5:notice, /home/cloud/agl/binder_selftest/app-framework-binder/src/main-afb-daemon.c, 401, start_http_server) -> Serving rootdir=. uploaddir=.
NOTICE: Listening interface *:1234
HOOK: [global] vverbose(5:notice, /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-hsrv.c, 557, hsrv_itf_connect) -> Listening interface *:1234
NOTICE: Browser URL= http://localhost:1234
HOOK: [global] vverbose(5:notice, /home/cloud/agl/binder_selftest/app-framework-binder/src/main-afb-daemon.c, 416, start_http_server) -> Browser URL= http://localhost:1234
HOOK: [evt-Bluetooth-Manager/adapter_changes:1] push.before({"adapter":"hci0","action":"changed","properties":{"pairable":true}})
HOOK: [evt-Bluetooth-Manager/adapter_changes:1] push.after({"adapter":"hci0","action":"changed","properties":{"pairable":true}}) -> 0
HOOK: [session-351df518-279e-4011-844d-656634f01da0] close
HOOK: [session-31eb738c-279e-4690-a064-41de96a21da1] create
HOOK: [session-31eb738c-279e-4690-a064-41de96a21da1] addref
HOOK: [session-31eb738c-279e-4690-a064-41de96a21da1] addref
HOOK: [xreq-000003:Bluetooth-Manager/subscribe] BEGIN
HOOK: [xreq-000003:Bluetooth-Manager/subscribe] get(value) -> { name: (null), value: (null), path: (null) }
HOOK: [xreq-000003:Bluetooth-Manager/subscribe] reply[failed](null, Missing "value" event)
HOOK: [xreq-000003:Bluetooth-Manager/subscribe] END
HOOK: [session-31eb738c-279e-4690-a064-41de96a21da1] unref
HOOK: [session-31eb738c-279e-4690-a064-41de96a21da1] unref


afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager set_pincode {"pincode":"12345"}   
führt zu:
HOOK: [xreq-000003:Bluetooth-Manager/set_pincode] BEGIN
HOOK: [xreq-000003:Bluetooth-Manager/set_pincode] get(pincode) -> { name: (null), value: (null), path: (null) }
ERROR: ALERT! signal 11 received: Segmentation fault [/home/cloud/agl/binder_selftest/app-framework-binder/src/sig-monitor.c:362,on_signal_error]
HOOK: [global] vverbose(3:error, /home/cloud/agl/binder_selftest/app-framework-binder/src/sig-monitor.c, 362, on_signal_error) -> ALERT! signal 11 received: Segmentation fault
ERROR: BACKTRACE due to signal Segmentation fault/11:
 [1/9] ./build/package/lib/libafm-bluetooth-binding.so(+0x381a) [0x7f30e43d881a]
 [2/9] afb-daemon(+0x33f23) [0x55c0791a5f23]
 [3/9] afb-daemon(+0x37672) [0x55c0791a9672]
 [4/9] afb-daemon(+0x350c1) [0x55c0791a70c1]
 [5/9] afb-daemon(+0x352ef) [0x55c0791a72ef]
 [6/9] afb-daemon(jobs_start+0x17e) [0x55c0791a7e1e]
 [7/9] afb-daemon(main+0x1ca) [0x55c079185e9a]
 [8/9] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf3) [0x7f30e3de20b3]
 [9/9] afb-daemon(_start+0x2e) [0x55c07918616e]
 [/home/cloud/agl/binder_selftest/app-framework-binder/src/sig-monitor.c:103,dumpstack]
HOOK: [global] vverbose(3:error, /home/cloud/agl/binder_selftest/app-framework-binder/src/sig-monitor.c, 103, dumpstack) -> BACKTRACE due to signal Segmentation fault/11:
 [1/9] ./build/package/lib/libafm-bluetooth-binding.so(+0x381a) [0x7f30e43d881a]
 [2/9] afb-daemon(+0x33f23) [0x55c0791a5f23]
 [3/9] afb-daemon(+0x37672) [0x55c0791a9672]
 [4/9] afb-daemon(+0x350c1) [0x55c0791a70c1]
 [5/9] afb-daemon(+0x352ef) [0x55c0791a72ef]
 [6/9] afb-daemon(jobs_start+0x17e) [0x55c0791a7e1e]
 [7/9] afb-daemon(main+0x1ca) [0x55c079185e9a]
 [8/9] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf3) [0x7f30e3de20b3]
 [9/9] afb-daemon(_start+0x2e) [0x55c07918616e]

HOOK: [xreq-000003:Bluetooth-Manager/set_pincode] reply[aborted](null, signal Segmentation fault(11) caught)
HOOK: [xreq-000003:Bluetooth-Manager/set_pincode] END

to do:
---> debuggen warum segmentation fault, gesamtes bluetooth-pairing nachvollziehen - mediaplayer vorerst rauslöschen


Fehler in bluetooth-conf.c Zeile 110 bei strlen: if (strlen(pincode) > 8 || strlen(pincode) < 4)    
../sysdeps/x86_64/multiarch/strlen-avx2.S: No such file or directory.

---> "While the problem is in your code, the crash itself happens in the strlen function`, which is defined in a library which you usually have no sources to and don't need any sources to (unless you want to debug the internals of the library). Therefore you get an error saying that the source is not found. It's not an error in itself, and can be disregarded."

in set_pincode (api=0x5555555c8290, pincode=pincode@entry=0x0, error=error@entry=0x7fffffffc488) at /home/cloud/agl/test_bluetooth/binding/bluetooth-conf.c:105
(gdb) p *api
$5 = {itf = 0x5555555b1360 <api_x3_itf>, apiname = 0x5555555c8328 "Bluetooth-Manager", userdata = 0x7ffff0003ea0, logmask = 31}
(gdb) s
(gdb) p ret
$6 = <optimized out>
(gdb) p *pincode
Cannot access memory at address 0x0
(gdb) p pincode
$7 = 0x0
(gdb) p &pincode
Address requested for identifier "pincode" which is in register $rsi
(gdb) 
---> pincode existiert einfach nicht !

#0  do_sync (export=<optimized out>, caller=caller@entry=0x0, api=<optimized out>, verb=<optimized out>, args=<optimized out>, flags=flags@entry=9, object=0x7fffffffc448, error=0x0, info=0x0, mode=...)
    at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-calls.c:327
#1  0x0000555555590c08 in afb_calls_call_sync (export=<optimized out>, api=<optimized out>, verb=<optimized out>, args=<optimized out>, object=<optimized out>, error=<optimized out>, info=0x0)
    at /home/cloud/agl/binder_selftest/app-framework-binder/src/afb-calls.c:431
#2  0x00007ffff7fc11fe in afb_api_call_sync (info=0x0, error=0x0, object=0x7fffffffc448, args=0x5555555d4ea0, verb=0x7ffff7fc4c9c "update", apiname=0x7ffff7fc4c4c "persistence", api=0x5555555c8290)
    at /home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/afb/afb-api-x3.h:880
#3  set_pincode (api=0x5555555c8290, pincode=pincode@entry=0x7ffff7fc4000 "1234", error=error@entry=0x7fffffffc490) at /home/cloud/agl/test_bluetooth/binding/bluetooth-conf.c:128


irgendwie kommt wieder API/verb=persistence/update ins Spiel
< nebenbei:  API-relevante functions unter func-api.md erklärt, request-relevantes unter func-req.md >
< gchar, gint, usw. sind Datentypen von glib,gtk+:  These are useful because a "gint8" can be adjusted to be 1 byte (8 bits) on all platforms. 
	Similarly and more importantly, "gint32" can be adjusted to be 4 bytes (32 bits) on all platforms. >

./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager set_pincode {"pincode":"1234"}
 2143  ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager subscribe {"value":"device_changes"}
 2144  ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager unsubscribe {"value":"device_changes"}
 2145  ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager managed_objects
 2146  ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager adapter_state
 2147  ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager default_adapter {"adapter":"hci0"}


set_pincode klappt jetzt nach etlichen Änderungen und Anpassungen auch in bluetooth_conf.c zum Beispiel die Calls auf persistence auskommentiert und response=NULL gesetzt.
das Verb subscribe klappt ebenfalls nach der gleichen Vorgehensweise des Einsetzens vordefinierter strings/return-values!
Same story mit unsubscribe. verb managed_objects klappt sogar ohne in dieser Funktion zu pfuschen, genauso klappt adapter_state auf Anhieb.
Bei default_adapter war wieder ein einzeiliger Eingriff nötig.

Connect anscheinend erst nach pair möglich

den path /org/bluez gibt es nicht, eigenen path einfügen ?!  --> ich habe ihn als /usr/local/org/bluez/hci0 eingefügt und die Files angepasst

#0  bluez_call (ns=ns@entry=0x7ffff0003ea0, access_type=access_type@entry=0x7ffff7fc3c64 "agent-manager", path=path@entry=0x0, method=method@entry=0x7ffff7fc3c56 "RegisterAgent",
	params=0x7fffec02aa60, error=error@entry=0x7ffff724cb50) at /home/cloud/agl/test_bluetooth/binding/bluetooth-bluez.c:219
#1  0x00007ffff7fbe8ea in agentmanager_call (error=0x7ffff724cb50, params=<optimized out>, method=0x7ffff7fc3c56 "RegisterAgent", ns=0x7ffff0003ea0)
    at /home/cloud/agl/test_bluetooth/binding/bluetooth-api.h:251
#2  on_bus_acquired (connection=<optimized out>, name=<optimized out>, user_data=0x5555555c8400) at /home/cloud/agl/test_bluetooth/binding/bluetooth-agent.c:211

Kette:
init --> bluetooth_func --> bluetooth_select_init_adapter --> on_bus_acquired --> agentmanager_call

agentmanager_call (error=0x7ffff724cb50, params=0x7fffec005270, method=0x7ffff7fc3c56 "RegisterAgent", ns=0x7ffff0003ea0) at /home/cloud/agl/test_bluetooth/binding/bluetooth-api.h:251
(gdb) p *ns
$2 = {loop = 0x7ffff0003e80, conn = 0x7ffff0010060, device_sub = 1, autoconnect_sub = 0, adapter_changes_event = 0x7ffff001d400, device_changes_event = 0x7ffff000b750, media_event = 0x7ffff00163e0,
  agent_event = 0x7ffff0003e00, cw_mutex = {p = 0x0, i = {0, 0}}, next_cw_id = 1, cw_pending = 0x0, cw = 0x0, introspection_data = 0x7ffff0019b90, agent_id = 1, registration_id = 1,
  agent_path = 0x5555555c81a0 "/usr/local/org/bluez/agent21318", agent_registered = 0, mediaplayer_path = 0x0, adapter = 0x5555555c87e0 "hci0"}
(gdb) 

agent_path = "path of bluez" + "agent($PID)"

bei bluetooth-register-agent in bluetooth-agent.c wird der agentpfad, also /usr/local/org/bluez/agent festgelegt
 
Software bricht nicht ab, sonderzn sagt nur unknown service, könnte daran liegen: 
... in bluetooth-agent.c /* Introspection data for the agent service */
static const gchar introspection_xml[] =


unter "./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager managed_objects"  steht path uner adapter immer /org/bluez/hci0, evtl doch Pfad wieder zurückändern ?!

nach Pfad-Änderun keine Errors wegen agent-manager mehr.
für verb connect muss ich die Device-Bezeichnung angeben. aber nach Aufruf von managed_objects steht kein Eintrag unter "devices", weshalb ich auch keine Device-Kennung angeben kann.

Weiter mit pairing:
Fehler bei "device = afb_req_value(request, "device");" in bluetooth-util.c 
device manuell gesetzt, führt zu  "info":"Connect error: unknown service /org/bluez/hci0/dev_88_0F_10_96_D3_20" aus bluez_decode_call_error was pair_service_callback aufruft.
Lösungsversuch: ordner kreieren --> fehlgeschlagen

Ubuntu-System hat path unter /sys/class/bluetooth/hci0/device/bluetooth/hci0/ bzw. /var/lib/bluetooth/<device-id>
Schreibweise: /var/lib/bluetooth/CC\:3D\:82\:39\:9B\:61/

testen mit eigenem device:
 ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager pair {"device":"CC:3D:82:39:9B:61"}
 
 
 Thread 2 "afb-daemon" hit Breakpoint 2, bluez_decode_call_error (ns=0x7ffff0003ea0, access_type=0x5555555d43d0 "device",
    type_arg=0x5555555d53e0 "/org/bluez/hci0/dev_88_0F_10_96_D3_20", method=0x5555555d44d0 "Pair", error=0x7ffff724cb70)
    at /home/cloud/agl/test_bluetooth/binding/bluetooth-bluez.c:157
(gdb) p error
$1 = (GError **) 0x7ffff724cb70
(gdb) p **error
$2 = {domain = 51, code = 41,
  message = 0x7ffff0022820 "GDBus.Error:org.freedesktop.DBus.Error.UnknownObject: Method \"Pair\" with signature \"\" on interface \"org.bluez.Device1\" doesn't exist\n"}

versuchen über dbus etwas rauszufinden:

cloud@Cloud-Lab:/$ dbus-send --system --print-reply --dest=org.freedesktop.DBus  /org/freedesktop/DBus org.freedesktop.DBus.ListNames

--> dbus-org.bluez.service  ---> siehe bluetooth-ticket

28.12.
in bluetooth-util.c und -bluez.c habe ich org durch "dbus-org" ausgetauscht

nun ein neuer Fehler:
GLib-GIO-CRITICAL **: 18:03:24.992: g_dbus_connection_call_internal: assertion 'object_path != NULL && g_variant_is_object_path (object_path)' failed

bei Ausführen von:
cloud@Cloud-Lab:~/agl/binder_selftest/app-framework-binder/build/src$ ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager pair {"device":"CC:3D:82:39:9B:61"}
ON-REPLY 1:Bluetooth-Manager/pair: ERROR
{
  "jtype":"afb-reply",
  "request":{
      "status":"disconnected",
    "info":"server hung up"
  }
}
Fehler stammt aber aus binder_selftest/app-framework-binder/src/afb-proto-ws.c: protows->client_itf->on_reply(protows->closure, call->request, NULL, "disconnected", "server hung up");

--> diesen Fehler evtl noch zwei Tage debuggen ansonsten endgültig selbst programmieren
   
   (fehler in blutetooth.service: Dez 29 17:34:44 Cloud-Lab bluetoothd[619]: Unable to open adapter storage directory: /var/lib/bluetooth/CC:3D:82:39:9B:61 ) ??
   
   Ordner-Pfad: cloud@Cloud-Lab:~/agl/binder_selftest/app-framework-binder/build/src$ ./afb-client-demo --human 'localhost:1234/api?token=' Bluetooth-Manager pair 
ON-REPLY 1:Bluetooth-Manager/pair: ERROR
{
  "jtype":"afb-reply",
  "request":{
    "status":"failed",
    "info":"can't queue work another call in progress (device/dbus-org/bluez/hci0/dev_88_0F_10_96_D3_20/pair_device)"
  }
  ---> Ordnerpfad beachte, device/dbus-org...
  --> selbst programmieren, siehe bluetooth_selfattempt

Fehler bei aufruf von make
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ make server
gcc `pkg-config --cflags gio-2.0` -c server.c
Package gio-2.0 was not found in the pkg-config search path.
Perhaps you should add the directory containing `gio-2.0.pc'
to the PKG_CONFIG_PATH environment variable
No package 'gio-2.0' found
server.c:10:10: fatal error: bluetooth/bluetooth.h: No such file or directory
   10 | #include <bluetooth/bluetooth.h>
      |          ^~~~~~~~~~~~~~~~~~~~~~~
compilation terminated.


manueller compilation test:
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ gcc -Wall -g3 server.c -o server $(pkg-config --cflags --libs gio-2.0 glib-2.0) -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/

in neuem Terminal kompiliert, Fehler: 
Perhaps you should add the directory containing `glib-2.0.pc' to the PKG_CONFIG_PATH environment variable
Package 'glib-2.0', required by 'gio-2.0', not found
---> Lösung: erstens die Datei glib-2.0.pc nach /usr/local/lib/pkgconfig/ (=PKG_CONFIG_PATH) kopiert, 
aber bei folgeproblem: /usr/bin/ld: cannot find -lgio-2.0   muss ich wohl noch die links der Files .so anpassen ?!

cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ pkg-config --cflags --libs gio-2.0 glib-2.0 gobject-2.0
-pthread -I/usr/include/libmount -I/usr/include/blkid -I/usr/include/glib-2.0 -I/usr/lib/glib-2.0/include -lgio-2.0 -lgobject-2.0 -lglib-2.0


cloud@Cloud-Lab:/usr/local/lib$ ldd libglib-2.0.so 
	linux-vdso.so.1 (0x00007ffc44509000)
	libpcre.so.1 => not found   (??? warum auf ienmal libpcre.so.1 statt libpcre.so.3 ? 
	libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f683a597000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f683a3a5000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f683a6f6000)
		
------> falls "cannot find" ldd fehler auftritt, die libraries wie zB libglib-2.0.so nach /usr/local/lib/ kopieren, und checken ob 'ldd libglib-2.0.so" alles okay ist oder "not find" steht !
 
 -----> klappt:
 cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ gcc -Wall -g3 server.c -o server $(pkg-config --cflags --libs gio-2.0 glib-2.0 gobject-2.0) -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include/
/usr/bin/ld: cannot find -lgobject-2.0
collect2: error: ld returned 1 exit status
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ cd /
cloud@Cloud-Lab:/$ sudo find -name libgobject-2.0.so
./snap/gnome-3-38-2004/87/usr/lib/x86_64-linux-gnu/libgobject-2.0.so
./home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/lib/libgobject-2.0.so
cloud@Cloud-Lab:/$ sudo cp /home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/lib/libgobject-2.0.so /usr/local/lib/
cloud@Cloud-Lab:/$ cd /usr/local/lib/
cloud@Cloud-Lab:/usr/local/lib$ ldd libgobject-2.0.so 
	linux-vdso.so.1 (0x00007fff6c4c5000)
	libglib-2.0.so.0 => /lib/x86_64-linux-gnu/libglib-2.0.so.0 (0x00007ff91163c000)
	libffi.so.7 => /lib/x86_64-linux-gnu/libffi.so.7 (0x00007ff911630000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff91143e000)
	libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007ff9113cb000)
	libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007ff9113a8000)
	/lib64/ld-linux-x86-64.so.2 (0x00007ff9117d8000)


---> das builden mit dem Makefile klappt nun :-)

für Ausführung zwei Konsolen öffnen. In erster Konsole "sudo ./server" zum Start. Und in zweiter: 
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ ./client 12:34:56:78:9A
Establishing connection...
second loop failed

--> debuggen ergibt:
(gdb) p addr
$3 = {rc_family = 31, rc_bdaddr = {b = "\000\000\000\000\000"}, rc_channel = 27 '\033'}

(gdb) p dest
$4 = "12:34:56:78:9A\000\000\000"

in client.c connect schlägt fehl !	--> einfach mal googeln nach Bluetooth tracing ähnlich wie tcpdump ?

neues tutorial gemäß Erklärung erstellen: bt_tutorial

simplescan klappt sogar, wenn ich Bluetooth am Handy einschalte:	
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt/bt_tutorial$ sudo ./simplescan 
78:00:9E:8A:A6:0F Samsung Galaxy S7


rfcomm connecting rfcomm_server und rfcomm_client klappt nicht, evtl muss ich rfcomm_client auf einem anderen bluetooth-fähigen PC ausführen ? auf Arbeitslaptop klappt das nicht, weil keine Rechte.

Testmöglichkeiten fehlen etwas, bluetooth-dongle kaufen, oder gleich empfohlenen Raspi ?

Versuch BT an qemu durchzuleiten, bisher sagt agl-service:
Jan 04 13:43:54 qemux86-64 afbd-agl-service-bluetooth[922]:  INFO: [API Bluetooth-Manager] No adapter present, 

Bt-einbindung gemäß http://qemu-buch.de/de/index.php?title=QEMU-KVM-Buch/_Netzwerkoptionen/_Bluetooth...

(sleep 5 && vinagre --vnc-scale localhost ) > /tmp/vinagre.log 2>&1 & qemu-system-x86_64 -device virtio-net-pci,netdev=net0,mac=52:54:00:12:35:02 -netdev user,id=net0,hostfwd=tcp::2222-:22 -drive file=agl-demo-platform-crosssdk-qemux86-64.ext4,if=virtio,format=raw -show-cursor -usb -bt hci,host:hci0 -device usb-tablet -device virtio-rng-pci -snapshot -vga virtio -vnc :0 -soundhw hda -machine q35 -cpu kvm64 -cpu qemu64,+ssse3,+sse4.1,+sse4.2,+popcnt -enable-kvm -m 2048 -serial mon:vc -serial mon:stdio -serial null -kernel bzImage -append 'root=/dev/vda rw console=tty0 mem=2048M ip=dhcp oprofile.timer=1 console=ttyS0,115200n8 verbose fstab=no'

...führt zu: 
qemu-system-x86_64: -bt hci,host:hci0: warning: The bluetooth subsystem is deprecated and will be removed soon. If the bluetooth subsystem is still useful for you, please send a mail to qemu-devel@nongnu.org with your usecase.
qemu: Can't open `hci0': Success (0)

stehen geblieben bei service_discovery wegen segmentation fault bei sdp_service_search_attr_req( session, search_list, SDP_ATTR_REQ_RANGE, attrid_list, &response_list);
das Aufrufen dieser Funktion führt bereits zu segmentation fault.
Erklärung: sdp_service_search_attr_req searches the connected device for the desired service and requests a list of attributes specified by attrid_list

Test mit selbst erstellten lists,arrays, structs usw., ob fehler weiterhin auftritt.--> Wenn ich mit Handy verbinde und MAC-Adresse als target angebe, gibt es keinen Seg. Fault mehr:
(gdb) p *session
$1 = {sock = 3, state = 0, local = 0, flags = 1, tid = 0, priv = 0x5555555592d0}

in sdp_lib.h steht Beschreibung zu sdp_service_search_attr_req  (-1 bedeutet time-out)


bluetooth-verbindung:
bt_tutorial --> make rfcomm_server
bluetooothctl discoverable on
sudo btmon

rfcomm_server debuggen:
	-->byes_read = 1008  darum evtl umschrieben programm., while-loop byte-size teilen durch gesamtes gesendetes bytes
	
	
zum Compile von listenmsg: gcc -g3 -o listenmsg listenmsg.c -lasound -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include
(------> falls "cannot find" ld fehler auftritt, die libraries wie zB libglib-2.0.so nach /usr/local/lib/ kopieren, und checken ob 'ldd libglib-2.0.so" alles okay ist oder "not find" steht ? --> hat wieder geklappt :D
nun kompilieren mit: cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ gcc -g3 -o listenmsg listenmsg.c -lasound -I/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/include

für alsa:
pacmd list-sources
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt$ aplay -L

--> daraus ableiten die Bezeichnung, wie zB front:0,1 oder so

loud@Cloud-Lab:~/agl/bluetooth_selfattempt$ pacmd list-sources
4 source(s) available.
    index: 0
	name: <alsa_output.pci-0000_00_1b.0.analog-stereo.monitor>
	driver: <module-alsa-card.c>
	flags: DECIBEL_VOLUME LATENCY DYNAMIC_LATENCY
	state: SUSPENDED
	suspend cause: IDLE
	priority: 1030
	volume: front-left: 65536 / 100% / 0,00 dB,   front-right: 65536 / 100% / 0,00 dB
	        balance 0,00
	base volume: 65536 / 100% / 0,00 dB
	volume steps: 65537
	muted: no
	current latency: 0,00 ms
	max rewind: 0 KiB
	sample spec: s16le 2ch 44100Hz
	channel map: front-left,front-right
	             Stereo
	used by: 0
	linked by: 0
	configured latency: 0,00 ms; range is 0,50 .. 2000,00 ms
	monitor_of: 0
	card: 1 <alsa_card.pci-0000_00_1b.0>
	module: 8
	properties:
		device.description = "Monitor of Built-in Audio Analog Stereo"
		device.class = "monitor"
		alsa.card = "1"
		alsa.card_name = "HDA Intel PCH"
		alsa.long_card_name = "HDA Intel PCH at 0xf0634000 irq 42"
		alsa.driver_name = "snd_hda_intel"
		device.bus_path = "pci-0000:00:1b.0"
		sysfs.path = "/devices/pci0000:00/0000:00:1b.0/sound/card1"
		device.bus = "pci"
		device.vendor.id = "8086"
		device.vendor.name = "Intel Corporation"
		device.product.id = "8c20"
		device.product.name = "8 Series/C220 Series Chipset High Definition Audio Controller (ThinkPad T440p)"
		device.form_factor = "internal"
		device.string = "1"
		module-udev-detect.discovered = "1"
		device.icon_name = "audio-card-pci"
    index: 1
	name: <alsa_input.pci-0000_00_1b.0.analog-stereo>
	driver: <module-alsa-card.c>
	flags: HARDWARE HW_MUTE_CTRL HW_VOLUME_CTRL DECIBEL_VOLUME LATENCY DYNAMIC_LATENCY
	state: SUSPENDED
	suspend cause: IDLE
	priority: 9039
	volume: front-left: 0 /   0% / -inf dB,   front-right: 0 /   0% / -inf dB
	        balance 0,00
	base volume: 13076 /  20% / -42,00 dB
	volume steps: 65537
	muted: yes
	current latency: 0,00 ms
	max rewind: 0 KiB
	sample spec: s16le 2ch 44100Hz
	channel map: front-left,front-right
	             Stereo
	used by: 0
	linked by: 0
	configured latency: 0,00 ms; range is 0,50 .. 2000,00 ms
	card: 1 <alsa_card.pci-0000_00_1b.0>
	module: 8
	properties:
		alsa.resolution_bits = "16"
		device.api = "alsa"
		device.class = "sound"
		alsa.class = "generic"
		alsa.subclass = "generic-mix"
		alsa.name = "ALC3232 Analog"
		alsa.id = "ALC3232 Analog"
		alsa.subdevice = "0"
		alsa.subdevice_name = "subdevice #0"
		alsa.device = "0"
		alsa.card = "1"
		alsa.card_name = "HDA Intel PCH"
		alsa.long_card_name = "HDA Intel PCH at 0xf0634000 irq 42"
		alsa.driver_name = "snd_hda_intel"
		device.bus_path = "pci-0000:00:1b.0"
		sysfs.path = "/devices/pci0000:00/0000:00:1b.0/sound/card1"
		device.bus = "pci"
		device.vendor.id = "8086"
		device.vendor.name = "Intel Corporation"
		device.product.id = "8c20"
		device.product.name = "8 Series/C220 Series Chipset High Definition Audio Controller (ThinkPad T440p)"
		device.form_factor = "internal"
		device.string = "front:1"
		device.buffering.buffer_size = "352800"
		device.buffering.fragment_size = "176400"
		device.access_mode = "mmap+timer"
		device.profile.name = "analog-stereo"
		device.profile.description = "Analog Stereo"
		device.description = "Built-in Audio Analog Stereo"
		module-udev-detect.discovered = "1"
		device.icon_name = "audio-card-pci"
	ports:
		analog-input-internal-mic: Internal Microphone (priority 8900, latency offset 0 usec, available: unknown)
			properties:
				device.icon_name = "audio-input-microphone"
		analog-input-dock-mic: Dock Microphone (priority 7800, latency offset 0 usec, available: no)
			properties:
				device.icon_name = "audio-input-microphone"
		analog-input-mic: Microphone (priority 8700, latency offset 0 usec, available: no)
			properties:
				device.icon_name = "audio-input-microphone"
	active port: <analog-input-internal-mic>
    index: 2
	name: <alsa_output.usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00.mono-fallback.monitor>
	driver: <module-alsa-card.c>
	flags: DECIBEL_VOLUME LATENCY DYNAMIC_LATENCY
	state: SUSPENDED
	suspend cause: IDLE
	priority: 1040
	volume: mono: 65536 / 100% / 0,00 dB
	        balance 0,00
	base volume: 65536 / 100% / 0,00 dB
	volume steps: 65537
	muted: no
	current latency: 0,00 ms
	max rewind: 0 KiB
	sample spec: s16le 1ch 44100Hz
	channel map: mono
	             Mono
	used by: 0
	linked by: 0
	configured latency: 0,00 ms; range is 0,50 .. 2000,00 ms
	monitor_of: 1
	card: 2 <alsa_card.usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00>
	module: 25
	properties:
		device.description = "Monitor of Jabra EVOLVE 20 Mono"
		device.class = "monitor"
		alsa.card = "2"
		alsa.card_name = "Jabra EVOLVE 20"
		alsa.long_card_name = "GN Netcom A/S Jabra EVOLVE 20 at usb-0000:00:14.0-2, full speed"
		alsa.driver_name = "snd_usb_audio"
		device.bus_path = "pci-0000:00:14.0-usb-0:2:1.0"
		sysfs.path = "/devices/pci0000:00/0000:00:14.0/usb3/3-2/3-2:1.0/sound/card2"
		udev.id = "usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00"
		device.bus = "usb"
		device.vendor.id = "0b0e"
		device.vendor.name = "GN Netcom"
		device.product.id = "0303"
		device.product.name = "Jabra EVOLVE 20"
		device.serial = "GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A"
		device.string = "2"
		module-udev-detect.discovered = "1"
		device.icon_name = "audio-card-usb"
  * index: 3
	name: <alsa_input.usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00.mono-fallback>
	driver: <module-alsa-card.c>
	flags: HARDWARE HW_MUTE_CTRL HW_VOLUME_CTRL DECIBEL_VOLUME LATENCY DYNAMIC_LATENCY
	state: SUSPENDED
	suspend cause: IDLE
	priority: 9040
	volume: mono: 52057 /  79% / -6,00 dB
	        balance 0,00
	base volume: 52057 /  79% / -6,00 dB
	volume steps: 65537
	muted: no
	current latency: 0,00 ms
	max rewind: 0 KiB
	sample spec: s16le 1ch 44100Hz
	channel map: mono
	             Mono
	used by: 0
	linked by: 0
	configured latency: 0,00 ms; range is 0,50 .. 2000,00 ms
	card: 2 <alsa_card.usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00>
	module: 25
	properties:
		alsa.resolution_bits = "16"
		device.api = "alsa"
		device.class = "sound"
		alsa.class = "generic"
		alsa.subclass = "generic-mix"
		alsa.name = "USB Audio"
		alsa.id = "USB Audio"
		alsa.subdevice = "0"
		alsa.subdevice_name = "subdevice #0"
		alsa.device = "0"
		alsa.card = "2"
		alsa.card_name = "Jabra EVOLVE 20"
		alsa.long_card_name = "GN Netcom A/S Jabra EVOLVE 20 at usb-0000:00:14.0-2, full speed"
		alsa.driver_name = "snd_usb_audio"
		device.bus_path = "pci-0000:00:14.0-usb-0:2:1.0"
		sysfs.path = "/devices/pci0000:00/0000:00:14.0/usb3/3-2/3-2:1.0/sound/card2"
		udev.id = "usb-GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A-00"
		device.bus = "usb"
		device.vendor.id = "0b0e"
		device.vendor.name = "GN Netcom"
		device.product.id = "0303"
		device.product.name = "Jabra EVOLVE 20"
		device.serial = "GN_Netcom_A_S_Jabra_EVOLVE_20_001022C6A9BE0A"
		device.string = "hw:2"
		device.buffering.buffer_size = "176400"
		device.buffering.fragment_size = "88200"
		device.access_mode = "mmap+timer"
		device.profile.name = "mono-fallback"
		device.profile.description = "Mono"
		device.description = "Jabra EVOLVE 20 Mono"
		module-udev-detect.discovered = "1"
		device.icon_name = "audio-card-usb"
	ports:
		analog-input-mic: Microphone (priority 8700, latency offset 0 usec, available: unknown)
			properties:
				device.icon_name = "audio-input-microphone"
	active port: <analog-input-mic>
	
	
	
	
	
Audiodatei bei Abspielen von listenmsg unverständlich --> evtl doch .wav-Header anfügen ?!  vorher abgleich pacmd list-sources mit gast-pc
		
bei heller, verzerrter, schneller stimme die bitrate anpassen. Für Ausgabe über Lautsprecher (pci) folgende Parameter wählen:
Bitrate: val = 22100;
frame/fragment size: frames = 44400; 
size (= buffer-größe): size = frames * 4; (2bytes/sample * 2 channels)
---> Das AUdiowiedergabeprogramm klappt. Das Rauschen der Audiodatei kommt eindeutig durch das Empfangsprogramm rfcomm_server rein. Weil eine gut zu hörende Datei auf gast-pc als auch auf cloud-lab klar abläuft.

beides die selben Files, bloß der übertragungsweg unterscheidet sich.
cloud@Cloud-Lab:~$ diff correct_jabra_cap.wav corrupt_jabra_cap.wav 
Binary files correct_jabra_cap.wav and corrupt_jabra_cap.wav differ

---_> der Fehler beim corrupt jabra ist, dass es anfangs genau um zwei nibbel (4-bits9 vershcoben ist, und darum in Zeile 66 beim ersten Nicht-0-Zeichen der Fehler beginnt). Aber später tauchen auch nochmal bitfehler auf, manuell bitschieben macht wenig sinn.
Ersztmal ein kurzes File über bluetooth rfcomm_server schicken (bytegröße 1009) und prüfen, ob die übertragung richtig klappt !

erste Erkenntnisse: das Senden schlägt leider komplett fehl.

Bytes_read ist falsch, weil es ja immer bytes_red = size(buf) anzeigt, also auch sehr viele leere bytes.

Idee: als Header eine Startseuqnz einbauen, evtl 4x "1234 5678 9999 AAAA"
---> wichtig, ich muss bytes einzeln in file schreiben!!!!  Lehre aus header_buffer

für bluetooth-fileserver:	sudo obexpushd -B bluetooth0 -d

App-Wiedergabefehler: ./merged_QML_input_test: error while loading shared libraries: libQt5Qml.so.5: cannot open shared object file: No such file or directory
	---> Lösung: sudo cp /home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/lib/libQt5Qml.so.5  /usr/lib/x86_64-linux-gnu/


neuer Fehler:	./merged_QML_input_test: /lib/x86_64-linux-gnu/libQt5Core.so.5: version `Qt_5.14' not found (required by /lib/x86_64-linux-gnu/libQt5Qml.so.5)

loud@Cloud-Lab:~/agl/bluetooth_selfattempt/bt_tutorial$ qmake --version
QMake version 3.1
Using Qt version 5.12.8 in /usr/lib/x86_64-linux-gnu
--> Lösung: cloud@Cloud-Lab:~$ export LD_LIBRARY_PATH=/home/cloud/agl/sdk/sysroots/corei7-64-agl-linux/usr/lib
	VORSICHT!!! danach wieder löschen mit "export LD_LIBRARY_PATH= " um andere Programme wie gedit aufrufen zu können die in usr/lib sind

neuer Fehler: qt.qpa.plugin: Could not find the Qt platform plugin "xcb" in ""
Failed to create wl_display (No such file or directory)
qt.qpa.wayland: Failed to initialize EGL display 3001
qt.qpa.plugin: Could not load the Qt platform plugin "wayland-egl" in "" even though it was found.
This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.

Available platform plugins are: minimal, offscreen, vnc, wayland-egl, wayland.
--->
the lib "libQt5WaylandClient.so.5" should be included in the deployed package. which used by the plugin.
--> "libgles2-mesa libgles2-mesa-dev" ?

Tonaufnahme mit "hw2:0" in sendvoicemsg.c passt, und senden auch :)
but:
file einlesen nicht so leicht, da binary-file und somit benötige ich extra Befehle.

wenn ich apt-get install ausführe folgender Fehler:
dpkg: error processing package python3 (--configure): --> nach apt-get reinstall python3  klappt das wieder

neuer Fehler: qt.qpa.plugin: Could not load the Qt platform plugin "wayland-egl" in "" even though it was found.
ein bisschen hilft:	export QT_QPA_PLATFORM=wayland

neu:
Failed to create wl_display (No such file or directory)
On Wayland, Failed to create display (No such file or directory) means that a Wayland client couldn't connect to the compositor/display server.

f ./myapp -platform wayland shows the app, then you have a compositor running. If you can't get it to work with qtcreator, it might be that it's running with the wrong options or perhaps XDG_RUNTIME_DIR is set to something else than on the device? If you do ls $XDG_RUNTIME_DIR you should be able to see the socket, wayland-0, for the compositor.

bei mir erscheint nicht wayland-0
(bei gast-pc erscheint das unter /run/user/120/wayland-0 )

der PFad von DG_RUNTIME_DIR ist auf cloudPC run/user/1000/
wenn ich manuell wayland-0 erstelle mit "touch run/user/1000/wayland-0" kommt neue Fehlermeldung:		Failed to create wl_display (Connection refused)
https://wiki.archlinux.org/title/Running_GUI_applications_as_root#Wayland

einlesen waylandzu wayland:
The Wayland server shall be able on the default wayland-0 socket. Clients
may connect to this socket and use the standard Wayland protocol with no
additional requirements.
----> wayland-server selbst starten ?!

< 18. Support for standardised Wayland extensions
1. wl_output and xdg_output_v1 shall be present to describe
display devices
2. xdg_wm_base shall be present for window management; clients
should not use the deprecated ivi-application interface
3. wl_subcompositor shall be present to support combination of
multiple surfaces into a single presentable entity
4. zxdg_importer_v1 , zxdg_exporter_v1 ,
agl_foreign_subcompositor_v1 , shall be present to support
combination of multiple surfaces from different client processes
5. wl_shm shall be supported for software-rendered clients, with at
least WL_SHM_FORMAT_XRGB8888 and WL_SHM_FORMAT_ARGB8888
6. zwp_linux_dmabuf_v1 should be present to support zero-copy
presentation of hardware-generated content from clients
(media/GPU)
7. wp_presentation shall be present to support presentation timing
feedback to clients 

Support for EGL / OpenGL ES clients using standard Wayland EGL
platform
1. Clients using libwayland-egl and EGL_KHR_platform_wayland
shall be able to display content.

Wayland is a display server protocol.>

There's no such thing as "start Wayland", as there's no such program as "Wayland". Wayland is a protocol, and there are multiple Wayland-compatible compositors out there, Plasma's KWin being one of them.

On "Wayland, Failed to created display" means that a Wayland client couldn't connect to the compositor(=display server).
So you should verify that your compositor is running. Which one are you using? The environment variable, XDG_RUNTIME_DIR also needs to be set both when the compositor is started and when your client is started.
Note that if you are running a Qt-based compositor, then the compositor should probably still be run with the eglfs backend

( sudo apt install qtwayland5,


next:   Fehler ganz am Ende: aborted core dump. Evtl nochmal cross-kompilieren evtl läuft es dann denoch ?!

für debuggen:  export QT_DEBUG_PLUGINS=1
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt/bt_tutorial$ ./merged_QML_input_test -platform wayland-egl

( bluetooth Fehler:
Listening on bluetooth/[00:00:00:00:00:00]:9
SDP session setup failed, disabling bluetooth
net_init() failed
---> "sudo service bluetooth stop"   And restart it "sudo bluetoothd --compat &"  
and/or:	For me the hciconfig was down, so i started it as:  hciconfig hci0 up
zum Prüfen:	sudo systemctl status bluetooth


app läuft wenn ich folgendes eingebe:
cloud@Cloud-Lab:~/Downloads$ sudo modprobe uvesafb 
cloud@Cloud-Lab:~/agl/bluetooth_selfattempt/bt_tutorial$ ./merged_QML_input_test 

Folgende Fehler erscheinen:
QQmlApplicationEngine failed to load component
qrc:/startingpage.qml:1 module "QtQuick" is not installed
qrc:/startingpage.qml:2 module "QtQuick.Controls" is not installed
qrc:/startingpage.qml:1 module "QtQuick" is not installed
qrc:/startingpage.qml:2 module "QtQuick.Controls" is not installed

---> sudo apt -y install qml-module-qtquick-controls  oder sudo apt install qml-module-qtquick-controls2
-> jetzt läuft die App :-) 

PS: "Could not convert argument 0 at"
	 "onClicked@qrc:/HexKeyboard.qml:139"
"Passing incompatible arguments to C++ functions from JavaScript is dangerous and deprecated."		dieser Fehler erscheint nicht auf gast-PC, nur hier.


App crasht bei Aufnahme von Voice, evtl wegen thread ?! --> Debuggen

Bluetooth-Probleme gelöst mit:
sudo service bluetooth stop
sudo bluetoothd --compat &
sudo hciconfig hci0 up
sudo obexpushd -B bluetooth0 -d &

Beim Senden von cloudlab an gast-PC kommt folgender fehler in btmon:
 data element size too short
        36 03 e9                                         6..             

cloud@Cloud-Lab:~/agl/bluetooth_selfattempt/bt_tutorial$ sudo hcitool cc A8:6D:AA:B0:2D:49; sudo hcitool lq A8:6D:AA:B0:2D:49

cloud@Cloud-Lab:~/agl$ sudo btmgmt conn-info A8:6D:AA:B0:2D:49
[sudo] password for cloud: 
Connection Information for A8:6D:AA:B0:2D:49 (BR/EDR)
	RSSI 0	TX power 0	maximum TX power 10


Frage: in AGL (QEMU) bluetooth möglich? wie testen?
--> debug-Hilfen:

hciconfig -a
sudo hcitool dev
sudo hcitool scan

für qemu einfügen bei Start: ‘-bt hci,host[:id]’
		zum Beispiel: user~: /opt/qemu/bin/qemu-system-i386 -enable-kvm -hda disk.vmdk -m 512 -usb -bt hci,host:hci0 -cdrom /dev/sr0 -boot d

bluetooth-lib in qemu einfügen:	user@host:~$ ldd /opt/qemu/bin/qemu-system-i386 | grep blu
							libbluetooth.so.3 => /usr/lib/libbluetooth.so.3 (0xf6c16000)
	
---> folgender Befehl anscheinend ohne environment sourcen:						
							
(sleep 5 && vinagre --vnc-scale localhost ) > /tmp/vinagre.log 2>&1 & qemu-system-x86_64 -device virtio-net-pci,netdev=net0,mac=52:54:00:12:35:02 -netdev user,id=net0,hostfwd=tcp::2222-:22 -drive file=agl-demo-platform-crosssdk-qemux86-64.ext4,if=virtio,format=raw -show-cursor -usb -device usb-tablet -device virtio-rng-pci -snapshot -vga virtio -vnc :0 -soundhw hda -machine q35 -cpu kvm64 -cpu qemu64,+ssse3,+sse4.1,+sse4.2,+popcnt -enable-kvm -m 2048 -cpu host -serial mon:vc -serial mon:stdio -serial null -usb -device usb-host,hostbus=3,hostaddr=5 -kernel bzImage -append 'root=/dev/vda rw console=tty0 mem=2048M ip=dhcp oprofile.timer=1 console=ttyS0,115200n8 verbose fstab=no'

fehler BLuetooth wurde aus qemu entfernt: Bluetooth was deprecated in 2018 for QEMU v3.1 (hence that warning message), and was subsequently removed entirely for QEMU v5.0, released in 2020!
meine qemu-Version:
cloud@Cloud-Lab:~/agl/build/new_img$ /usr/bin/qemu-system-x86_64 --version
QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.24)
Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers

		
cloudlab lsusb:
Bus 003 Device 005: ID 8087:07dc Intel Corp. 
Bus 001 Device 002: ID 8087:8008 Intel Corp. 
Bus 002 Device 002: ID 8087:8000 Intel Corp. 	

cloud@Cloud-Lab:~/agl/build/new_img$ hciconfig -a
hci0:	Type: Primary  Bus: USB
	BD Address: CC:3D:82:39:9B:61  ACL MTU: 1021:5  SCO MTU: 96:6
	UP RUNNING 
	RX bytes:1991 acl:0 sco:0 events:197 errors:0
	TX bytes:26675 acl:0 sco:0 commands:195 errors:0
	Features: 0xff 0xfe 0x0f 0xfe 0xdb 0xff 0x7b 0x87
	Packet type: DM1 DM3 DM5 DH1 DH3 DH5 HV1 HV2 HV3 
	Link policy: RSWITCH HOLD SNIFF 
	Link mode: SLAVE ACCEPT 
	Name: 'Cloud-Lab'
	Class: 0x0c010c
	Service Classes: Rendering, Capturing
	Device Class: Computer, Laptop
	HCI Version: 4.0 (0x6)  Revision: 0xe00
	LMP Version: 4.0 (0x6)  Subversion: 0xe00
	Manufacturer: Intel Corp. (2)


lsusb -t --->     |__ Port 11: Dev 5, If 0, Class=Wireless, Driver=btusb, 12M
    		   |__ Port 11: Dev 5, If 1, Class=Wireless, Driver=btusb, 12M

Bus 003 Device 005: ID 8087:07dc Intel Corp. 		(auch zu finden unter /dev/bus/usb/003/005)

vorlage: -usb -usbdevice host:zzzz:zzzz -bt hci,host ---> -usb -usbdevice host:8087:07dc -bt hci,host  ( = veraltet)
	< -device usb-host,hostbus=2,hostaddr=3 to add the host's USB device at Bus 2, Device 3.>  --> 	-device usb-host,hostbus=3,hostaddr=5
	
libusb: error [_get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/003/005: Permission denied
---> lösung: sudo chown cloud /dev/bus/usb/003/005 ?

hat geKlappt!
qemux86-64:~# bluetoothctl show
Controller CC:3D:82:39:9B:61 (public)
	Name: qemux86-64
	Alias: qemux86-64
	Class: 0x00240000
	Powered: yes
	Discoverable: no
	DiscoverableTimeout: 0x000000b4
	Pairable: yes
	UUID: A/V Remote Control        (0000110e-0000-1000-8000-00805f9b34fb)
	UUID: PnP Information           (00001200-0000-1000-8000-00805f9b34fb)
	UUID: Audio Sink                (0000110b-0000-1000-8000-00805f9b34fb)
	UUID: A/V Remote Control Target (0000110c-0000-1000-8000-00805f9b34fb)
	UUID: Generic Access Profile    (00001800-0000-1000-8000-00805f9b34fb)
	UUID: Generic Attribute Profile (00001801-0000-1000-8000-00805f9b34fb)
	UUID: Device Information        (0000180a-0000-1000-8000-00805f9b34fb)
	UUID: Handsfree                 (0000111e-0000-1000-8000-00805f9b34fb)
	Modalias: usb:v1D6Bp0246d0537
	Discovering: no
	Roles: central
	Roles: peripheral
Advertising Features:
	ActiveInstances: 0x00 (0)
	SupportedInstances: 0x05 (5)
	SupportedIncludes: tx-power
	SupportedIncludes: appearance
	SupportedIncludes: local-name
qemux86-64:~# 

beim Ausführen von Binär-Dateien ist Fehler aufgetreten: qemux86-64:/home# sudo sh l2cap_server 
l2cap_server: l2cap_server: cannot execute binary file

Idee das Makefile anpassen für Architektur auf QEMU! --> anscheinend hat qemu gleihce architektur wie laptop
qemux86-64:/home# uname -a
Linux qemux86-64 5.4.69-yocto-standard #1 SMP PREEMPT Mon Jun 29 03:06:40 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux

---> vermutlich erst in sdk-Ordner wechseln, dann source .... und dann klappt buiden evtl?
zum kompilieren:
source agl/sdk/env..
export LIBRARAY_PATH=/home/gast/local/lib/pkg_config:/home/gast/local/lib:$LIBRARY_PATH
ldconfig
gcc -Wall -g3 source.c -o source $(pkg-config --cflags --libs afb-daemon libafbwsc) -I/home/gast/....../corei7-64-agl-linux/usr/include

Ausführen:
export LD_LIBRARY_PATH=/home/gast/local/lib:$LD_LIBRARY_PATH


qemux86-64:/home# lscpu
Architecture:                    x86_64
CPU op-mode(s):                  32-bit, 64-bit
Byte Order:                      Little Endian
Address sizes:                   40 bits physical, 48 bits virtual
CPU(s):                          1
On-line CPU(s) list:             0
Thread(s) per core:              1
Core(s) per socket:              1
Socket(s):                       1
Vendor ID:                       GenuineIntel
CPU family:                      6
Model:                           60
Model name:                      Intel(R) Core(TM) i7-4600M CPU @ 2.90GHz
Stepping:                        3
CPU MHz:                         2893.300
BogoMIPS:                        5786.60
Virtualization:                  VT-x
Hypervisor vendor:               KVM
Virtualization type:             full


binary läuft wohl, ich muss es nur in ein wgt-App verpacken?!
qemux86-64:/var/local/lib/afm/applications/hvac/bin# ls -ll /usr/sbin/qemu_helloworld 
-rwxr-xr-x. 1 root root 41744 Jan 20 13:42 /usr/sbin/qemu_helloworld
qemux86-64:/var/local/lib/afm/applications/hvac/bin# ls -ll
total 116
-rwxr-xr-x. 1 root root 116936 Jan 20 11:48 hvac

dann: afm-util start motalk

---> next: l2cap_server in ein widget verpacken und testen!  (anshceinend liegt es nicht am build selbst) 

widget installieren:  afm-util install /tmp/agl-service-helloworld.wgt

zum App-Build folgende Ordner-Struktur beachten:
loud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package
config.xml  htdocs  lib
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package/htdocs/
AFB-websock.js  assets  CMakeLists.txt  index.html  iotbzh-Binding.css  iotbzh-Binding.js
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ ls package/lib/
helloworld_service.so
cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ 

dann ausführen: cloud@Cloud-Lab:~/agl/agl-srv-helwor/selftest_app$ wgtpkg-pack -f -o self_hellow.wgt package

verpacken mit:
source sdk/environment...
wgtpkg-pack -f -o l2cap_server.wgt(=Ziel) package(=beinhaltender Ordner)

kopieren mit "scp -P 2222 l2cap_server.wgt  root@localhost:/home"
qemux86-64:~# afm-util install motalk_v2.wgt 
afm-util start motalk

debuggen:
journalctl -xu  afm-appli-dashboard--0.1--main@.service
qemux86-64:/var/local/lib/afm/applications/l2cap_server/bin# systemctl status afm-appli-l2cap_server--0.1--main@0.service

systemctl start afm-appli-l2cap_server--0.1--main@0.service ?

unter ls -ll /usr/local/lib/systemd/system/  Auflistung aller services/bindings. Für l2cap_server fehlt zB afm-api-HVAC@.service, afm-api-HVAC@.socket und afm-service-agl-service-hvac--1.0--main@.service

qemux86-64:/var/local/lib/afm/applications/l2cap_server/bin# ./l2cap_server 
-sh: ./l2cap_server: No such file or directory

qemux86-64:/var/local/lib/afm/applications/l2cap_server/bin# file l2cap_server 
l2cap_server: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=5ad99508f6180175e80098a1c4385fb849d6c9e5, for GNU/Linux 3.2.0, with debug_info, not stripped

--------> /lib64/ld-linux-x86-64.so.2  war nicht vorhanden, bloß /lib/ld-linux-x86-64.so.2, also selbst Ordner lib64 erstellt und File kopiert, jetzt klappt es. 
 
--> Unterschied besteht im INterpreter/linker und stripped - not stripped ?!.
Ein Interpreter verarbeitet den Quellcode eines Projekts zur Laufzeit. Dazu geht der Interpreter Zeile für Zeile vor: Eine Anweisung wird eingelesen, analysiert und sofort ausgeführt. Dann geht es mit der nächsten Anweisung weiter, bis schließlich das Ende des Programms erreicht ist; oder bis ein Fehler auftritt. Ein Interpreter erzeugt keine Datei, die man mehrmals ausführen könnte. Er fertigt auch keine Übersetzung des Quellcodes in Maschinensprache um, sondern fungiert als eine Zwischenschicht zwischen Programmiersprache und Maschine.

qemux86-64:/var/local/lib/afm/applications/l2cap_server/bin# readelf --symbols l2cap_server 

Symbol table '.dynsym' contains 26 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __errno_location@GLIBC_2.2.5 (2)
     2: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab

---> alle Values = 0x000000000000 

when "file doesn't exist" is written on terminal, just means a key component of the runtime environment necessary to run the program is missing. the output is a bit confusing.
Notice interpreter /lib64/ld-lsb-x86-64.so.3; if this file does not exist, you need to install it. 


l2cap_client connecten mit gast-pc aus qemu heraus klappt bereits, beim zweiten Mal auch mit Übetragen der daten.
Aber l2cap_server klappt nicht, da sprint auch btmon gar nicht an, zeichnet keinerlei Sachen auf( das tut es aber bei gast-pc auch nicht)

(ich kann bluetooth-controller entwedder in cloudlab oder qemu an haben, beides gleichzeitig geht nciht.)

wenn ich l2cap_client ausführe in qemu:
qemu-system-x86_64: libusb_release_interface: -4 [NO_DEVICE]
libusb: error [_open_sysfs_attr] open /sys/bus/usb/devices/3-11/bConfigurationValue failed ret=-1 errno=2
libusb: error [udev_hotplug_event] ignoring udev action change
libusb: error [udev_hotplug_event] ignoring udev action bind


Jan 23 17:23:20 qemux86-64 kernel: usb 2-2: USB disconnect, device number 2
Jan 23 17:23:20 qemux86-64 afbd-agl-service-bluetooth-pbap[863]:  NOTICE: [API bluetooth-pbap] PBAP device disconnected: dev_A8_6D_AA_B0_2D_49 [/usr/src/debug/agl-ser>
Jan 23 17:23:20 qemux86-64 bluetoothd[311]: Endpoint unregistered: sender=:1.6 path=/org/bluez/hci0/A2DP/SBC/Sink/1
Jan 23 17:23:20 qemux86-64 bluetoothd[311]: Endpoint unregistered: sender=:1.6 path=/org/bluez/hci0/A2DP/SBC/Sink/2
Jan 23 17:23:20 qemux86-64 systemd[1]: Starting Load/Save RF Kill Switch Status...
Jan 23 17:23:20 qemux86-64 systemd[1024]: Stopped target Bluetooth.
Jan 23 17:23:20 qemux86-64 systemd[782]: Stopped target Bluetooth.
Jan 23 17:23:20 qemux86-64 systemd[1]: Started Load/Save RF Kill Switch Status.
Jan 23 17:23:25 qemux86-64 systemd[1]: systemd-rfkill.service: Succeeded.


Aber wenn ich l2cap_server ausführe: ---> keinerlei Output in journalctl. Der Output geht nichtmal bis "accepted connection from..."

( bluetooth port ändert sich bei start von agl:  sudo chown cloud:cloud /dev/bus/usb/003/007 )

--> l2cap_server bleibt bei folgendem Befehl hängen:   client = accept(s, (struct sockaddr *)&rem_addr, &opt);

das passiert bei l2cap_client nicht, weil diese Programm kein accept hat!

evtl aus stackoverflow:
The problem was that I was trying to connect to the socket from server part by using host address and port, but to access the Qemu data I had to connect to the socket using file descriptor /dev/vport3p1.

#define DEV_PATH "/dev/vport3p1"
dev_fd = open(DEV_PATH, O_RDWR)

---> https://developer.nordicsemi.com/nRF_Connect_SDK/doc/1.9.99-dev1/zephyr/guides/bluetooth/bluetooth-dev.html

herausfinden ob linux-systeme offene sockets zeigen und vergleichen mit cloudlab-pc. Nicht allzulange aufhalten, falls es nciht klappt, sondern allgemein app mal testen.

list open file descriptors:
ls -l /proc/$$/fd
lsof -a -p $$     ---> beides hilft mir nicht weiter, zeigt keine offenen sockets bei accept an.

ps -aux | grep l2cap   --> zegit immerhin laufendes binary und PID an.
----> Lösung unter cat /proc/net/l2cap   (einmal mit open l2cap_server und einmal ohne gibt es unterschiedlichen Output)
	wenn l2cap_server als normaler user läuft (bei root User=0): cloud@Cloud-Lab:~/agl$ cat /proc/net/l2cap 
								sk               RefCnt Rmem   Wmem   User   Inode  Parent
								0000000000000000 2      0      0      1000   150223 0     
								
			
'usb-host' is not a valid device model name ? --> terminal nicht sourcen bevor qemu gestartet wird.

gdb in qemu:
Breakpoint 2, main (argc=1, argv=0x7fffffffec28) at l2cap_server.c:82
82	    client = accept(s, (struct sockaddr *)&rem_addr, &opt);
(gdb) p s
$1 = 3
(gdb) p rem_addr
$2 = {l2_family = 0, l2_psm = 0, l2_bdaddr = {b = "\000\000\000\000\000"}, l2_cid = 0, l2_bdaddr_type = 0 '\000'}
(gdb) p loc_addr
$3 = {l2_family = 31, l2_psm = 4097, l2_bdaddr = {b = "\000\000\000\000\000"}, l2_cid = 0, l2_bdaddr_type = 0 '\000'}
(gdb) p opt
$4 = 14
(gdb) p opts
$5 = {omtu = 65000, imtu = 65000, flush_to = 65535, mode = 0 '\000'}
(gdb) p optlen
$6 = 8


l2cap_server in cloudlab:
Breakpoint 3, main (argc=1, argv=0x7fffffffde38) at l2cap_server.c:86
(gdb) p s
$1 = 3
(gdb) p rem_addr
$2 = {l2_family = 0, l2_psm = 0, l2_bdaddr = {b = "\000\000\000\000\000"}, l2_cid = 0, l2_bdaddr_type = 0 '\000'}
(gdb) p loc_addr
$3 = {l2_family = 31, l2_psm = 4097, l2_bdaddr = {b = "\000\000\000\000\000"}, l2_cid = 0, l2_bdaddr_type = 0 '\000'}
(gdb) p opt
$4 = 14
(gdb) p opts
$5 = {omtu = 65000, imtu = 65000, flush_to = 65535, mode = 0 '\000'}
(gdb) p optlen
$6 = 8
					
---> beide völig gleich. next debuggen mit accept.c   ---> /sysdeps/unix/sysv/linux/accept.c
-------------------------------------------------------------------------------------------
Sourcecode:
/* Copyright (C) 1991, 1995, 1996, 1997, 2002 Free Software Foundation, Inc.
   This file is part of the GNU C Library.

   The GNU C Library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public
   License as published by the Free Software Foundation; either
   version 2.1 of the License, or (at your option) any later version.

   The GNU C Library is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public
   License along with the GNU C Library; if not, write to the Free
   Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
   02111-1307 USA.  */

#include <errno.h>
#include <sys/socket.h>

/* Await a connection on socket FD.
   When a connection arrives, open a new socket to communicate with it,
   set *ADDR (which is *ADDR_LEN bytes long) to the address of the connecting
   peer and *ADDR_LEN to the address's actual length, and return the
   new socket's descriptor, or -1 for errors.  */
int
accept (fd, addr, addr_len)
     int fd;
     __SOCKADDR_ARG addr;
     socklen_t *addr_len;
{
  __set_errno (ENOSYS);
  return -1;
}
libc_hidden_def (accept)


stub_warning (accept)
#include <stub-tag.h>
--------------------------------------------------------------------------
